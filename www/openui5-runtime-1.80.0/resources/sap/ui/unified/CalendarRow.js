/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/core/Control','sap/ui/Device','sap/ui/core/LocaleData','sap/ui/unified/calendar/CalendarUtils','sap/ui/core/date/UniversalDate','./library','sap/ui/core/InvisibleText','sap/ui/core/format/DateFormat','sap/ui/core/ResizeHandler','sap/ui/core/Locale',"./CalendarRowRenderer","sap/ui/dom/containsOrEquals","sap/ui/thirdparty/jquery","sap/ui/unified/CalendarAppointment"],function(C,D,L,a,U,l,I,b,R,c,d,e,q,f){"use strict";var g=l.CalendarDayType;var h=l.CalendarAppointmentVisualization;var G=l.GroupAppointmentsMode;var m=l.CalendarIntervalType;var T=4;var n=C.extend("sap.ui.unified.CalendarRow",{metadata:{library:"sap.ui.unified",properties:{startDate:{type:"object",group:"Data"},intervals:{type:"int",group:"Appearance",defaultValue:12},intervalType:{type:"sap.ui.unified.CalendarIntervalType",group:"Appearance",defaultValue:m.Hour},showSubIntervals:{type:"boolean",group:"Appearance",defaultValue:false},showIntervalHeaders:{type:"boolean",group:"Appearance",defaultValue:true},showEmptyIntervalHeaders:{type:"boolean",group:"Appearance",defaultValue:true},nonWorkingDays:{type:"int[]",group:"Misc",defaultValue:null},nonWorkingHours:{type:"int[]",group:"Misc",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},checkResize:{type:"boolean",group:"Behavior",defaultValue:true},updateCurrentTime:{type:"boolean",group:"Behavior",defaultValue:true},groupAppointmentsMode:{type:"sap.ui.unified.GroupAppointmentsMode",group:"Appearance",defaultValue:G.Collapsed},appointmentsReducedHeight:{type:"boolean",group:"Appearance",defaultValue:false},appointmentsVisualization:{type:"sap.ui.unified.CalendarAppointmentVisualization",group:"Appearance",defaultValue:h.Standard}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment"},intervalHeaders:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"intervalHeader"},groupAppointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"groupAppointment",visibility:"hidden"}},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},legend:{type:"sap.ui.unified.CalendarLegend",multiple:false}},events:{select:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"},multiSelect:{type:"boolean"},domRefId:{type:"string"}}},startDateChange:{},leaveRow:{parameters:{type:{type:"string"}}},intervalSelect:{parameters:{startDate:{type:"object"},endDate:{type:"object"},subInterval:{type:"boolean"}}}}}});n.prototype.init=function(){this._bRTL=sap.ui.getCore().getConfiguration().getRTL();this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.unified");this._oFormatAria=b.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' "+p.call(this).getTimePattern("medium")});this._iHoursMinDelta=1;this._iDaysMinDelta=30;this._iMonthsMinDelta=720;this._aVisibleAppointments=[];this._aVisibleIntervalHeaders=[];this.setStartDate(new Date());this._resizeProxy=q.proxy(this.handleResize,this);this.aSelectedAppointments=[];this._fnCustomSortedAppointments=undefined;};n.prototype.exit=function(){if(this._sResizeListener){R.deregister(this._sResizeListener);this._sResizeListener=undefined;}if(this._sUpdateCurrentTime){clearTimeout(this._sUpdateCurrentTime);this._sUpdateCurrentTime=undefined;}this._fnCustomSortedAppointments=undefined;};n.prototype.onBeforeRendering=function(){r.call(this);u.call(this);y.call(this);if(this._sUpdateCurrentTime){clearTimeout(this._sUpdateCurrentTime);this._sUpdateCurrentTime=undefined;}};n.prototype.onAfterRendering=function(){z.call(this);this.updateCurrentTimeVisualization();if(this.getCheckResize()&&!this._sResizeListener){this._sResizeListener=R.register(this,this._resizeProxy);}};n.prototype.onThemeChanged=function(j){if(this.getDomRef()){for(var i=0;i<this._aVisibleAppointments.length;i++){var k=this._aVisibleAppointments[i];k.level=-1;}this.handleResize(j);}};n.prototype.invalidate=function(O){if(O&&O instanceof f){var j=false;for(var i=0;i<this._aVisibleAppointments.length;i++){if(this._aVisibleAppointments[i].appointment==O){j=true;break;}}if(j){this._aVisibleAppointments=[];}this._updateSelectedAppointmentsArray(O);}C.prototype.invalidate.apply(this,arguments);};n.prototype.setStartDate=function(S){if(!S){S=new Date();}a._checkJSDateObject(S);var Y=S.getFullYear();a._checkYearInValidRange(Y);this.setProperty("startDate",S);return this;};n.prototype._getStartDate=function(){if(!this._oUTCStartDate){this._oUTCStartDate=a._createUniversalUTCDate(this.getStartDate(),undefined,true);}return this._oUTCStartDate;};n.prototype.setIntervalType=function(i){this.setProperty("intervalType",i);this._aVisibleAppointments=[];return this;};n.prototype.setGroupAppointmentsMode=function(i){this.setProperty("groupAppointmentsMode",i);this._aVisibleAppointments=[];return this;};n.prototype.setAppointmentsReducedHeight=function(i){this.setProperty("appointmentsReducedHeight",i);this._aVisibleAppointments=[];return this;};n.prototype._getAppointmentReducedHeight=function(i){var j=false;if(!D.system.phone&&this.getAppointmentsReducedHeight()&&!i.getText()){j=true;}return j;};n.prototype.onfocusin=function(j){if(q(j.target).hasClass("sapUiCalendarApp")){H.call(this,j.target.id);}else{var V=this._getVisibleAppointments();var k=false;var O;for(var i=0;i<V.length;i++){O=V[i].appointment;if(e(O.getDomRef(),j.target)){k=true;O.focus();break;}}if(!k){O=this.getFocusedAppointment();if(O){O.focus();}}}};n.prototype.applyFocusInfo=function(i){if(this._sFocusedAppointmentId){this.getFocusedAppointment().focus();}return this;};n.prototype.onsapleft=function(i){if(q(i.target).hasClass("sapUiCalendarApp")){J.call(this,this._bRTL,1);}i.preventDefault();i.stopPropagation();};n.prototype.onsapright=function(i){if(q(i.target).hasClass("sapUiCalendarApp")){J.call(this,!this._bRTL,1);}i.preventDefault();i.stopPropagation();};n.prototype.onsapup=function(i){this.fireLeaveRow({type:i.type});};n.prototype.onsapdown=function(i){this.fireLeaveRow({type:i.type});};n.prototype.onsaphome=function(i){K.call(this,i);i.preventDefault();i.stopPropagation();};n.prototype.onsapend=function(i){K.call(this,i);i.preventDefault();i.stopPropagation();};n.prototype.onsapselect=function(j){var V=this._getVisibleAppointments();for(var i=0;i<V.length;i++){var k=V[i].appointment;if(e(k.getDomRef(),j.target)){A.call(this,k,!(j.ctrlKey||j.metaKey));break;}}j.stopPropagation();j.preventDefault();};n.prototype.ontap=function(i){var j=this.$("Apps").children(".sapUiCalendarRowAppsInt");var k=0;var O=false;for(k=0;k<j.length;k++){var P=j[k];if(!this._isOneMonthsRowOnSmallSizes()&&e(P,i.target)){O=true;break;}}if(O){M.call(this,k,i.target);}else{this.onsapselect(i);}};n.prototype.onsapselectmodifiers=function(i){this.onsapselect(i);};n.prototype.handleResize=function(i){if(i&&i.size&&i.size.width<=0){return this;}var $=this.$("DummyApp");$.css("display","");z.call(this);return this;};n.prototype.updateCurrentTimeVisualization=function(){var $=this.$("Now");var i=a._createUniversalUTCDate(new Date(),undefined,true);var j=this.getIntervals();var k=this.getIntervalType();var S=this._getStartDate();var O=S.getTime();var P=this._oUTCEndDate;var Q=P.getTime();this._sUpdateCurrentTime=undefined;if(i.getTime()<=Q&&i.getTime()>=O){var V=w.call(this,k,j,S,P,O,i);var W=0;if(this._bRTL){$.css("right",V+"%");}else{$.css("left",V+"%");}$.css("display","");if(this.getUpdateCurrentTime()){switch(k){case m.Hour:W=60000;break;case m.Day:case m.Week:case m.OneMonth:W=1800000;break;default:W=-1;break;}if(W>0){this._sUpdateCurrentTime=setTimeout(this.updateCurrentTimeVisualization.bind(this),W);}}}else{$.css("display","none");}return this;};n.prototype.getFocusedAppointment=function(){var j=this._getAppointmentsSorted();var k=this.getAggregation("groupAppointments",[]);var O;var i=0;for(i=0;i<k.length;i++){if(k[i].getId()==this._sFocusedAppointmentId){O=k[i];break;}}if(!O){for(i=0;i<j.length;i++){if(j[i].getId()==this._sFocusedAppointmentId){O=j[i];break;}}}return O;};n.prototype.focusAppointment=function(i){if(!i||!(i instanceof f)){throw new Error("Appointment must be a CalendarAppointment; "+this);}var j=i.getId();if(this._sFocusedAppointmentId!=j){H.call(this,j);}else{i.focus();}return this;};n.prototype.focusNearestAppointment=function(j){a._checkJSDateObject(j);var k=this._getAppointmentsSorted();var O;var P;var Q;for(var i=0;i<k.length;i++){O=k[i];if(O.getStartDate()>j){if(i>0){P=k[i-1];}else{P=O;}break;}}if(O){if(P&&Math.abs(O.getStartDate()-j)>=Math.abs(P.getStartDate()-j)){Q=P;}else{Q=O;}this.focusAppointment(Q);}return this;};n.prototype._getVisibleAppointments=function(){return this._aVisibleAppointments;};n.prototype._getVisibleIntervalHeaders=function(){return this._aVisibleIntervalHeaders;};n.prototype._getNonWorkingDays=function(){var j=this.getNonWorkingDays();if(!j){var k=p.call(this);var W=k.getWeekendStart();var O=k.getWeekendEnd();j=[];for(var i=0;i<=6;i++){if((W<=O&&i>=W&&i<=O)||(W>O&&(i>=W||i<=O))){j.push(i);}}}else if(!Array.isArray(j)){j=[];}return j;};n.prototype._isOneMonthsRowOnSmallSizes=function(){return this.getIntervalType()===m.OneMonth&&this.getIntervals()===1;};n.prototype._getAppointmentsSorted=function(){var i=this.getAppointments(),j=N;i.sort(this._fnCustomSortedAppointments?this._fnCustomSortedAppointments:j);return i;};n.prototype._setCustomAppointmentsSorterCallback=function(S){this._fnCustomSortedAppointments=S;this.invalidate();};n.prototype._calculateAppoitnmentVisualCue=function(i){if(_(this,i)){return{appTimeUnitsDifRowStart:0,appTimeUnitsDifRowEnd:0};}var j=i.getStartDate(),k=i.getEndDate(),O=new U(j.getFullYear(),j.getMonth(),j.getDate(),j.getHours(),j.getMinutes()),P=new U(k.getFullYear(),k.getMonth(),k.getDate(),k.getHours(),k.getMinutes()),Q=this.getIntervalType(),S=this.getStartDate(),V=Q==="Hour"?new U(S.getFullYear(),S.getMonth(),S.getDate(),S.getHours()):new U(S.getFullYear(),S.getMonth(),S.getDate()),W=this.getIntervals(),X;switch(Q){case"Hour":X=new U(S.getFullYear(),S.getMonth(),S.getDate(),S.getHours()+W);break;case"Day":case"Week":case"One Month":X=new U(S.getFullYear(),S.getMonth(),S.getDate()+W);break;case"Month":X=new U(S.getFullYear(),S.getMonth()+W,S.getDate());break;default:break;}return{appTimeUnitsDifRowStart:V.getTime()-O.getTime(),appTimeUnitsDifRowEnd:P.getTime()-X.getTime()};};n.prototype._updateSelectedAppointmentsArray=function(i){if(i.getSelected()){if(this.aSelectedAppointments.indexOf(i.getId())===-1){this.aSelectedAppointments.push(i.getId());}}else{this.aSelectedAppointments=this.aSelectedAppointments.filter(function(j){return j!==i.getId();});}};function _(j,k){var O=j.getAggregation("groupAppointments",[]);var i;for(i=0;i<O.length;++i){if(k===O[i]){return true;}}return false;}function o(){if(!this._sLocale){this._sLocale=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale().toString();}return this._sLocale;}function p(){if(!this._oLocaleData){var i=o.call(this);var j=new c(i);this._oLocaleData=L.getInstance(j);}return this._oLocaleData;}function r(){var S=this.getStartDate();var i;var j=this.getIntervals();var k=this.getIntervalType();this._oUTCStartDate=s.call(this,S);switch(k){case m.Hour:i=new U(this._oUTCStartDate.getTime());i.setUTCHours(i.getUTCHours()+j);this._iMinDelta=this._iHoursMinDelta;break;case m.Day:case m.Week:case m.OneMonth:i=new U(this._oUTCStartDate.getTime());i.setUTCDate(i.getUTCDate()+j);this._iMinDelta=this._iDaysMinDelta;break;case m.Month:i=new U(this._oUTCStartDate.getTime());i.setUTCMonth(i.getUTCMonth()+j);this._iMinDelta=this._iMonthsMinDelta;break;default:throw new Error("Unknown IntervalType: "+k+"; "+this);}i.setUTCMilliseconds(-1);this._iRowSize=i.getTime()-this._oUTCStartDate.getTime();this._iIntervalSize=Math.floor(this._iRowSize/j);this._oUTCEndDate=i;}function s(i){var j=this.getIntervalType();var k=a._createUniversalUTCDate(i,undefined,true);switch(j){case m.Hour:k.setUTCMinutes(0);k.setUTCSeconds(0);k.setUTCMilliseconds(0);break;case m.Day:case m.Week:case m.OneMonth:k.setUTCHours(0);k.setUTCMinutes(0);k.setUTCSeconds(0);k.setUTCMilliseconds(0);break;case m.Month:k.setUTCDate(1);k.setUTCHours(0);k.setUTCMinutes(0);k.setUTCSeconds(0);k.setUTCMilliseconds(0);break;default:throw new Error("Unknown IntervalType: "+j+"; "+this);}return k;}function t(){return D.system.phone||(this.getGroupAppointmentsMode()===G.Collapsed);}function u(){var O=this._getAppointmentsSorted();var P;var Q;var S;var V=this.getIntervals();var W=this.getIntervalType();var X=this._getStartDate();var Y=X.getTime();var Z=this._oUTCEndDate;var $=Z.getTime();var a1=[];var b1=false;var i=0;var j=0;var c1=t.call(this);this.destroyAggregation("groupAppointments",true);for(i=0;i<O.length;i++){P=O[i];var d1=a._createUniversalUTCDate(P.getStartDate(),undefined,true);var e1=d1.getTime();d1.setUTCSeconds(0);d1.setUTCMilliseconds(0);var f1=P.getEndDate()?a._createUniversalUTCDate(P.getEndDate(),undefined,true):a._createUniversalUTCDate(new Date(864000000000000),undefined,true);var g1=f1.getTime();f1.setUTCSeconds(0);f1.setUTCMilliseconds(0);var h1=false;if(d1.getTime()<Y&&f1.getTime()>=Y){d1=new U(Y);h1=true;}if(f1.getTime()>$&&d1.getTime()<=$){f1=new U($);h1=true;}var i1=d1.getUTCHours()*60+d1.getUTCMinutes();d1.setUTCMinutes(d1.getUTCMinutes()-(i1%this._iMinDelta));var j1=(f1.getTime()-d1.getTime())/60000;if(h1&&j1==0){continue;}var k1=0;var l1=0;var m1=-1;Q=undefined;S=undefined;if(d1&&d1.getTime()<=$&&f1&&f1.getTime()>=Y&&e1<g1){if(c1&&(W==m.Month)&&((f1.getTime()-d1.getTime())<604800000)){Q=v.call(this,d1,P,W,V,X,Z,Y,a1);var n1=a._createUniversalUTCDate(Q.getEndDate(),undefined,true);if(f1.getTime()>n1.getTime()){S=v.call(this,f1,P,W,V,X,Z,Y,a1);}}k1=w.call(this,W,V,X,Z,Y,d1);l1=x.call(this,W,V,X,Z,Y,f1);if(Q){Q._iBegin=k1;Q._iEnd=l1;Q._iLevel=m1;if(S){S._iBegin=k1;S._iEnd=l1;S._iLevel=m1;}continue;}a1.push({appointment:P,begin:k1,end:l1,calculatedEnd:l1,level:m1});if(this._sFocusedAppointmentId&&this._sFocusedAppointmentId==P.getId()){b1=true;}}}var o1=this.getAggregation("groupAppointments",[]);if(o1.length>0){for(i=0;i<a1.length;i++){P=a1[i];if(P.appointment._aAppointments&&P.appointment._aAppointments.length<=1){Q=P.appointment;var p1=false;if(Q._aAppointments.length==0){p1=true;}else{for(j=0;j<a1.length;j++){if(a1[j].appointment==Q._aAppointments[0]){p1=true;break;}}}if(!p1){for(j=0;j<o1.length;j++){S=o1[j];if(Q!=S){for(var k=0;k<S._aAppointments.length;k++){if(Q._aAppointments[0]==S._aAppointments[k]){S._aAppointments.splice(k,1);if(S._aAppointments.length==1){this.removeAggregation("groupAppointments",S);S.destroy();o1=this.getAggregation("groupAppointments",[]);}else{S.setProperty("title",S._aAppointments.length,true);}break;}}}}P.begin=Q._iBegin;P.end=Q._iEnd;P.calculatedEnd=Q._iEnd;P.level=Q._iLevel;P.appointment=Q._aAppointments[0];}else{a1.splice(i,1);i--;}this.removeAggregation("groupAppointments",Q);Q.destroy();o1=this.getAggregation("groupAppointments",[]);}}}if(!b1){if(a1.length>0){this._sFocusedAppointmentId=a1[0].appointment.getId();}else{this._sFocusedAppointmentId=undefined;}}this._aVisibleAppointments=a1;return this._aVisibleAppointments;}function v(i,k,O,P,S,Q,V,W){var X=this.getAggregation("groupAppointments",[]);var Y;var Z=p.call(this);var $=Z.getFirstDayOfWeek();var a1=i.getUTCDay();var b1=new U(i.getTime());b1.setUTCHours(0);b1.setUTCMinutes(0);b1.setUTCSeconds(0);b1.setUTCMilliseconds(0);if($<=a1){b1.setDate(b1.getDate()-(a1-$));}else{b1.setDate(b1.getDate()-(7-a1-$));}for(var j=0;j<X.length;j++){Y=X[j];var c1=a._createUniversalUTCDate(Y.getStartDate(),undefined,true);if(c1.getTime()==b1.getTime()){break;}Y=undefined;}if(!Y){var d1=new U(b1.getTime());d1.setDate(d1.getDate()+7);d1.setMilliseconds(-1);Y=new f(this.getId()+"-Group"+X.length,{type:k.getType(),startDate:a._createLocalDate(new Date(b1.getTime()),true),endDate:a._createLocalDate(new Date(d1.getTime()),true)});Y._aAppointments=[];this.addAggregation("groupAppointments",Y,true);var e1=w.call(this,O,P,S,Q,V,b1);var f1=x.call(this,O,P,S,Q,V,d1);W.push({appointment:Y,begin:e1,end:f1,calculatedEnd:f1,level:-1});}Y._aAppointments.push(k);if(Y.getType()!=g.None&&Y.getType()!=k.getType()){Y.setType(g.None);}Y.setProperty("title",Y._aAppointments.length,true);return Y;}function w(i,j,S,k,O,P){var Q=0;if(i!=m.Month){Q=100*(P.getTime()-O)/this._iRowSize;}else{var V=new U(P.getTime());V.setUTCDate(1);V.setUTCHours(0);V.setUTCMinutes(0);V.setUTCSeconds(0);V.setUTCMilliseconds(0);var W=new U(V.getTime());W.setUTCMonth(W.getUTCMonth()+1);W.setMilliseconds(-1);var X=W.getTime()-V.getTime();var Y=(V.getUTCFullYear()-S.getUTCFullYear())*12+V.getUTCMonth()-S.getUTCMonth();Q=(100*Y/j)+(100*(P.getTime()-V.getTime())/X)/j;}if(Q<0){Q=0;}Q=Math.round(Q*100000)/100000;return Q;}function x(i,j,S,k,O,P){var Q=0;if(i!=m.Month){Q=100-(100*(P.getTime()-O)/this._iRowSize);}else{var V=new U(P.getTime());V.setUTCDate(1);V.setUTCHours(0);V.setUTCMinutes(0);V.setUTCSeconds(0);V.setUTCMilliseconds(0);var W=new U(V.getTime());W.setUTCMonth(W.getUTCMonth()+1);W.setMilliseconds(-1);var X=W.getTime()-V.getTime();var Y=(V.getUTCFullYear()-S.getUTCFullYear())*12+V.getUTCMonth()-S.getUTCMonth();Q=100-((100*Y/j)+(100*(P.getTime()-V.getTime())/X)/j);}if(Q<0){Q=0;}Q=Math.round(Q*100000)/100000;return Q;}function y(){var V=[];if(this.getShowIntervalHeaders()){var k=this.getIntervalHeaders();var O;var P=this.getIntervals();var Q=this.getIntervalType();var S=this._getStartDate();var W=S.getTime();var X=this._oUTCEndDate;var Y=X.getTime();var i=0;var j=0;for(i=0;i<k.length;i++){O=k[i];var Z=a._createUniversalUTCDate(O.getStartDate(),undefined,true);Z.setUTCSeconds(0);Z.setUTCMilliseconds(0);var $=O.getEndDate()?a._createUniversalUTCDate(O.getEndDate(),undefined,true):a._createUniversalUTCDate(new Date(864000000000000),undefined,true);$.setUTCSeconds(0);$.setUTCMilliseconds(0);if(Z&&Z.getTime()<=Y&&$&&$.getTime()>=W){var a1=new U(S.getTime());var b1=new U(S.getTime());b1.setUTCMinutes(b1.getUTCMinutes()-1);var c1=-1;var d1=-1;for(j=0;j<P;j++){switch(Q){case m.Hour:b1.setUTCHours(b1.getUTCHours()+1);if(j>0){a1.setUTCHours(a1.getUTCHours()+1);}break;case m.Day:case m.Week:case m.OneMonth:b1.setUTCDate(b1.getUTCDate()+1);if(j>0){a1.setUTCDate(a1.getUTCDate()+1);}break;case m.Month:b1.setUTCDate(1);b1.setUTCMonth(b1.getUTCMonth()+2);b1.setUTCDate(0);if(j>0){a1.setUTCMonth(a1.getUTCMonth()+1);}break;default:throw new Error("Unknown IntervalType: "+Q+"; "+this);}if(Z&&Z.getTime()<=a1.getTime()&&$&&$.getTime()>=b1.getTime()){if(c1<0){c1=j;}d1=j;}}if(c1>=0){V.push({interval:c1,appointment:O,last:d1});}}}}this._aVisibleIntervalHeaders=V;return this._aVisibleIntervalHeaders;}function z(){if(this._isOneMonthsRowOnSmallSizes()){return;}var $=this.$("Apps");var k=$.innerWidth();if(k<=0){return;}var O=this.$("DummyApp");var P=O.outerHeight(true);if(P<=0){return;}var Q=O.outerWidth();var S=Q/k*100;var V=Math.ceil(1000*S)/1000;var W;var X;var Y=0;var Z=0;var i=0;var a1=false;var b1=!D.system.phone&&this.getAppointmentsReducedHeight();var c1;if(this.getShowIntervalHeaders()&&(this.getShowEmptyIntervalHeaders()||this._getVisibleIntervalHeaders().length>0)){Y=q(this.$("AppsInt0").children(".sapUiCalendarRowAppsIntHead")[0]).outerHeight(true);a1=true;}for(i=0;i<this._aVisibleAppointments.length;i++){W=this._aVisibleAppointments[i];X=W.appointment.$();var d1=Math.floor(1000*(100-W.calculatedEnd-W.begin))/1000;var e1=false;if(d1<V){W.end=100-W.begin-S;if(W.end<0){W.end=0;}W.level=-1;e1=true;X.addClass("sapUiCalendarAppSmall");}else if(X.hasClass("sapUiCalendarAppSmall")){W.end=W.calculatedEnd;e1=true;X.removeClass("sapUiCalendarAppSmall");}if(e1){if(this._bRTL){X.css("left",W.end+"%");}else{X.css("right",W.end+"%");}}}for(i=0;i<this._aVisibleAppointments.length;i++){W=this._aVisibleAppointments[i];X=W.appointment.$();var f1={};var g1=b1&&!this._getAppointmentReducedHeight(W.appointment);if(W.level<0){for(var j=0;j<this._aVisibleAppointments.length;j++){var h1=this._aVisibleAppointments[j];if(W!=h1&&W.begin<(Math.floor(1000*(100-h1.end))/1000)&&(Math.floor(1000*(100-W.end))/1000)>h1.begin&&h1.level>=0){if(f1[h1.level]){f1[h1.level]++;}else{f1[h1.level]=1;}if(b1&&!this._getAppointmentReducedHeight(h1.appointment)){if(f1[h1.level+1]){f1[h1.level+1]++;}else{f1[h1.level+1]=1;}}}}W.level=0;while(f1[W.level]||(g1&&f1[W.level+1])){W.level++;}X.attr("data-sap-level",W.level);}c1=P*W.level+Y;if(!a1){c1+=T;}X.css("top",c1+"px");var i1=W.level;if(g1){i1++;}if(Z<i1){Z=i1;}}Z++;P=P*Z+Y;if(!a1){P+=T;}if(!this.getHeight()){$.outerHeight(P);}else{var j1=this.$("Apps").children(".sapUiCalendarRowAppsInt");for(i=0;i<j1.length;i++){var k1=q(j1[i]);k1.outerHeight(P);}}O.css("display","none");}function A(j,k){var i=0;var O;var P;var Q;var S;var V=I.getStaticId("sap.ui.unified","APPOINTMENT_SELECTED");if(k){var W=this.getAppointments();var X=this.getAggregation("groupAppointments",[]);q.merge(W,X);for(i=0;i<W.length;i++){O=W[i];if(O.getId()!==j.getId()&&O.getSelected()){O.setProperty("selected",false,true);O.$().removeClass("sapUiCalendarAppSel");for(var i=0;i<this.aSelectedAppointments.length;i++){if(this.aSelectedAppointments[i]!==O.getId()){this.aSelectedAppointments.splice(i);}}P=O.$().attr("aria-labelledby");Q=P?P.replace(V,""):"";O.$().attr("aria-labelledby",Q);}}}S=j.$().attr("aria-labelledby")+" "+V;Q=j.$().attr("aria-labelledby").replace(V,"").trim();if(j.getSelected()){j.setProperty("selected",false,true);j.$().removeClass("sapUiCalendarAppSel");j.$().attr("aria-labelledby",Q);E(this,k);}else{j.setProperty("selected",true,true);j.$().addClass("sapUiCalendarAppSel");j.$().attr("aria-labelledby",S);E(this,k);}this._updateSelectedAppointmentsArray(j);if(j._aAppointments){for(i=0;i<j._aAppointments.length;i++){O=j._aAppointments[i];O.setProperty("selected",true,true);S=O.$().attr("aria-labelledby")+" "+V;O.$().attr("aria-labelledby",S);}this.fireSelect({appointments:j._aAppointments,multiSelect:!k,domRefId:j.getId()});}else{this.fireSelect({appointment:j,multiSelect:!k,domRefId:j.getId()});}}function B(i){var P=this._getPlanningCalendar();if(P){P["_onRow"+i]();}}n.prototype._getPlanningCalendar=function(){var P=this;while(P.getParent()!==null){if(P.isA("sap.m.PlanningCalendar")){return P;}P=P.getParent();}};function E(i,j){if(j){B.call(i,"DeselectAppointment");}}function F(k){var O=this.getAggregation("groupAppointments",[]);var P;var Q=false;for(var i=0;i<O.length;i++){var S=O[i]._aAppointments;for(var j=0;j<S.length;j++){if(S[j].getId()==k){P=O[i];Q=true;break;}}if(Q){break;}}return P;}function H(j){if(this._sFocusedAppointmentId!=j){var k=this._getAppointmentsSorted();var V=this._aVisibleAppointments;var O;var i=0;O=F.call(this,j);if(O){j=O.getId();O=undefined;}for(i=0;i<V.length;i++){if(V[i].appointment.getId()==j){O=V[i].appointment;break;}}if(O){var $=this.getFocusedAppointment().$();var P=O.$();this._sFocusedAppointmentId=O.getId();$.attr("tabindex","-1");P.attr("tabindex","0");P.focus();}else{for(i=0;i<k.length;i++){if(k[i].getId()==j){O=k[i];break;}}if(O){this._sFocusedAppointmentId=O.getId();var Q=s.call(this,O.getStartDate());this.setStartDate(a._createLocalDate(Q,true));if(!e(this.getDomRef(),document.activeElement)){setTimeout(function(){this.getFocusedAppointment().focus();}.bind(this),0);}this.fireStartDateChange();}}}}function J(j,S){var k=this._sFocusedAppointmentId;var O=this._getAppointmentsSorted();var P=this.getAggregation("groupAppointments",[]);var Q;var V=0;var i=0;for(i=0;i<P.length;i++){if(P[i].getId()==k){var W=P[i]._aAppointments;if(j){k=W[W.length-1].getId();}else{k=W[0].getId();}break;}}for(i=0;i<O.length;i++){if(O[i].getId()==k){V=i;break;}}if(j){V=V+S;}else{V=V-S;}if(V<0){V=0;}else if(V>=O.length){V=O.length-1;}Q=O[V];H.call(this,Q.getId());}function K(j){var k=this._getAppointmentsSorted();var O;var S=new U(this._getStartDate());var P=new U(this._oUTCEndDate);var Q=this.getIntervalType();var V;var W;S.setUTCHours(0);P.setUTCHours(0);P.setUTCMinutes(0);P.setUTCSeconds(0);switch(Q){case m.Hour:P.setUTCDate(P.getUTCDate()+1);P.setUTCMilliseconds(-1);break;case m.Day:case m.Week:case m.OneMonth:S.setUTCDate(1);P.setUTCMonth(P.getUTCMonth()+1);P.setUTCDate(1);P.setUTCMilliseconds(-1);break;case m.Month:S.setUTCMonth(0);S.setUTCDate(1);P.setUTCFullYear(P.getUTCFullYear()+1);P.setUTCMonth(1);P.setUTCDate(1);P.setUTCMilliseconds(-1);break;default:throw new Error("Unknown IntervalType: "+Q+"; "+this);}var X=a._createLocalDate(S,true);var Y=a._createLocalDate(P,true);for(var i=0;i<k.length;i++){if(k[i].getStartDate()>=X&&k[i].getStartDate()<=Y){O=k[i];V=O.getId();if(j.type=="saphome"){break;}}else if(k[i].getStartDate()>Y){break;}}W=F.call(this,V);if(W){O=W;V=O.getId();}if(V&&V!=this._sFocusedAppointmentId){H.call(this,V);}else if(j._bPlanningCalendar&&O){O.focus();}else{this.fireLeaveRow({type:j.type});}}function M(i,j){var k=this.getIntervalType();var S=this._getStartDate();var O=new U(S.getTime());var P;var Q=false;var V=0;var W=0;if(q(j).hasClass("sapUiCalendarRowAppsSubInt")){Q=true;var X=q(q(j).parent()).children(".sapUiCalendarRowAppsSubInt");W=X.length;for(V=0;V<W;V++){var Y=X[V];if(Y==j){break;}}}switch(k){case m.Hour:O.setUTCHours(O.getUTCHours()+i);if(Q){O.setUTCMinutes(O.getUTCMinutes()+V*60/W);P=new U(O.getTime());P.setUTCMinutes(P.getUTCMinutes()+60/W);}else{P=new U(O.getTime());P.setUTCHours(P.getUTCHours()+1);}break;case m.Day:case m.Week:case m.OneMonth:O.setUTCDate(O.getUTCDate()+i);if(Q){O.setUTCHours(O.getUTCHours()+V*24/W);P=new U(O.getTime());P.setUTCHours(P.getUTCHours()+24/W);}else{P=new U(O.getTime());P.setUTCDate(P.getUTCDate()+1);}break;case m.Month:O.setUTCMonth(O.getUTCMonth()+i);if(Q){O.setUTCDate(O.getUTCDate()+V);P=new U(O.getTime());P.setUTCDate(P.getUTCDate()+1);}else{P=new U(O.getTime());P.setUTCMonth(P.getUTCMonth()+1);}break;default:throw new Error("Unknown IntervalType: "+k+"; "+this);}P.setUTCMilliseconds(P.getUTCMilliseconds()-1);O=a._createLocalDate(O,true);P=a._createLocalDate(P,true);this.fireIntervalSelect({startDate:O,endDate:P,subInterval:Q});}function N(i,j){var k=i.getStartDate()-j.getStartDate();if(k==0){k=j.getEndDate()-i.getEndDate();}return k;}return n;});

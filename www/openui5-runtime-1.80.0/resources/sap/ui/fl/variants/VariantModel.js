/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/Switcher","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/changeHandler/Base","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/model/json/JSONModel"],function(_,e,i,a,m,O,L,J,B,R,U,S,V,b,c,C,d,f,g,h){"use strict";function j(E,P){return n(function(q,v){var M=v.model;var t=v.vmReference;var u=false;var T=q.key;var x=q.key;return Promise.resolve().then(function(){if(O.get([t,"currentVariant"],M.oData)&&M.oData[t].currentVariant!==M.oData[t].originalCurrentVariant){x=M.oData[t].originalCurrentVariant;u=true;return M.updateCurrentVariant(t,T,M.oAppComponent,true);}}).then(function(){if(O.get([t,"modified"],M.oData)===true){var y=V.getVariantChanges({reference:M.sFlexReference,vmReference:t,vReference:x,changeInstance:true});return k({changes:y,vmReference:t,vReference:x,revert:!u,model:M}).then(function(){M.oData[t].originalCurrentVariant=T;M.oData[t].modified=false;M.checkUpdate(true);});}}).then(function(){if(!u){M._callVariantSwitchListeners(t,M.oData[t].currentVariant);}});}.bind(null,E.getParameters(),P),P.model,P.vmReference);}function k(P){var v=P.model._getDirtyChangesFromVariantChanges(P.changes);return Promise.resolve().then(function(){if(P.revert){return R.revertMultipleChanges(v,{appComponent:P.model.oAppComponent,modifier:J,flexController:P.model.oFlexController});}}).then(function(){v.forEach(function(q){V.removeChangeFromVariant({reference:P.model.sFlexReference,change:q,vmReference:P.vmReference,vReference:P.vReference});P.model.oFlexController.deleteChange(q,P.model.oAppComponent);});});}function l(M,v,q){if(q||M.oData[v]){M.oData[v].variantBusy=q;}M.checkUpdate();}function n(q,M,v){M._oVariantSwitchPromise=M._oVariantSwitchPromise.catch(function(){}).then(l.bind(null,M,v,true)).then(q).then(l.bind(null,M,v,false)).catch(function(E){l(M,v,false);throw E;});M.oFlexController.setVariantSwitchPromise(M._oVariantSwitchPromise);return M._oVariantSwitchPromise;}function r(P){return S.switchVariant(P).then(function(){delete this.oData[P.vmReference];}.bind(this)).catch(function(E){L.warning(E.message);});}function s(P){return S.switchVariant(P).then(function(){this.oData[P.vmReference].originalCurrentVariant=P.newVReference;this.oData[P.vmReference].currentVariant=P.newVReference;if(this.oData[P.vmReference].updateVariantInURL){U.updateVariantInURL({vmReference:P.vmReference,newVReference:P.newVReference,model:this});}this._callVariantSwitchListeners(P.vmReference,P.newVReference);this.checkUpdate();}.bind(this));}function o(v,q,D){if((v.layer===f.getCurrentLayer(!D))&&(v.key!==q)){return true;}return false;}function w(q){return new Promise(function(t){if(q.getDomRef()){t();}else{q.addEventDelegate({onAfterRendering:function(){t();}});}});}var p=h.extend("sap.ui.fl.variants.VariantModel",{constructor:function(D,F,A,q){this.pSequentialImportCompleted=Promise.resolve();h.apply(this,arguments);this.bObserve=q;if(!F){F=sap.ui.requireSync("sap/ui/fl/FlexControllerFactory").createForControl(A);}this.oFlexController=F;this.oChangePersistence=this.oFlexController._oChangePersistence;this.sFlexReference=this.oChangePersistence.getComponentName();this.oAppComponent=A;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");this._oVariantSwitchPromise=Promise.resolve();this._oVariantAppliedListeners={};if(a(D)){try{D=V.fillVariantModel({reference:this.sFlexReference});}catch(E){L.error("Variants Map was not found: "+E.message);}}if(D&&typeof D==="object"){Object.keys(D).forEach(function(K){D[K].variants.forEach(function(v){if(!D[K].currentVariant&&(v.key===D[K].defaultVariant)){D[K].currentVariant=v.key;}v.originalTitle=v.title;v.originalFavorite=v.favorite;v.originalExecuteOnSelect=v.executeOnSelect;v.originalVisible=v.visible;});D[K].originalCurrentVariant=D[K].currentVariant;D[K].originalDefaultVariant=D[K].defaultVariant;});this.setData(D);}U.initialize({model:this});}});p.prototype.updateCurrentVariant=function(v,N,A,I){var P={vmReference:v,currentVReference:this.oData[v].originalCurrentVariant,newVReference:N,flexController:this.oFlexController,appComponent:A||this.oAppComponent,modifier:J,reference:this.sFlexReference};if(I){return s.call(this,P);}return n(s.bind(this,P),this,v);};p.prototype.getCurrentVariantReference=function(v){return this.oData[v].currentVariant;};p.prototype.getVariantManagementReference=function(v){var q="";var I=-1;Object.keys(this.oData).some(function(K){return this.oData[K].variants.some(function(t,u){if(t.key===v){q=K;I=u;return true;}});}.bind(this));return{variantManagementReference:q,variantIndex:I};};p.prototype.getVariant=function(v,q){return V.getVariant({reference:this.sFlexReference,vmReference:q||this.getVariantManagementReference(v).variantManagementReference,vReference:v});};p.prototype.getVariantProperty=function(v,P){return this.getVariant(v).content.content[P];};p.prototype.attachVariantApplied=function(P){var v=this.getVariantManagementReferenceForControl(sap.ui.getCore().byId(P.vmControlId));return this.waitForVMControlInit(v).then(function(v,P){if(!this._oVariantAppliedListeners[v]){this._oVariantAppliedListeners[v]={};}if(P.callAfterInitialVariant){var q={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:v,flexController:this.oFlexController};V.waitForInitialVariantChanges(q).then(function(){var t=V.getCurrentVariantReference({vmReference:v,reference:this.sFlexReference});this._callVariantSwitchListeners(v,t,P.callback);}.bind(this));}return w(P.control).then(function(){if(b.getRelevantVariantManagementControlId(P.control,this.getVariantManagementControlIds())===P.vmControlId){this.oData[v].showExecuteOnSelection=true;this.checkUpdate(true);this._oVariantAppliedListeners[v][P.control.getId()]=P.callback;}else{L.error("Error in attachVariantApplied: The passed VariantManagement ID does not match the responsible VariantManagement control");}}.bind(this));}.bind(this,v,P));};p.prototype._callVariantSwitchListeners=function(v,N,q){if(this._oVariantAppliedListeners[v]){var t;this.oData[v].variants.some(function(u){if(u.key===N){t=u;return true;}});if(q){q(t);}else{e(this._oVariantAppliedListeners[v],function(u,q){q(t);});}}};p.prototype.detachVariantApplied=function(v,q){var t=this.getVariantManagementReferenceForControl(sap.ui.getCore().byId(v));if(this._oVariantAppliedListeners[t]){delete this._oVariantAppliedListeners[t][q];}};p.prototype.addChange=function(q){var v=q.getVariantReference();var t=this.getVariantManagementReference(v).variantManagementReference;this.oData[t].modified=!!this.oData[t].variantsEditable;this.checkUpdate(true);return V.addChangeToVariant({reference:this.sFlexReference,change:q,vmReference:t,vReference:v});};p.prototype.removeChange=function(q){var v=q.getVariantReference();var t=this.getVariantManagementReference(v).variantManagementReference;return V.removeChangeFromVariant({reference:this.sFlexReference,change:q,vmReference:t,vReference:v});};p.prototype._getVariantTitleCount=function(N,v){var D=this.getData();return D[v].variants.reduce(function(q,t){if(N.toLowerCase()===t.title.toLowerCase()&&t.visible){q++;}return q;},0);};p.prototype._duplicateVariant=function(P){var N=P.newVariantReference;var q=P.sourceVariantReference;var v=P.variantManagementReference;var t=this.getVariant(q);var u=V.getVariantChanges({vmReference:v,vReference:q,changeInstance:true,reference:this.sFlexReference}).map(function(A){return A.getDefinition();});var D={content:{},controlChanges:u,variantChanges:{}};var x=f.compareAgainstCurrentLayer(t.content.layer,!this._bDesignTimeMode?d.USER:"");Object.keys(t.content).forEach(function(K){if(K==="fileName"){D.content[K]=N;}else if(K==="variantReference"){if(x===0){D.content[K]=t.content["variantReference"];}else if(x===-1){D.content[K]=q;}}else if(K==="content"){D.content[K]=JSON.parse(JSON.stringify(t.content[K]));D.content.content.title=P.title;}else{D.content[K]=t.content[K];}});D.content["layer"]=P.layer;u=D.controlChanges.slice();var y={};var z;D.controlChanges=u.reduce(function(A,E){if(f.compareAgainstCurrentLayer(E.layer,!this._bDesignTimeMode?d.USER:"")===0){y=m({},E);y.variantReference=D.content.fileName;if(!y.support){y.support={};}y.support.sourceChangeFileName=E.fileName;y.packageName="$TMP";z=C.createInitialFileContent(y);A.push(new C(z));}return A;}.bind(this),[]);return D;};p.prototype.copyVariant=function(P){var D=this._duplicateVariant(P);var v={key:D.content.fileName,layer:P.layer,title:D.content.content.title,originalTitle:D.content.content.title,originalExecuteOnSelect:D.content.content.executeOnSelect,executeOnSelect:false,favorite:true,originalFavorite:true,rename:true,change:true,remove:true,visible:true,originalVisible:true};var q=b.createVariant({appVersion:this.oFlexController.getAppVersion(),model:this,variantSpecificData:D});var t=[];[q].concat(q.getControlChanges()).forEach(function(u){t.push(this.oChangePersistence.addDirtyChange(u));}.bind(this));var I=V.addVariantToVariantManagement({variantData:m({},q.getDefinitionWithChanges(),{content:{content:{visible:v.visible,favorite:v.favorite}}}),reference:this.sFlexReference,vmReference:P.variantManagementReference});this.oData[P.variantManagementReference].variants.splice(I,0,v);return this.updateCurrentVariant(P.variantManagementReference,q.getId(),P.appComponent,true).then(function(){return t;});};p.prototype.removeVariant=function(P){var q=this.oChangePersistence.getDirtyChanges().filter(function(t){return(t.getVariantReference&&t.getVariantReference()===P.variant.getId())||t.getId()===P.variant.getId();});return this.updateCurrentVariant(P.variantManagementReference,P.sourceVariantReference,P.component).then(function(){var I=V.removeVariantFromVariantManagement({reference:this.sFlexReference,variant:P.variant,vmReference:P.variantManagementReference});this.oData[P.variantManagementReference].variants.splice(I,1);this.checkUpdate();q.forEach(function(t){this.oChangePersistence.deleteChange(t);}.bind(this));}.bind(this));};p.prototype.collectModelChanges=function(v,q){var D=this.getData()[v];var M=D.variants;var t=[];var P={};M.forEach(function(u){if(u.originalTitle!==u.title){P={variantReference:u.key,changeType:"setTitle",title:u.title,originalTitle:u.originalTitle,layer:q};t.push(P);}if(u.originalFavorite!==u.favorite){P={variantReference:u.key,changeType:"setFavorite",favorite:u.favorite,originalFavorite:u.originalFavorite,layer:q};t.push(P);}if(u.originalExecuteOnSelect!==u.executeOnSelect){P={variantReference:u.key,changeType:"setExecuteOnSelect",executeOnSelect:u.executeOnSelect,originalExecuteOnSelect:u.originalExecuteOnSelect,layer:q};t.push(P);}if(!u.visible&&u.originalVisible){P={variantReference:u.key,changeType:"setVisible",visible:false,layer:q};t.push(P);}});if(D.originalDefaultVariant!==D.defaultVariant){P={variantManagementReference:v,changeType:"setDefault",defaultVariant:D.defaultVariant,originalDefaultVariant:D.originalDefaultVariant,layer:q};t.push(P);}return t;};p.prototype.manageVariants=function(v,q,t,u){return new Promise(function(x){v.attachEventOnce("manage",{resolve:x,variantManagementReference:q,layer:t},this.fnManageClickRta,this);v.openManagementDialog(true,u);}.bind(this));};p.prototype.setVariantProperties=function(v,P,A){var q=-1;var t;var u=null;var D=this.getData();if(P.variantReference){q=this.getVariantManagementReference(P.variantReference).variantIndex;t=D[v].variants[q];}var N={};var x={};switch(P.changeType){case"setTitle":x.title=P.title;t.title=P.title;t.originalTitle=t.title;break;case"setFavorite":x.favorite=P.favorite;t.favorite=P.favorite;t.originalFavorite=t.favorite;break;case"setExecuteOnSelect":x.executeOnSelect=P.executeOnSelect;if(t){t.executeOnSelect=P.executeOnSelect;t.originalExecuteOnSelect=t.executeOnSelect;}break;case"setVisible":x.visible=P.visible;x.createdByReset=false;t.visible=P.visible;t.originalVisible=t.visible;break;case"setDefault":x.defaultVariant=P.defaultVariant;D[v].defaultVariant=P.defaultVariant;D[v].originalDefaultVariant=D[v].defaultVariant;var H=U.getStoredHashParams({model:this});if(H){if(D[v].defaultVariant!==D[v].currentVariant&&H.indexOf(D[v].currentVariant)===-1){U.update({parameters:H.concat(D[v].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}else if(D[v].defaultVariant===D[v].currentVariant&&H.indexOf(D[v].currentVariant)>-1){H.splice(H.indexOf(D[v].currentVariant),1);U.update({parameters:H,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}}if(!A&&D[v].currentVariant!==P.defaultVariant){this.updateCurrentVariant(v,P.defaultVariant,P.appComponent);}break;default:break;}var y=V.getContent(this.sFlexReference);if(q>-1){var z=V.setVariantData({variantData:x,vmReference:v,previousIndex:q,reference:this.sFlexReference});D[v].variants.splice(q,1);D[v].variants.splice(z,0,t);}else if(y[v]){y[v].defaultVariant=P.defaultVariant;}var E={vmReference:v,add:A,reference:this.sFlexReference};if(A===true){N.changeType=P.changeType;N.layer=P.layer;if(P.changeType==="setDefault"){N.fileType="ctrl_variant_management_change";N.selector=J.getSelector(v,P.appComponent);}else{if(P.changeType==="setTitle"){c.setTextInChange(N,"title",P.title,"XFLD");}N.fileType="ctrl_variant_change";N.selector=J.getSelector(P.variantReference,P.appComponent);}u=this.oFlexController.createBaseChange(N,P.appComponent);u.setContent(x);E.changeContent=u.getDefinition();V.updateChangesForVariantManagementInMap(E);this.oChangePersistence.addDirtyChange(u);}else if(P.change){E.changeContent=P.change.getDefinition();V.updateChangesForVariantManagementInMap(E);this.oChangePersistence.deleteChange(P.change);}this.setData(D);this.checkUpdate(true);return u;};p.prototype._ensureStandardVariantExists=function(v){var D=this.getData();var q=D[v]||{};var t=_(q,["initPromise"]);if(!D[v]||a(t)){D[v]=m(q,{currentVariant:v,originalCurrentVariant:v,defaultVariant:v,originalDefaultVariant:v,variants:[{key:v,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),originalTitle:this._oResourceBundle.getText("STANDARD_VARIANT_ORIGINAL_TITLE"),favorite:true,originalFavorite:true,executeOnSelect:false,originalExecuteOnSelect:false,visible:true,originalVisible:true,author:b.DEFAULT_AUTHOR}]});this.setData(D);var u={};u[v]={defaultVariant:v,variantManagementChanges:{},variants:[{content:{fileName:v,fileType:"ctrl_variant",variantManagementReference:v,variantReference:"",support:{user:b.DEFAULT_AUTHOR},content:{title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),favorite:true,visible:true,executeOnSelect:false}},controlChanges:[],variantChanges:{}}]};try{var x=V.getContent(this.sFlexReference);m(x,u);}catch(E){L.error("Variants Map was not found: "+E.message);}}};p.prototype.setModelPropertiesForControl=function(v,D,q){this.oData[v].modified=false;this.oData[v].showFavorites=true;var t=this._bDesignTimeMode;if(t!==D){this._bDesignTimeMode=D;if(D){U.clearAllVariantURLParameters({model:this});}else if(t){U.update({parameters:U.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this});}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents();}q.detachManage(this.fnManageClick,this);if(D){this.oData[v].variantsEditable=false;this.oData[v].variants.forEach(function(u){u.rename=true;u.change=true;u.remove=o(u,v,D);});}else if(this.oData[v]._isEditable){q.attachManage({variantManagementReference:v},this.fnManageClick,this);this.oData[v].variantsEditable=true;this.oData[v].variants.forEach(function(u){u.remove=o(u,v,D);if(u.layer===f.getCurrentLayer(true)){u.rename=true;u.change=true;}else{u.rename=false;u.change=false;}});}else{this.oData[v].variantsEditable=false;this.oData[v].variants.forEach(function(u){u.remove=false;u.rename=false;u.change=false;});}};p.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(E,D){var q=this.collectModelChanges(D.variantManagementReference,D.layer);D.resolve(q);};this.fnManageClick=function(E,D){if(!this.oFlexController||!V.getContent(this.sFlexReference)){return;}var q=this.collectModelChanges(D.variantManagementReference,f.getCurrentLayer(true));var t=[];q.forEach(function(u){u.appComponent=this.oAppComponent;t.push(this.setVariantProperties(D.variantManagementReference,u,true));}.bind(this));this.oChangePersistence.saveDirtyChanges(this.oAppComponent,false,t);};};p.prototype._handleSave=function(E){var v=E.getSource();var A=g.getAppComponentForControl(v);var q=this.getLocalId(v.getId(),A);return n(function(t,A,P){var u=P.def;var x=P.execute;var y=this.getCurrentVariantReference(t);var z=V.getVariantChanges({reference:this.sFlexReference,vmReference:t,vReference:y,changeInstance:true});if(P["overwrite"]){return this.oFlexController.saveSequenceOfDirtyChanges(this._getDirtyChangesFromVariantChanges(z),A).then(function(F){this.checkDirtyStateForControlModels([t]);return F;}.bind(this));}var N=g.createDefaultFileName();var D={variantManagementReference:t,appComponent:A,layer:f.getCurrentLayer(true),title:P["name"],sourceVariantReference:y,newVariantReference:N};return this.copyVariant(D).then(function(F){if(u){var G={changeType:"setDefault",defaultVariant:N,originalDefaultVariant:this.oData[t].defaultVariant,appComponent:A,layer:f.getCurrentLayer(true),variantManagementReference:t};var H=this.setVariantProperties(t,G,true);F.push(H);}if(x){var I={changeType:"setExecuteOnSelect",executeOnSelect:true,variantReference:N,appComponent:A,layer:f.getCurrentLayer(true),variantManagementReference:t};var K=this.setVariantProperties(t,I,true);F.push(K);}this.oData[t].modified=false;this.checkUpdate(true);return k({changes:z,vmReference:t,vReference:y,model:this}).then(this.oFlexController.saveSequenceOfDirtyChanges.bind(this.oFlexController,F,A));}.bind(this));}.bind(this,q,A,E.getParameters()),this,q);};p.prototype.getLocalId=function(I,A){return J.getSelector(I,A).id;};p.prototype.getVariantManagementReferenceForControl=function(v){var q=v.getId();var A=g.getAppComponentForControl(v);return(A&&A.getLocalId(q))||q;};p.prototype.switchToDefaultForVariantManagement=function(v){if(this.oData[v].currentVariant!==this.oData[v].defaultVariant){B.show(200);this.updateCurrentVariant(v,this.oData[v].defaultVariant).then(function(){B.hide();});}};p.prototype.switchToDefaultForVariant=function(v){Object.keys(this.oData).forEach(function(q){if(!v||this.oData[q].currentVariant===v){this.switchToDefaultForVariantManagement(q);}}.bind(this));};p.prototype.registerToModel=function(v){var q=this.getVariantManagementReferenceForControl(v);this._ensureStandardVariantExists(q);this.oData[q]._isEditable=v.getEditable();this.oData[q].showExecuteOnSelection=false;v.attachEvent("select",{vmReference:q,model:this},j);v.attachSave(this._handleSave,this);this.setModelPropertiesForControl(q,false,v);var u=v.getUpdateVariantInURL();this.oData[q].updateVariantInURL=u;U.registerControl({vmReference:q,updateURL:!!u,model:this});U.handleModelContextChange({model:this,vmControl:v});if(this.oData[q].initPromise){this.oData[q].initPromise.resolveFunction();delete this.oData[q].initPromise;}this.oData[q].init=true;};p.prototype.waitForVMControlInit=function(v){if(!this.oData[v]){this.oData[v]={};}else if(this.oData[v].init){return Promise.resolve();}this.oData[v].initPromise={};this.oData[v].initPromise.promise=new Promise(function(q){this.oData[v].initPromise.resolveFunction=q;}.bind(this));return this.oData[v].initPromise.promise;};p.prototype._getDirtyChangesFromVariantChanges=function(q){var t=q.map(function(u){return u.getDefinition().fileName;});return this.oChangePersistence.getDirtyChanges().filter(function(u){return i(t,u.getId());});};p.prototype.checkDirtyStateForControlModels=function(v){v.forEach(function(q){var t=this.oData[q];if(t.modified===true){var u=this.getCurrentVariantReference(q);var x=V.getVariantChanges({reference:this.sFlexReference,vmReference:q,vReference:u,changeInstance:true});var D=this._getDirtyChangesFromVariantChanges(x);if(D.length===0){t.modified=false;}}}.bind(this));this.checkUpdate(true);};p.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(q,v){return q.concat([this.oData[v].currentVariant]);}.bind(this),[]);};p.prototype.getVariantManagementControlIds=function(){var v;return Object.keys(this.oData||{}).reduce(function(q,t){if(this.oAppComponent.byId(t)){v=this.oAppComponent.createId(t);}else{v=t;}q.push(v);return q;}.bind(this),[]);};p.prototype.resetMap=function(){var v=Object.keys(this.oData);v.forEach(function(q){var P={vmReference:q,currentVReference:this.oData[q].currentVariant||this.oData[q].defaultVariant,newVReference:true,appComponent:this.oAppComponent,flexController:this.oFlexController,modifier:J,reference:this.sFlexReference};return n(r.bind(this,P),this,q);}.bind(this));return this._oVariantSwitchPromise.then(function(){V.resetContent(this.sFlexReference);U.initialize({model:this});U.update({parameters:[],updateHashEntry:true,model:this});}.bind(this));};return p;},true);

/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/ui/fl/Utils"],function(C,S,U){"use strict";var _={};function i(p){var r=p.reference;var l=p.layer;return _[r]&&_[r][l]&&_[r][l].backendDraft;}function s(p,B){var r=p.reference;var l=p.layer;if(_[r]){_[r][l].backendDraft=B;}}function a(p,D){var e=[];var f=D.changePersistences;f.forEach(function(o){e=o.getDirtyChanges().concat();e.forEach(function(g){o.deleteChange(g,true);});});return e.length>0;}function b(p){var D={dirtyChangesExist:false,changePersistences:[]};if(p.reference){var o=C.getChangePersistenceForComponent(p.reference,p.appVersion);if(o.getDirtyChanges().length>0){D.dirtyChangesExist=true;D.changePersistences.push(o);}}if(p.nonNormalizedReference){var e=C.getChangePersistenceForComponent(p.nonNormalizedReference,p.appVersion);if(e.getDirtyChanges().length>0){D.dirtyChangesExist=true;D.changePersistences.push(e);}}return D;}function c(v){return v.some(function(o){return o.versionNumber===0;});}function d(v,o){if(c(v)){v.shift();}v.splice(0,0,o);return v;}var V={};V.initialize=function(p){var r=p.reference;var l=p.layer;return S.versions.load(p).then(function(v){_[r]=_[r]||{};_[r][l]=v;_[r][l].backendDraft=c(v);return _[r][l];});};V.getVersions=function(p){var r=p.reference;var l=p.layer;if(!_[r]||!_[r][l]){throw Error("Versions for reference '"+r+"' and layer '"+l+"' were not initialized.");}var D=b(p);if(D.dirtyChangesExist){this.ensureDraftVersionExists(p);}return _[r][l];};V.clearInstances=function(){_={};};V.ensureDraftVersionExists=function(p){var r=U.normalizeReference(p.reference);var v=_[r][p.layer];if(!c(v)){_[r][p.layer].splice(0,0,{versionNumber:0});}};V.activateDraft=function(p){var v=V.getVersions(p);var D=c(v);if(!D){return Promise.reject("No draft exists");}var o=b(p);var e=[];if(o.dirtyChangesExist){var f=o.changePersistences;e=f.map(function(g){return g.saveDirtyChanges(p.appComponent,false,undefined,true);});}return Promise.all(e).then(S.versions.activate.bind(undefined,p)).then(function(g){s(p,false);return d(v,g);});};V.discardDraft=function(p){var v=V.getVersions(p);var D=b(p);if(i(p)){return S.versions.discardDraft(p).then(function(){v.shift();s(p,false);var e=a(p,D);return{backendChangesDiscarded:true,dirtyChangesDiscarded:e};});}v.shift();var e=a(p,D);return Promise.resolve({backendChangesDiscarded:false,dirtyChangesDiscarded:e});};return V;});

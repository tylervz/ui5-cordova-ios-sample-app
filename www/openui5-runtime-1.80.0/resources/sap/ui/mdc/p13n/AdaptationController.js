/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/UriParameters","sap/ui/base/ManagedObject","sap/ui/mdc/p13n/FlexUtil","sap/ui/model/json/JSONModel","sap/base/util/merge","sap/m/Button","sap/base/Log"],function(S,M,F,J,m,B,L){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var u=new S(window.location.search);var A=M.extend("sap.ui.mdc.AdaptationController",{library:"sap.ui.mdc",metadata:{properties:{adaptationControl:{type:"object"},liveMode:{type:"boolean",defaultValue:false},itemConfig:{type:"object"},sortConfig:{type:"object",defaultValue:{addOperation:"addSort",removeOperation:"removeSort",moveOperation:"moveSort",panelPath:"sap/ui/mdc/p13n/panels/SortPanel",title:r.getText("sort.PERSONALIZATION_DIALOG_TITLE")}},filterConfig:{type:"object",defaultValue:{filterControl:undefined,title:r.getText("filter.PERSONALIZATION_DIALOG_TITLE")}},stateRetriever:{type:"function"},retrievePropertyInfo:{type:"function"},afterChangesCreated:{type:"function"}},events:{beforeP13nContainerOpens:{container:{type:"object"}},afterP13nContainerCloses:{reason:{type:"string"}}}}});A.prototype.init=function(){this.oAdaptationModel=new J();this.oAdaptationModel.setSizeLimit(10000);this.oState={};this.bIsDialogOpen=false;};A.prototype.showP13n=function(s,p){if(u.getAll("sap-ui-xx-p13nLiveMode")[0]==="true"){this.setLiveMode(true);L.warning("Please note that the p13n liveMode is experimental");}if(!this.bIsDialogOpen){return this._retrievePropertyInfo().then(function(P){return this.createP13n(p,P).then(function(o){this._openP13nControl(o,s);return o;}.bind(this));}.bind(this));}};A.prototype.createP13n=function(p,P){return new Promise(function(a,b){this._retrieveControl(this.getAdaptationControl().getDelegate().name).then(function(d){if(!(P instanceof Array)){b("Please provide a property info array to create a p13n control");}this.oAdaptationControlDelegate=d;this._setP13nTypeSpecificInfo(p);var o=this._prepareAdaptationData(P);this._setP13nModelData(o);this._retrieveP13nContainer(this.sTitle).then(function(c){var e=c.getContent()[0];if(this.sP13nType=="Filter"){this._initializeFilterControl().then(function(f){this.getAdaptationControl().addDependent(c);f.setLiveMode(this.getLiveMode());a(c);}.bind(this));}else{e.setP13nModel(this.oAdaptationModel);this.getAdaptationControl().addDependent(c);a(c);}}.bind(this));}.bind(this),b);}.bind(this));};A.prototype.createSortChanges=function(n,a){return this._executeAfterAsyncActions(function(){var c=m({},this.getStateRetriever().call(this.getAdaptationControl(),this.oAdaptationControlDelegate));var p=c.sorters||[];var s=this.getSortConfig();var f=function(o){return o.name+o.descending;};var b=function(i){return i.hasOwnProperty("sorted")&&i.sorted===false?false:true;};var N=a?n:this._getFilledArray(p,n,"sorted").filter(b);var d=F.getArrayDeltaChanges(p,N,f,this.getAdaptationControl(),s.removeOperation,s.addOperation,s.moveOperation);if(this.getAfterChangesCreated()){this.getAfterChangesCreated()(this,d);}return d;}.bind(this));};A.prototype.createItemChanges=function(n){return this._executeAfterAsyncActions(function(){var c=m({},this.getStateRetriever().call(this.getAdaptationControl(),this.oAdaptationControlDelegate));var p=c.items;var i=this.getItemConfig();var s=function(o){return o.name;};var f=function(o){return o.hasOwnProperty("visible")&&o.visible===false?false:true;};var N=this._getFilledArray(p,n,"visible").filter(f);var I=F.getArrayDeltaChanges(p,N,s,this.getAdaptationControl(),i.removeOperation,i.addOperation,i.moveOperation);if(this.getAfterChangesCreated()){this.getAfterChangesCreated()(this,I);}return I;}.bind(this));};A.prototype.createConditionChanges=function(n){return this._executeAfterAsyncActions(function(){var c=[];var C=m({},this.getStateRetriever().call(this.getAdaptationControl(),this.oAdaptationControlDelegate));var p=C.filter;var a=this.getAdaptationControl();for(var f in n){var v=this._hasProperty(f);if(!v){L.warning("property '"+f+"' not supported");continue;}c=c.concat(F.getConditionDeltaChanges(f,n[f],p[f],a));}if(this.getAfterChangesCreated()){this.getAfterChangesCreated()(this,c);}return c;}.bind(this));};A.prototype._retrievePropertyInfo=function(){return new Promise(function(a,b){if(this.aPropertyInfo){a(this.aPropertyInfo);}else if(this.getRetrievePropertyInfo()){this.aPropertyInfo=this.getRetrievePropertyInfo().call(this.getAdaptationControl());a(this.aPropertyInfo);}else{this._retrieveControl(this.getAdaptationControl().getDelegate().name).then(function(d){this.oAdaptationControlDelegate=d;d.fetchProperties(this.getAdaptationControl()).then(function(p){this.aPropertyInfo=p;a(this.aPropertyInfo);}.bind(this));}.bind(this));}}.bind(this));};A.prototype._executeAfterAsyncActions=function(c){return new Promise(function(a,b){this._retrievePropertyInfo().then(function(p){a(c());});}.bind(this));};A.prototype._setP13nTypeSpecificInfo=function(p){this.sP13nType=p;var P=this["get"+p+"Config"]?this["get"+p+"Config"]():undefined;this.sAddOperation=P?P.addOperation:undefined;this.sRemoveOperation=P?P.removeOperation:undefined;this.sMoveOperation=P?P.moveOperation:undefined;this.sPanelPath=P?P.panelPath:undefined;this.sTitle=P?P.title:undefined;};A.prototype._openP13nControl=function(p,s){this.fireBeforeP13nContainerOpens({container:p});if(this.getLiveMode()){p.openBy(s);}else{p.open();}this.bIsDialogOpen=true;};A.prototype._arrayToMap=function(a){return a.reduce(function(b,p,i){b[p.name]=p;b[p.name].position=i;return b;},{});};A.prototype._getFilledArray=function(p,n,R){var N=m([],p);var a=m([],n);var e=this._arrayToMap(p);a.forEach(function(i){var E=e[i.name];if(!i.hasOwnProperty(R)||i[R]){var b=i.position;if(E){b=b>-1?b:E.position;var o=E.position;N.splice(b,0,N.splice(o,1)[0]);}else{b=b>-1?b:N.length;N.splice(b,0,i);}N[b]=i;}else if(E){N[E.position][R]=false;}});return N;};A.prototype._prepareAdaptationData=function(p){var i=[];var a=this.getAdaptationControl();var c=m({},this.getStateRetriever().call(a,this.oAdaptationControlDelegate));var I=c.items||[];var s=c.sorters||[];var e=this._arrayToMap(I);var E=this._arrayToMap(s);var b=c.filter||{};p.forEach(function(P){var d={};var k=P.name;var o=e[k];d.selected=o?true:false;d.position=o?o.position:-1;d=m(d,P);d.label=P.label||P.name;if(this.sP13nType=="Sort"){d.isSorted=E[k]?true:false;d.sortPosition=E[k]?E[k].position:-1;d.descending=E[k]?E[k].descending:false;}var f=b[k];d.isFiltered=f&&f.length>0?true:false;var g=this._checkRestrictions(d);if(g){i.push(d);}}.bind(this));return{items:i};};A.prototype._setP13nModelData=function(p){this._sortP13nData(p);this.oAdaptationModel.setProperty("/items",p.items);this.oState=m({},p);};A.prototype._retrieveP13nContainer=function(t){return new Promise(function(a,b){var l=this.getLiveMode();this._retrieveControl(l?"sap/m/ResponsivePopover":"sap/m/Dialog").then(function(C){if(this.sP13nType!="Filter"){this._retrieveControl(this.sPanelPath).then(function(P){var p=new P();p.attachEvent("change",function(){if(l){this._handleChange();}}.bind(this));var d=this._createP13nContainer(C,p,t);a(d);}.bind(this));}else{var f=this.getFilterConfig().filterControl;var d=this._createP13nContainer(C,f,t);a(d);}}.bind(this));}.bind(this));};A.prototype._retrieveControl=function(p){return new Promise(function(a,b){sap.ui.require([p],function(C){a(C);});});};A.prototype._initializeFilterControl=function(){var f=this.getFilterConfig().filterControl;return f.waitForInitialization().then(function(){this.oAdaptationModel.getProperty("/items").forEach(function(i){var o=f.getControlDelegate();if(i.selected||i.isFiltered){var a=o.beforeAddFilterFlex(i.name,f);a.then(function(b){f.addAggregation("filterItems",b);});}});return f;}.bind(this));};A.prototype._createP13nContainer=function(C,p,t){var c;if(this.getLiveMode()){c=this._createPopover(C,p,t);}else{c=this._createModalDialog(C,p,t);}c.addStyleClass("sapUiMdcPersonalizationDialog");c.toggleStyleClass("sapUiSizeCompact",!!jQuery(this.getAdaptationControl()).closest(".sapUiSizeCompact").length);return c;};A.prototype._createPopover=function(C,p,t){var c=new C({title:t,horizontalScrolling:false,verticalScrolling:true,contentWidth:"26rem",resizable:true,contentHeight:"40rem",placement:"HorizontalPreferredRight",content:p,afterClose:function(){this._checkAndKeepFilter(c);c.destroy();this.fireAfterP13nContainerCloses({reason:"autoclose"});this.bIsDialogOpen=false;}.bind(this)});return c;};A.prototype._createModalDialog=function(C,p,t){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var c=new C({title:t,horizontalScrolling:false,verticalScrolling:true,contentWidth:"40rem",contentHeight:"55rem",draggable:true,resizable:true,stretch:"{device>/system/phone}",content:p,buttons:[new B({text:r.getText("p13nDialog.OK"),type:"Emphasized",press:function(){this._checkAndKeepFilter(c);this._handleChange();c.close();c.destroy();this.bIsDialogOpen=false;this.fireAfterP13nContainerCloses({reason:"Ok"});}.bind(this)}),new B({text:r.getText("p13nDialog.CANCEL"),press:function(){this._checkAndKeepFilter(c);c.close();c.destroy();this.bIsDialogOpen=false;this.fireAfterP13nContainerCloses({reason:"Cancel"});}.bind(this)})]});return c;};A.prototype._checkAndKeepFilter=function(c){if(this.sP13nType=="Filter"){c.getContent()[0].getFilterItems().forEach(function(f){f.destroy();});c.removeAllContent();}};A.prototype._sortP13nData=function(d){var p=this.sP13nType=="Item"?"position":"sortPosition";var s=this.sP13nType=="Item"?"selected":"isSorted";var l=sap.ui.getCore().getConfiguration().getLocale().toString();var c=window.Intl.Collator(l,{});d.items.sort(function(f,a){if(f[s]&&a[s]){return(f[p]||0)-(a[p]||0);}else if(f[s]){return-1;}else if(a[s]){return 1;}else if(!f[s]&&!a[s]){return c.compare(f.label,a.label);}});};A.prototype._checkRestrictions=function(i){var I=true;if(this.sP13nType=="Sort"){I=i.sortable===false?false:true;}return I;};A.prototype._handleChange=function(){var c=[],i=[],C=[];var f=function(I){return this.sP13nType=="Sort"?I.isSorted:I.selected;}.bind(this);i=this.oState.items.filter(f);C=this.oAdaptationModel.getData().items.filter(f);var s=function(o){var d=o.name;if(o.hasOwnProperty("descending")){d=d+o.descending;}if(o.role){d=d+o.role;}return d;};c=F.getArrayDeltaChanges(i,C,s,this.getAdaptationControl(),this.sRemoveOperation,this.sAddOperation,this.sMoveOperation);this.oState=m({},this.oAdaptationModel.getData());this.getAfterChangesCreated()(this,c);};A.prototype._hasProperty=function(n){return this.aPropertyInfo.some(function(p){var v=p.name===n||n=="$search";return v;});};A.prototype.destroy=function(s){M.prototype.destroy.apply(this,arguments);if(this.oAdaptationModel){this.oAdaptationModel.destroy();}this.oAdaptationModel=null;this.bIsDialogOpen=null;this.sP13nType=null;this.oAdaptationControlDelegate=null;this.sAddOperation=null;this.sRemoveOperation=null;this.sMoveOperation=null;};return A;});

/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/base/ManagedObjectObserver','sap/ui/mdc/field/FieldBase','sap/ui/mdc/field/FieldBaseRenderer','sap/ui/mdc/enum/FieldDisplay','sap/ui/mdc/condition/Condition','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/enum/BaseType','sap/ui/mdc/enum/ConditionValidated','sap/base/util/deepEqual','sap/base/util/merge','sap/ui/model/BindingMode'],function(M,F,a,b,C,c,B,d,e,m,f){"use strict";var g=F.extend("sap.ui.mdc.Field",{metadata:{library:"sap.ui.mdc",properties:{value:{type:"any",defaultValue:null},additionalValue:{type:"any",defaultValue:null}},events:{change:{parameters:{value:{type:"string"},valid:{type:"boolean"},promise:{type:"Promise"}}}},defaultProperty:"value"},renderer:a});g.prototype.init=function(){this._vValue=null;this._vAdditionalValue=null;F.prototype.init.apply(this,arguments);this.setMaxConditions(1);this._oObserver.observe(this,{properties:["value","additionalValue"]});};g.prototype.exit=function(){F.prototype.exit.apply(this,arguments);if(this._iConditionUpdateTimer){clearTimeout(this._iConditionUpdateTimer);delete this._iConditionUpdateTimer;}};g.prototype.bindProperty=function(N,q){if(N==="value"&&!q.formatter){q.targetType="raw";if(q.type&&(!this._oDataType||this._oDataType.getMetadata().getName()!==q.type.getMetadata().getName())){this._oDataType=q.type;this.invalidate();}}F.prototype.bindProperty.apply(this,arguments);};g.prototype._handleModelContextChange=function(E){F.prototype._handleModelContextChange.apply(this,arguments);if(!this._oDataType){var q=this.getBinding("value");if(q){this._oDataType=q.getType();this.invalidate();}}};g.prototype._initDataType=function(){F.prototype._initDataType.apply(this,arguments);var q=this.getBinding("value");if(q){this._oDataType=q.getType();}};g.prototype.setMaxConditions=function(q){if(q!==1){throw new Error("Only one condition allowed for Field "+this);}return this.setProperty("maxConditions",q,true);};g.prototype._observeChanges=function(q){F.prototype._observeChanges.apply(this,arguments);if(q.name==="value"){var v=k.call(this,q.current,q.old);if(this._vAdditionalValue!==null&&p.call(this)&&!l.call(this,v,this._vValue,true)){this._vAdditionalValue=this.getAdditionalValue();}this._vValue=v;n.call(this,q.current);i.call(this);}if(q.name==="additionalValue"){this._vAdditionalValue=q.current;i.call(this);}if(q.name==="conditions"){o.call(this,q.current);}};function _(){return this._vValue;}function h(){return this._vAdditionalValue;}function i(){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.bIsDestroyed){i.call(this);}}.bind(this));return;}if(this.getDisplay()===b.Value){j.call(this,_.call(this),h.call(this));}else if(!this._iConditionUpdateTimer){this._iConditionUpdateTimer=setTimeout(function(){j.call(this,_.call(this),h.call(this));this._iConditionUpdateTimer=undefined;}.bind(this),0);}}function j(v,A){var q=this.getConditions();if(this._checkValueInitial(v)&&!A){if(q.length>0){this.setConditions([]);}}else{var O=q[0]&&q[0].values[0];var s=q[0]&&q[0].values[1]?q[0].values[1]:null;if(!q[0]||q[0].operator!=="EQ"||!l.call(this,O,v)||s!==A){var r=C.createItemCondition(v,A);r.validated=d.Validated;this.setConditions([r]);}}}function k(v,O){var D=this._oDataType?this._oDataType.getMetadata().getName():this.getDataType();if(v&&O&&(D==="sap.ui.model.odata.type.Unit"||D==="sap.ui.model.odata.type.Currency")&&!v[2]&&O[2]!==undefined){v=m([],v);v[2]=O[2];}return v;}function l(v,V,u){var E=v===V;var D=this._oDataType?this._oDataType.getMetadata().getName():this.getDataType();if(!E&&this.getTypeUtil().getBaseType(D)===B.Unit&&Array.isArray(v)&&Array.isArray(V)){var N=v[0];var U=v[1];var q=v.length>=3?v[2]:null;var r=V[0];var s=V[1];var t=V.length>=3?V[2]:null;if(N===r&&U===s&&(((this._bUnitSet||u)&&(!q||!t))||e(q,t))){E=true;}if((q||t)&&!u){this._bUnitSet=true;}}return E;}function n(v){if(!this._bTypeInitialized){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.bIsDestroyed){n.call(this,v);}}.bind(this));return;}var q=this.getBinding("value");var D=q&&q.getType();this._oTypeInitialization=this.getControlDelegate().initializeTypeFromBinding(this.getPayload(),D,v);this._bTypeInitialized=this._oTypeInitialization.bTypeInitialized;}}g.prototype._fireChange=function(q,v,w,P){var V;if(q){if(v){V=this._getResultForPromise(q);}else{V=w;}}this.fireChange({value:V,valid:v,promise:P});};g.prototype._getResultForPromise=function(q){var v;if(q.length===0&&this._oDataType){v=this._oDataType.parseValue("","string",[]);}else if(q.length===1){v=q[0].values[0];}return v;};function o(q){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.bIsDestroyed){o.call(this,q);}}.bind(this));return;}var v=null;var A=null;var O=this.getValue();var r=this.getAdditionalValue();if(q.length===0&&O===null&&r===null){return;}v=this._getResultForPromise(q);if(q.length===0&&!r){A=r;}else if(q.length===1&&q[0].values.length>1){A=q[0].values[1];}this._vValue=v;this._vAdditionalValue=A;if(!l.call(this,v,O,true)){this.setProperty("value",v,true);}if(A!==r&&!p.call(this)){this.setProperty("additionalValue",A,true);}}g.prototype._getOperators=function(){return["EQ"];};function p(){var q=this.getBinding("additionalValue");if(q&&q.getBindingMode()===f.OneWay){return true;}return false;}return g;});

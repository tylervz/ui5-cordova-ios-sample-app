/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/library","sap/ui/mdc/ChartDelegate","sap/ui/base/SyncPromise","sap/ui/mdc/odata/v4/BaseDelegate","./ODataMetaModelUtil","sap/base/util/merge",'sap/ui/core/Core','sap/ui/mdc/util/FilterUtil','sap/ui/mdc/odata/v4/util/DelegateUtil'],function(M,B,S,a,b,m,C,F,D){"use strict";var A="@Org.OData.Aggregation.V1";function f(H){this.name=H[0];this.label=H[1]instanceof Object?H[1]["$Path"]:H[1]||this.name;this.textProperty=H[2];this.type=a.getTypeUtil().getPrimitiveType(H[3]);if(H[4]||H[5]){var s=H[4],d=H[5];if(d){switch(d){case"year":this.timeUnit="fiscalyear";break;case"yearPeriod":this.timeUnit="fiscalyearperiod";break;default:this.timeUnit=undefined;break;}}if(s&&!this.timeUnit){switch(s){case"yearMonth":this.timeUnit="yearmonth";break;case"date":this.timeUnit="yearmonthday";break;case"yearQuarter":this.timeUnit="yearquarter";break;case"yearWeek":this.timeUnit="yearweek";break;default:this.timeUnit=undefined;break;}}}this.criticality=H[6];return this;}function h(R){var g=R[0],d=R[1];var H={},p={},I;p.inChart=g||d||false;if(p.inChart){p.chartItems=[];if(g){H.kind=M.ChartItemType.Dimension;H.role=M.ChartItemRoleType.category;I=m({},H);p.chartItems.push(I);}if(d){H.kind=M.ChartItemType.Measure;H.role=M.ChartItemRoleType.axis1;H.contextDefiningProperties=R[4]||[];var s=R[2]||[],e=R[3];for(var i=0;i<s.length;i++){I=m({},H);I.aggregationMethod=s[i]instanceof Object?s[i]["$Path"]:s[i];I.default=I.aggregationMethod==e instanceof Object?e[i]["$Path"]:e[i];p.chartItems.push(I);}}}var o=this.getModel();return Promise.all([o.requestObject("@sapui.name",this),o.requestObject("@com.sap.vocabularies.Common.v1.Label",this),o.requestObject("@com.sap.vocabularies.Common.v1.Text/$Path",this),o.requestObject("$Type",this),b.fetchCalendarTag(o,this),b.fetchFiscalTag(o,this),b.fetchCriticality(o,this)]).then(f.bind(p));}function r(e,p,o,d){var k,P,g=[],I=[],s,j=[],l,n,K={};var q=b.getAllCustomAggregates(d);for(var t in q){I.push(m({},q[t],{propertyPath:t,kind:M.ChartItemType.Measure,role:M.ChartItemRoleType.axis1,sortable:q[t].sortable,filterable:q[t].filterable}));}var T=b.getAllAggregatableProperties(d);for(var u in T){k=T[u].propertyPath;K[k]=K[k]||{};K[k][T[u].aggregationMethod]={name:T[u].name,label:T[u].label};}var v=b.getSortRestrictionsInfo(d["@Org.OData.Capabilities.V1.SortRestrictions"]),w=b.getFilterRestrictionsInfo(d["@Org.OData.Capabilities.V1.FilterRestrictions"]);function x(P){j.push(P);b.addSortInfoForProperty(P,v);b.addFilterInfoForProperty(P,w);if(P.inChart){for(var i=0;i<P.chartItems.length;i++){var y=P.chartItems[i];y.propertyPath=P.name;y.type=P.type;y.timeUnit=P.timeUnit;y.criticality=P.criticality;if(y.kind==M.ChartItemType.Measure){var z=y.aggregationMethod instanceof Object?y.aggregationMethod["$Path"]:y.aggregationMethod;if(K[y.propertyPath]&&K[y.propertyPath][z]){y.name=K[y.propertyPath][y.aggregationMethod].name;y.label=K[y.propertyPath][y.aggregationMethod].label;}else{y.name=z+y.propertyPath;y.label=P.label+" ("+z+")";}y.customAggregate=false;y.sortable=true;y.sortDirection="both";y.filterable=true;}else{y.name=P.name;y.textProperty=P.textProperty;y.label=P.label;y.sortable=P.sortable;y.sortDirection=P.sortDirection;y.filterable=P.filterable;y.allowedExpressions=P.allowedExpressions;}I.push(y);}}}for(k in e){if(k[0]!=="$"){P=e[k];if(P&&P.$kind&&(P.$kind=="Property")){s=p+k+A;g.push(Promise.all([o.requestObject(s+".Groupable"),o.requestObject(s+".Aggregatable"),o.requestObject(s+".SupportedAggregationMethods"),o.requestObject(s+".RecommendedAggregationMethod"),o.requestObject(s+".ContextDefiningProperties")]).then(h.bind(o.getMetaContext(p+k))).then(x));}}}return Promise.all(g).then(function(){return[n,l,j,I];});}var c=Object.assign({},B,a);c.MetadataProperty={kind:"Measure",role:"axis1",contextDefiningProperties:[],className:"sap.ui.mcd.chart.MeasureItem",aggregationMethod:"sum","default":true,custom:false,name:"sumSalesAmount",propertyPath:"SalesAmount",label:"Total Sales Amount",textProperty:"",sortable:true,sortDirection:"both",filterable:true,allowedExpressions:[]};c.fetchProperties=function(o){return this.retrieveAllMetadata(o).then(function(d){return d.properties;});};c.retrieveAggregationItem=function(s,o){var d;var e={className:"",settings:{key:o.name,label:o.label||o.name,type:o.type}};switch(o.kind){case M.ChartItemType.Dimension:e.className="sap.ui.mdc.chart.DimensionItem";d={textProperty:o.textProperty,timeUnit:o.timeUnit,displayText:true,criticality:o.criticality};break;case M.ChartItemType.Measure:e.className="sap.ui.mdc.chart.MeasureItem";d={propertyPath:o.propertyPath,aggregationMethod:o.aggregationMethod};break;}e.settings=Object.assign(e.settings,d);return e;};c.getModel=function(o){var v=o.getDelegate().model,d=o.getModel(v);if(d){return S.resolve(d);}return new S(function(e,g){function i(){var d=o.getModel(v);if(d){o.detachModelContextChange(i,o);return e(d);}}o.attachModelContextChange(i,o);});};c.retrieveAllMetadata=function(o){var d=this.getModel(o);function e(g){var i=o.getDelegate(),p="/"+i.payload.collectionName,j=g&&g.getMetaModel();if(p.endsWith("/")){throw new Error("The leading path for metadata calculation is the entity set not the path");}var s=p,t=p+"/";function k(R){var n={sortable:R[0],filterable:R[1],attributes:R[2],properties:R[3]};return n;}var l=[j.requestObject(t),j.requestObject(s)];return Promise.all(l).then(function(T){var E=T[0];var n=[b.fetchAllAnnotations(j,t),b.fetchAllAnnotations(j,s)];return Promise.all(n).then(function(q){var u=Object.assign(q[0],q[1]);return r(E,t,j,u);});}).then(k);}return d.then(e);};c.updateBindingInfo=function(o,d){var e=C.byId(o.getFilter());if(e){var g=e.getConditions();if(g){if(!d){d={};}var p=e.getPropertyInfoSet?e.getPropertyInfoSet():null;var P=D.getParameterNames(e);var i=F.getFilterInfo(e,g,p,P);if(i){d.filters=i.filters;}var s=D.getParametersInfo(e,g);if(s){d.path=s;}}var j=e.getSearch();if(j){if(!d){d={};}if(!d.parameters){d.parameters={};}d.parameters.$search=j;}}};c.rebindChart=function(o,d){B.rebindChart(o,d);};return c;});

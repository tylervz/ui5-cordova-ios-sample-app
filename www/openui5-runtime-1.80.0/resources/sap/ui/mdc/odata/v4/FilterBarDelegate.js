/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/enum/FieldDisplay',"sap/ui/fl/Utils","sap/ui/mdc/FilterBarDelegate",'sap/base/util/ObjectPath','sap/base/util/merge','sap/ui/mdc/odata/v4/BaseDelegate','sap/ui/mdc/condition/FilterOperatorUtil',"sap/ui/model/FilterOperator","sap/ui/model/Filter",'sap/ui/mdc/util/IdentifierUtil','sap/ui/core/util/reflection/JsControlTreeModifier'],function(F,a,b,O,m,B,c,M,d,I,J){"use strict";var e=Object.assign({},b,B);var D={"Edm.Boolean":"Bool","Edm.Byte":"Int","Edm.DateTime":"Date","Edm.DateTimeOffset":"DateTimeOffset","Edm.Decimal":"Decimal","Edm.Double":"Float","Edm.Float":"Float","Edm.Guid":"Guid","Edm.Int16":"Int","Edm.Int32":"Int","Edm.Int64":"Int","Edm.SByte":"Int","Edm.Single":"Float","Edm.String":"String","Edm.Time":"TimeOfDay"};var f={};e._fetchPropertiesByMetadata=function(o,p){var g,h,C,i,j;if(p){var k=p.modifier;g=k.getProperty(o,"delegate");h=g.payload.modelName===null?undefined:g.payload.modelName;C=g.payload.collectionName;i=p.appComponent.getModel(h);}else{g=o.getProperty("delegate");h=g.payload.modelName===null?undefined:g.payload.modelName;C=g.payload.collectionName;i=o.getModel(h);}j=o.getId?o.getId():o.id;var l={getDelegate:function(){return{payload:{modelName:h,collectionName:C}};},getModel:function(s){return i;},getId:function(){return j;}};return this.fetchProperties(l);};e._isMultiValue=function(s){var i=true;switch(s){case"SearchExpression":case"SingleRange":case"SingleValue":i=false;break;default:break;}return i;};e._ensureSingleRangeEQOperators=function(){var o;if(!c.getOperator("SINGLE_RANGE_EQ")){o=m({},c.getOperator("EQ"));o.name="SINGLE_RANGE_EQ";o.getModelFilter=function(C,s){return new d({filters:[new d(s,M.GE,C.values[0]),new d(s,M.LE,C.values[0])],and:true});};c.addOperator(o);}if(!c.getOperator("SINGLE_RANGE_EQ")){o=m({},c.getOperator("EQ"));o.name="SINGLE_RANGE_EQ";o.getModelFilter=function(C,s){return new d({filters:[new d(s,M.GE,C.values[0]),new d(s,M.LE,C.values[0])],and:true});};c.addOperator(o);}};e._ensureMultiRangeBTEXOperator=function(){if(!c.getOperator("MULTI_RANGE_BTEX")){var o=m({},c.getOperator("BT"));o.name="MULTI_RANGE_BTEX";o.getModelFilter=function(C,s){return new d({filters:[new d(s,M.GT,C.values[0]),new d(s,M.LT,C.values[1])],and:true});};c.addOperator(o);}};e._getFilterOperators=function(s){var o=null,g=null;switch(s){case"SingleValue":case"MultiValue":o="EQ";break;case"SingleRange":o="SINGLE_RANGE_EQ,SINGLE_RANGE_EQ,LE,GE";this._ensureSingleRangeEQOperators();break;case"MultiRange":o="EQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;case"SearchExpression":o="StartsWith,EndsWith,Contains";break;case"MultiRangeOrSearchExpression":o="StartsWith,EndsWith,Contains,EQ,LE,LT,GE,GT,BT,MULTI_RANGE_BTEX";this._ensureMultiRangeBTEXOperator();break;default:break;}if(o){g=o.split(',');}return g;};e._createFilterField=function(p,o,P){var g=P?P.modifier:J;var A=P?P.appComponent:a.getAppComponentForControl(o);var v=P?P.view:a.getViewForControl(o);var V=P?P.viewId:null;var n=p.path||p.name;var s={};if(o.getId){s.id=o.getId();}else{s.id=o.id;}var S=g.getControlIdBySelector(s,A);var i=S+"--filter--"+I.replace(n);return g.createControl("sap.ui.mdc.FilterField",A,v,i,{dataType:p.typeConfig.className,conditions:"{$filters>/conditions/"+n+'}',required:p.required,label:p.label,maxConditions:p.maxConditions,delegate:{name:"sap/ui/mdc/odata/v4/FieldBaseDelegate",payload:{}}},true).then(function(h){if(p.fieldHelp){var j=p.fieldHelp;if(!V){j=v.createId(p.fieldHelp);}else{j=V+"--"+p.fieldHelp;}g.setAssociation(h,"fieldHelp",j);}if(p.filterOperators){if(o.getId){g.setProperty(h,"operators",p.filterOperators);}else{g.setProperty(h,"operators",p.filterOperators.join(','));}}if(p.tooltip){g.setProperty(h,"tooltip",p.tooltip);}if(p.constraints){g.setProperty(h,"dataTypeConstraints",p.constraints);}if(p.formatOptions){g.setProperty(h,"dataTypeFormatOptions",p.formatOptions);}if(p.display){g.setProperty(h,"display",p.display);}return h;});};e._createFilter=function(p,o,P){return this._fetchPropertiesByMetadata(o,P).then(function(g){var h=g.find(function(i){return(I.getPropertyKey(i)===p);});if(!h){return null;}return Promise.resolve(this._createFilterField(h,o,P));}.bind(this));};e.beforeAddFilterFlex=function(p,o,P){return Promise.resolve(this._createFilter(p,o,P));};e.afterRemoveFilterFlex=function(o,g,p){return Promise.resolve(true);};e._getFieldGroupsByFilterFacetsAnnotation=function(o,E){};e._getNavigationPropertyForParameter=function(E){var o;for(var k in E){o=E[k];if(o){if(o.$kind==="NavigationProperty"){return k;}}}return null;};e._fetchPropertyInfo=function(o,E,n,g,k){var h=o.getObject(E+"/"+"@com.sap.vocabularies.UI.v1.TextArrangement");var H=false;if(o.getObject(E+"/"+k+"@com.sap.vocabularies.UI.v1.HiddenFilter")){H=true;}var i=false;if(o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.IsDigitSequence")){i=true;}var j=null;var l=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.FilterDefaultValue");if(l){var v=l["$"+D[g.$Type]];switch(g.$Type){case"Edm.DateTimeOffset":j=v;break;default:j=v;}}var L=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.Label")||k;var t=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.QuickInfo")||null;var C={};if(g.$MaxLength||g.$Precision||g.$Scale||i){if(g.$MaxLength){C.maxLength=g.$MaxLength;}if(g.$Precision){C.precision=g.$Precision;}if(g.$Scale){C.scale=g.$Scale;}if(i){C.isDigitSequence=i;}}else{C=null;}var s,T=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.Text");if(T){var p=o.getObject(E+"/"+k+"@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement")||h;if(p){if(p.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){s=F.Description;}else if(p.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){s=F.ValueDescription;}else{s=F.DescriptionValue;}}else{s=F.DescriptionValue;}}var P={name:k,label:L,tooltip:t,hiddenFilter:H};if(s){P.display=s;}if(g.$Type==="Edm.DateTimeOffset"){if(!C){C={};}C.V4=true;}if(C){P.constraints=C;}if(j){P.defaultFilterConditions=[{fieldPath:k,operator:"EQ",values:[j]}];}P.name=n?n+"/"+k:k;P.typeConfig=this.getTypeUtil().getTypeConfig(g.$Type,P.formatOptions,P.constraints);return P;};e._fetchEntitySet=function(o,E,v,n,p){return Promise.all([o.requestObject(E+"/"),o.requestObject(E+"@")]).then(function(r){var g=r[0];var h=r[1]||{};if(!g){return Promise.resolve([]);}var i,P,j=[],k=[],N=[],R=[],s=[],A={},l={},q=false;var t=o.getObject(E);if(t&&t.$NavigationPropertyBinding){l=t.$NavigationPropertyBinding;}var u=h["@Org.OData.Capabilities.V1.FilterRestrictions"];if(u){if(u.NonFilterableProperties){N=u.NonFilterableProperties.map(function(C){return C.$PropertyPath;});}if(u.RequiredProperties){R=u.RequiredProperties.map(function(C){return C.$PropertyPath;});}if(u.FilterExpressionRestrictions){u.FilterExpressionRestrictions.forEach(function(C){A[C.Property.$PropertyPath]=C.AllowedExpressions;});}}u=o.getObject(E+"/"+"@com.sap.vocabularies.UI.v1.SelectionFields");if(u){s=u.map(function(C){return C.$PropertyPath;});}var w=o.getObject(E+"/@sapui.name");var G=w;var x=o.getObject(E+"@com.sap.vocabularies.Common.v1.Label");if(!x){x=G;}v.push(w);u=o.getObject(E+"/"+"@com.sap.vocabularies.Common.v1.ResultContext");if(u){q=true;p.parameterNavigationName=e._getNavigationPropertyForParameter(g);}if(!n){var S=w.split('.');p.parameterEntityType=S[S.length-1];}for(var K in g){i=g[K];if(i){if(q&&(K==="$Key")){p.parameters=m([],i);}else if(i.$kind==="Property"){if(N.indexOf(K)>=0){continue;}if(o.getObject(E+"/"+K+"@com.sap.vocabularies.UI.v1.Hidden")){continue;}P=e._fetchPropertyInfo(o,E,n,i,K,p);if(P){P.group=G;P.groupLabel=x;P.required=R.indexOf(K)>=0;P.visible=s.indexOf(K)>=0;if(A[K]){var y=e._getFilterOperators(A[K]);if(y){P.filterOperators=y;}}P.maxConditions=e._isMultiValue(A[K])?-1:1;if(q&&p&&(p.parameters.indexOf(K)>-1)){P.path=null;P.name=K;P.required=true;p.parameterTypes[K]=i.$Type;j.push(P);}else if(!q){j.push(P);}}}else if(!q&&(i.$kind==="NavigationProperty")&&(!i.$isCollection)){var z=l[K];if(z&&(v.indexOf(i.$Type)===-1)){k.push(e._fetchEntitySet(o,'/'+z,v,K,p));}}}}return Promise.all(k).then(function(C){C.forEach(function(H){j=j.concat(H);});return j;});});};e._setModel=function(){var s=this.getPayload().modelName;s=s===null?undefined:s;var o=this.getModel(s);if(o){this.detachModelContextChange(e._setModel,this);e._fModelProvided(o);}};e._waitForMetaModel=function(o,p){return new Promise(function(r,g){var s=p===null?undefined:p;var h=o.getModel(s);if(h){r(h);}if(!o.attachModelContextChange){g();}e._fModelProvided=r;o.attachModelContextChange(e._setModel,o);});};e.fetchProperties=function(o){var s=o.getDelegate().payload.modelName;var E=o.getDelegate().payload.collectionName;return new Promise(function(r,g){var h;var C=o.getId()+'->'+E;if(f[C]){r(f[C]);return;}this._waitForMetaModel(o,s).then(function(i){if(!i||!E){g("model or entity set name not available");return;}h=i.getMetaModel();if(!h){g("metadata model not available");}else{var v=[];var p={parameterNavigationName:null,parameters:[],parameterTypes:{}};e._fetchEntitySet(h,'/'+E,v,null,p).then(function(P){if(p.parameterNavigationName&&(p.parameters.length>0)){window[o.getId()+'->'+E+"-Parameters"]=p;P.sort(function(j,k){var l=j.path||j.name;var n=k.path||k.name;if((!(p.parameters.indexOf(l)>-1)&&!(p.parameters.indexOf(n)>-1))||((p.parameters.indexOf(l)>-1)&&(p.parameters.indexOf(n)>-1))){return 0;}if((p.parameters.indexOf(l)>-1)&&!(p.parameters.indexOf(n)>-1)){return-1;}if(!(p.parameters.indexOf(l)>-1)&&(p.parameters.indexOf(n)>-1)){return 1;}});}f[C]=P;r(P);});}},function(){g("model not obtained");});}.bind(this));};e.cleanup=function(o){var s=o.getId()+"->";Object.keys(f).forEach(function(k){if(k.indexOf(s)===0){delete window[s+k+"-Parameters"];delete f[k];}});};return e;});

/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/core/XMLComposite','sap/ui/model/Filter','sap/ui/model/type/String','sap/ui/base/ManagedObjectObserver','sap/m/FlexItemData','sap/base/util/merge','sap/base/util/deepEqual','sap/ui/mdc/condition/Condition','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/condition/Operator','sap/ui/mdc/enum/EditMode','sap/ui/mdc/enum/FieldDisplay','sap/ui/mdc/enum/BaseType','sap/ui/mdc/enum/ConditionValidated','sap/ui/mdc/Field'],function(X,F,S,M,a,m,d,C,b,O,E,c,B,e,f){"use strict";var o=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");sap.ui.getCore().attachLocalizationChanged(function(){o=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");});var D=X.extend("sap.ui.mdc.field.DefineConditionPanel",{metadata:{properties:{conditions:{type:"object[]",group:"Data",defaultValue:[],byValue:true},formatOptions:{type:"object",defaultValue:{}}},events:{}},fragment:"sap.ui.mdc.field.DefineConditionPanel",init:function(){sap.ui.getCore().getMessageManager().registerObject(this,true);this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["conditions","formatOptions"]});var v=this.byId("defineCondition");this._oObserver.observe(v,{aggregations:["content"]});},exit:function(){sap.ui.getCore().getMessageManager().unregisterObject(this,true);this._oObserver.disconnect();this._oObserver=undefined;if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType;}},onBeforeRendering:function(){if(!this.oOperatorModel){this.oOperatorModel=new sap.ui.model.json.JSONModel();this.setModel(this.oOperatorModel,"om");}n.call(this);if(this.getConditions().length===0){this.updateDefineConditions();this._updateButtonVisibility();}},_updateButtonVisibility:function(u){var v=this.byId("defineCondition");if(!v){return;}var R=v.getContent();var w=this.getFormatOptions();var x=w.maxConditions;for(var i=0;i<R.length;i++){var y=R[i];var H=y.getContent()[2];var z=H.getItems()[1];z.setVisible((i===R.length-1)&&(x==-1||i<x-1));}},removeCondition:function(i){var u=i.oSource;var v=u.getBindingContext("$this").getObject();var w=this.getConditions();var I=b.indexOfCondition(v,w);this._bUpdateConditionsInternal=true;w.splice(I,1);this.setProperty("conditions",w,true);this.updateDefineConditions();this._updateButtonVisibility();this.invalidate();},addCondition:function(i){var u=i.oSource;var v=u.getBindingContext("$this").getObject();var w=this.getConditions();var I=b.indexOfCondition(v,w);var x=this.getFormatOptions();var y=x.maxConditions;if(y==-1||w.length<y){this._bUpdateConditionsInternal=true;this.addDummyCondition(I+1);}},addDummyCondition:function(i){var u=l.call(this);var v=u.indexOf("EQ")>=0?"EQ":u[0];var w=C.createCondition(v,[null],undefined,undefined,e.NotValidated);b.updateConditionValues(w);b.checkConditionsEmpty(w,u);var x=this.getConditions();if(i!==undefined){x.splice(i,0,w);}else{x.push(w);}this.setProperty("conditions",x,true);this._updateButtonVisibility();},updateDefineConditions:function(){var i=this.getConditions().filter(function(u){return u.validated!==e.Validated;});t.call(this,i,true,false);if(i.length===0){this._bUpdateConditionsInternal=true;this.addDummyCondition();}},valueCtrlFactory:function(i,u){var v=u.oModel;var P=u.sPath;var w=parseInt(P.split("/")[P.split("/").length-1]);P=P.slice(0,P.lastIndexOf("/"));P=P.slice(0,P.lastIndexOf("/"));var x=v.getProperty(P);var y=b.getOperator(x.operator);var z=p.call(this);if(!y){return;}var V=k.call(this,z,y,"$this>",w);V.addStyleClass("sapUiSmallPaddingBegin");V.setLayoutData(new a({shrinkFactor:0,growFactor:1}));if(V.attachChange){V.attachChange(this.onChange.bind(this));V.onpaste=this.onPaste.bind(this);}var A=this.getConditions();t.call(this,A,true,false);return V;},onChange:function(i){var u=l.call(this);var v=this.getConditions();b.checkConditionsEmpty(v,u);b.updateConditionsValues(v,u);this.setProperty("conditions",v,true);},onSelectChange:function(i){var u=i.getSource();var K=u.getValue();var v=u._sOldKey;var w=b.getOperator(K);var x=v&&b.getOperator(v);if(x&&!d(w.valueTypes[0],x.valueTypes[0])&&w.valueTypes[0]!==O.ValueType.Static){var y=u.getBindingContext("$this").getObject();var z=this.getConditions();var I=b.indexOfCondition(y,z);if(I>=0){y=z[I];if(y.values.length>0&&y.values[0]!==null){y.values[0]=null;}if(y.values.length>1&&y.values[1]!==null){y.values[1]=null;}this._bUpdateConditionsInternal=true;this.setProperty("conditions",z,true);}}delete u._sOldKey;},onPaste:function(u){var v,w=u.srcControl;if(window.clipboardData){v=window.clipboardData.getData("Text");}else{v=u.originalEvent.clipboardData.getData('text/plain');}var x=v.split(/\r\n|\r|\n/g);if(x&&x.length>1){setTimeout(function(){var y=l.call(this);var T=p.call(this);var z=r.call(this,T);var L=x.length;var A=this.getConditions();for(var i=0;i<L;i++){if(x[i]){var V=x[i];var G=V.split(/\t/g);var H;if(G.length==2&&G[0]&&G[1]){H=b.getOperator("BT");}else{G=[V.trim()];H=b.getDefaultOperator(z);}V=H?H.format(C.createCondition(H.name,G)):G[0];if(H){var I=H.getCondition(V,T,c.Value,true);if(I){I.validated=e.NotValidated;b.checkConditionsEmpty(I,y);A.push(I);}}}}this.setProperty("conditions",A,true);if(w.setDOMValue){w.setDOMValue("");}}.bind(this),0);}}});function _(i){if(i.name==="content"&&i.mutation==="insert"){g.call(this,i.child);}if(i.name==="value"){j.call(this,i.object,i.current,i.old);}if(i.name==="formatOptions"){var u=this.getConditions();if(u.length>0){h.call(this);this.setConditions([]);this.setConditions(u);}var v=i.current&&i.current.operators;var w=i.old&&i.old.operators;if(!d(v,w)){n.call(this);}var T=i.current&&i.current.valueType&&i.current.valueType.getMetadata().getName();var x=i.old&&i.old.valueType&&i.old.valueType.getMetadata().getName();if(T!==x&&u.length>0){t.call(this,u,true,true);}}if(i.name==="conditions"){if(this._bUpdateConditionsInternal){this._bUpdateConditionsInternal=false;return;}if(this._sConditionsTimer){clearTimeout(this._sConditionsTimer);this._sConditionsTimer=null;}this._sConditionsTimer=setTimeout(function(){this._sConditionsTimer=null;this.updateDefineConditions();this._updateButtonVisibility();}.bind(this),0);}}function g(G){var i=G.getContent();var u=i[0];var H=i[1];var L=H.getBinding("items");L.suspend();this._oObserver.observe(u,{properties:["value"]});}function h(){var v=this.byId("defineCondition");var G=v.getContent();for(var i=0;i<G.length;i++){var u=G[i];var w=u.getContent();var H=w[1];var L=H.getBinding("items");L.resume();}}function j(i,K,u){var G=i.getParent();var v=G.getContent();var H=v[1];var L=H.getBinding("items");i._sOldKey=u;if(!K){var w=i.getBindingContext("$this").getObject();var x=this.getConditions();var I=b.indexOfCondition(w,x);if(I>=0){w=x[I];w.operator=u;this._bUpdateConditionsInternal=true;this.setProperty("conditions",x,true);}}this.onChange();L.checkUpdate(true);}function k(i,u,P,v){if(u.valueTypes[v]&&[O.ValueType.Self,O.ValueType.Static].indexOf(u.valueTypes[v])===-1){i=u._createLocalType(u.valueTypes[v]);}if(u.createControl){return u.createControl(i,u,P,v);}var w=false;if(u.valueTypes[v]===O.ValueType.Static){w=true;i=q.call(this);}var T=w?B.String:r.call(this,i);var N;var x;var y;var z;switch(T){case B.Boolean:if(i.oConstraints&&i.oConstraints.hasOwnProperty("nullable")&&i.oConstraints.nullable===false){x=sap.ui.require(i.getMetadata().getName().replace(/\./g,"/"));y=m({},i.oFormatOptions);z=m(i.oConstraints,{nullable:true});N=new x(y,z);}else{N=i;}break;case B.Numeric:if(i.oFormatOptions&&i.oFormatOptions.hasOwnProperty("emptyString")&&i.oFormatOptions.emptyString===null){N=i;}else{x=sap.ui.require(i.getMetadata().getName().replace(/\./g,"/"));y=m(i.oFormatOptions,{emptyString:null});N=new x(y,i.oConstraints);}break;case B.Date:case B.Time:case B.DateTime:N=i;break;default:N=i;break;}var A=new f({delegate:s.call(this),value:{path:P,type:N,mode:'TwoWay',targetType:'raw'},editMode:w?E.Display:E.Editable,width:"100%"});return A;}function l(){var i=this.getFormatOptions();var u=i&&i.operators;if(!u||u.length===0){u=b.getOperatorsForType(B.String);}return u;}function n(){if(!this.oOperatorModel){return;}var T=p.call(this);var u=l.call(this);var I=o.getText("valuehelp.INCLUDE");var v=o.getText("valuehelp.EXCLUDE");var w=[];for(var i=0;i<u.length;i++){var x=u[i];var y=b.getOperator(x);if(!y||(y.showInSuggest!==undefined&&y.showInSuggest==false)){continue;}var z=y.textKey||"operators."+y.name+".longText";var A=y.getTypeText(z,T.getName().toLowerCase());if(A===z){A=y.longText;}var G=y.additionalInfo;if(G===undefined){if(G!==""&&y.formatRange){G=y.formatRange(y._getRange(undefined,T),T);}else{G=y.exclude?v:I;}}w.push({key:y.name,additionalText:A,info:G});}this.oOperatorModel.setData(w);}function p(){var i=this.getFormatOptions();var T=i&&i.valueType;if(!T){T=q.call(this);}return T;}function q(){if(!this._oDefaultType){this._oDefaultType=new S();}return this._oDefaultType;}function r(T){var i=T.getMetadata().getName();var u=T.oFormatOptions;var v=T.oConstraints;var w=this.getFormatOptions().delegate;var P=this.getFormatOptions().payload;var x=w?w.getTypeUtil(P).getBaseType(i,u,v):B.String;if(x===B.Unit){x=B.Numeric;}return x;}function s(){var i=this.getFormatOptions();var N=i.delegateName||"sap/ui/mdc/field/FieldBaseDelegate";var P=i.payload;return{name:N,payload:P};}function t(u,U,T){var v=p.call(this);var w=[];var i=0;for(i=0;i<u.length;i++){var x=u[i];var y=b.getOperator(x.operator);if(y&&y.valueTypes[0]===O.ValueType.Static&&(x.values.length===0||T)){if(y.getStaticText){var z=y.getStaticText(v);if(x.values.length>0){x.values[0]=z;}else{x.values.push(z);}w.push(i);}}}if(w.length>0){this._bUpdateConditionsInternal=true;this.setProperty("conditions",u,true);if(U){var V=this.byId("defineCondition");var G=V.getContent();for(i=0;i<w.length;i++){var A=G[w[i]];var H=A.getContent();var I=H[1];var L=I.getBinding("items");L.checkUpdate(true);}}}}return D;});

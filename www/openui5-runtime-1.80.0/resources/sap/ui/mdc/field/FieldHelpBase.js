/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/mdc/Element','sap/base/Log','sap/base/util/merge','sap/ui/base/SyncPromise','sap/ui/model/FormatException','sap/ui/model/ParseException'],function(E,L,m,S,F,P){"use strict";var a;var l;var b=E.extend("sap.ui.mdc.field.FieldHelpBase",{metadata:{interfaces:["sap.ui.core.PopupInterface"],library:"sap.ui.mdc",properties:{conditions:{type:"object[]",defaultValue:[],byValue:true},delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/field/FieldHelpBaseDelegate"}},filterValue:{type:"string",defaultValue:""},validateInput:{type:"boolean",defaultValue:true}},aggregations:{_popover:{type:"sap.m.Popover",multiple:false,visibility:"hidden"}},events:{select:{parameters:{conditions:{type:"object[]"},add:{type:"boolean"},close:{type:"boolean"}}},navigate:{parameters:{value:{type:"any"},key:{type:"any"},condition:{type:"object"}}},dataUpdate:{},disconnect:{},open:{suggestion:{type:"boolean"}},afterClose:{}},defaultProperty:"filterValue"}});b._init=function(){a=undefined;l=undefined;};b.prototype.init=function(){E.prototype.init.apply(this,arguments);this._oTextOrKeyPromises={};};b.prototype.invalidate=function(o){if(o){var p=this.getAggregation("_popover");if(p&&o===p){if(o.bOutput&&!this._bIsBeingDestroyed){var g=this.getParent();if(g){g.invalidate(this);}}return;}}};b.prototype.setFilterValue=function(s){this.setProperty("filterValue",s,true);return this;};b.prototype.connect=function(o){if(this._oField&&this._oField!==o){var p=this.getAggregation("_popover");if(p){p._oPreviousFocus=null;}this.close();this.setFilterValue("");this.setConditions([]);this.fireDisconnect();}this._oField=o;return this;};b.prototype._getField=function(){if(this._oField){return this._oField;}else{return this.getParent();}};b.prototype._getControlForSuggestion=function(){var o=this._getField();if(o.getControlForSuggestion){return o.getControlForSuggestion();}else{return o;}};b.prototype.getFieldPath=function(){var s="";if(this._oField&&this._oField.getFieldPath){s=this._oField.getFieldPath();}return s||"Help";};b.prototype.getDomRef=function(){var p=this.getAggregation("_popover");if(p){return p.getDomRef();}else{return E.prototype.getDomRef.apply(this,arguments);}};b.prototype.open=function(s){var o=this._getField();if(o){var p=this._getPopover();if(p){delete this._bOpen;delete this._bSuggestion;if(!p.isOpen()){if(!this.isFocusInHelp()){p.setInitialFocus(this._getControlForSuggestion());}var O=function(){if(this._bOpenAfterPromise){delete this._bOpenAfterPromise;this.open(s);}}.bind(this);var g=this._fireOpen(!!s,O);if(g){if(p._getAllContent().length>0){p.openBy(this._getControlForSuggestion());}else{this._bOpenIfContent=true;}}else{this._bOpenAfterPromise=true;}}}else{this._bOpen=true;this._bSuggestion=s;}}else{L.warning("FieldHelp not assigned to field -> can not be opened.",this);}};b.prototype.close=function(){var p=this.getAggregation("_popover");if(p&&p.isOpen()){var g=p.oPopup.getOpenState();if(g!=="CLOSED"&&g!=="CLOSING"){this._bClosing=true;p.close();}}else{delete this._bOpen;delete this._bSuggestion;delete this._bOpenIfContent;delete this._bOpenAfterPromise;}this._bReopen=false;};b.prototype.toggleOpen=function(s){var p=this.getAggregation("_popover");if(p){if(p.isOpen()){var g=p.oPopup.getOpenState();if(g!=="CLOSED"&&g!=="CLOSING"){this.close();}else{this._bReopen=true;}}else{this.open(s);}}else if(this._bOpen||this._bOpenIfContent||this._bOpenAfterPromise){delete this._bOpen;delete this._bSuggestion;delete this._bOpenIfContent;delete this._bOpenAfterPromise;}else{this.open(s);}};b.prototype.isOpen=function(C){if(C&&this._bClosing){return false;}var i=false;var p=this.getAggregation("_popover");if(p){i=p.isOpen();}return i;};b.prototype.skipOpening=function(){if(this._bOpenIfContent){delete this._bOpenIfContent;}if(this._bOpenAfterPromise){delete this._bOpenAfterPromise;}};b.prototype._createPopover=function(){var p;if((!a||!l)&&!this._bPopoverRequested){a=sap.ui.require("sap/m/Popover");l=sap.ui.require("sap/m/library");if(!a||!l){sap.ui.require(["sap/m/Popover","sap/m/library"],_.bind(this));this._bPopoverRequested=true;}}if(a&&l&&!this._bPopoverRequested){p=new a(this.getId()+"-pop",{placement:l.PlacementType.VerticalPreferredBottom,showHeader:false,showArrow:false,afterOpen:this._handleAfterOpen.bind(this),afterClose:this._handleAfterClose.bind(this)});this.setAggregation("_popover",p,true);if(this._oContent){this._setContent(this._oContent);}}return p;};function _(p,g){a=p;l=g;this._bPopoverRequested=false;if(!this._bIsBeingDestroyed){this._createPopover();if(this._bOpen){this.open(this._bSuggestion);}}}b.prototype._getPopover=function(){var p=this.getAggregation("_popover");if(!p){p=this._createPopover();}return p;};b.prototype._handleAfterOpen=function(o){};b.prototype._handleAfterClose=function(o){this._bClosing=false;if(this._bReopen){this._bReopen=false;this.open();}this.fireAfterClose();};b.prototype.openByTyping=function(){return false;};b.prototype.isFocusInHelp=function(){return!this.openByTyping();};b.prototype.navigate=function(s){};b.prototype.getTextForKey=function(k,i,o,B){return d.call(this,true,k,B,i,o);};b.prototype.getKeyForText=function(t,B){return d.call(this,false,t,B);};b.prototype._getTextOrKey=function(v,k,B,i,o){if(k){return"";}else{return undefined;}};b.prototype.getItemForValue=function(v,p,i,o,B,C,g,h){return c.call(this,v,p,i,o,B,C&&g,g,h,true);};function c(v,p,i,o,B,C,g,h,j){return S.resolve().then(function(){if(C){if(g){return this.getTextForKey(p,i,o,B);}}else if(h){return this.getKeyForText(v,B);}}.bind(this)).then(function(r){if(r){if(typeof r==="object"){return r;}else if(C){return{key:p,description:r};}else{return{key:r,description:v};}}else if(j&&((C&&h)||(!C&&g))){return c.call(this,v,p,i,o,B,!C,g,h,false);}else{return undefined;}}.bind(this)).catch(function(k){if(k&&!(k instanceof P)&&!(k instanceof F)){throw k;}if(k&&k._bNotUnique){throw k;}if(j&&((C&&h)||(!C&&g))){var r=c.call(this,v,p,i,o,B,!C,g,h,false);if(!r){throw k;}return r;}else{throw k;}}.bind(this)).unwrap();}b.prototype.isUsableForValidation=function(){return true;};b.prototype.onFieldChange=function(){};b.prototype._setContent=function(C){var p=this.getAggregation("_popover");if(p){p.removeAllContent();p.addContent(C);this._oContent=undefined;if(this._bOpenIfContent){var o=this._getField();if(o){p.openBy(this._getControlForSuggestion());}this._bOpenIfContent=false;}}else{this._oContent=C;}return this;};b.prototype.getIcon=function(){return"sap-icon://slim-arrow-down";};b.prototype.getUIArea=function(){var u=E.prototype.getUIArea.apply(this,arguments);if(!u){if(this._oField){u=this._oField.getUIArea();}}return u;};b.prototype.getScrollDelegate=function(){var p=this.getAggregation("_popover");if(p){return p.getScrollDelegate();}else{return undefined;}};b.prototype._fireOpen=function(s,C){var g=this._callContentRequest(s,C);if(g){this.fireOpen({suggestion:s});}return g;};b.prototype._callContentRequest=function(s,C){if(!this._bNoContentRequest){if(this._oContentRequestPromise){return false;}this.initControlDelegate();if(this.bDelegateInitialized){var p=this.getControlDelegate().contentRequest(this.getPayload(),this,s);if(p instanceof Promise){this._oContentRequestPromise=p;p.then(function(){this._oContentRequestPromise=undefined;this._bNoContentRequest=true;C();this._bNoContentRequest=false;}.bind(this));return false;}}else{this.awaitControlDelegate().then(function(){if(this._callContentRequest(s,C)){C();}}.bind(this));return false;}}return true;};function d(k,v,B,i,o){var I=JSON.stringify(i);var C=B&&B.getPath();if(this._oTextOrKeyPromises[k]&&this._oTextOrKeyPromises[k][v]&&this._oTextOrKeyPromises[k][v][I]&&this._oTextOrKeyPromises[k][v][I][C]){return this._oTextOrKeyPromises[k][v][I][C].promise;}var g=function(){e.call(this);}.bind(this);var s=this._callContentRequest(true,g);if(!s){if(!this._oTextOrKeyPromises[k]){this._oTextOrKeyPromises[k]={};}if(!this._oTextOrKeyPromises[k][v]){this._oTextOrKeyPromises[k][v]={};}if(!this._oTextOrKeyPromises[k][v][I]){this._oTextOrKeyPromises[k][v][I]={};}if(!this._oTextOrKeyPromises[k][v][I][C]){this._oTextOrKeyPromises[k][v][I][C]={};}this._oTextOrKeyPromises[k][v][I][C].promise=new Promise(function(r,R){this._oTextOrKeyPromises[k][v][I][C].resolve=r;this._oTextOrKeyPromises[k][v][I][C].reject=R;this._oTextOrKeyPromises[k][v][I][C].key=k;this._oTextOrKeyPromises[k][v][I][C].value=v;this._oTextOrKeyPromises[k][v][I][C].inParameters=i?m({},i):undefined;this._oTextOrKeyPromises[k][v][I][C].outParameters=o?m({},o):undefined;this._oTextOrKeyPromises[k][v][I][C].bindingContext=B;}.bind(this));return this._oTextOrKeyPromises[k][v][I][C].promise;}return this._getTextOrKey(v,k,B,i,o);}function e(){for(var k in this._oTextOrKeyPromises){for(var v in this._oTextOrKeyPromises[k]){for(var i in this._oTextOrKeyPromises[k][v]){for(var C in this._oTextOrKeyPromises[k][v][i]){var M=this._oTextOrKeyPromises[k][v][i][C].value;var g=this._oTextOrKeyPromises[k][v][i][C].key;var I=this._oTextOrKeyPromises[k][v][i][C].inParameters;var o=this._oTextOrKeyPromises[k][v][i][C].outParameters;var B=this._oTextOrKeyPromises[k][v][i][C].bindingContext;var r=this._getTextOrKey(M,g,B,I,o);if(r instanceof Promise){f.call(this,r,this._oTextOrKeyPromises[k][v][i][C].resolve,this._oTextOrKeyPromises[k][v][i][C].reject);}else{this._oTextOrKeyPromises[k][v][i][C].resolve(r);}delete this._oTextOrKeyPromises[k][v][i][C];}}}}}function f(p,r,R){p.then(function(v){r(v);}).catch(function(o){R(o);});}return b;});

/*
 * ! OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/base/ManagedObject','sap/ui/mdc/link/Panel','sap/ui/mdc/link/PanelItem','sap/ui/model/json/JSONModel','sap/ui/core/InvisibleText','sap/ui/base/ManagedObjectObserver','sap/ui/thirdparty/jquery','sap/base/Log','sap/ui/layout/library','sap/ui/layout/form/SimpleForm','sap/ui/core/Title'],function(M,P,a,J,I,b,q,L,l,S,C){"use strict";var c=l.form.SimpleFormLayout;var d=M.extend("sap.ui.mdc.link.ContentHandler",{metadata:{library:"sap.ui.mdc",properties:{enablePersonalization:{type:"boolean",defaultValue:true},modifyAdditionalContentCallback:{type:"function"}},aggregations:{additionalContent:{type:"sap.ui.core.Control",multiple:true,singularName:"additionalContent"},linkHandler:{type:"sap.ui.mdc.link.ILinkHandler",multiple:false}},associations:{sourceControl:{type:"sap.ui.core.Control",multiple:false}},events:{existenceOfContentChanged:{}}}});d.prototype.init=function(){var m=new J({contentTitle:undefined,bHasPotentialContent:undefined,linkHandlerItems:[]});m.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);m.setSizeLimit(1000);this.setModel(m,"$sapuimdcLink");this._oObserver=new b(q.proxy(this._observeChanges,this));this._oObserver.observe(this,{properties:["modifyAdditionalContentCallback"],aggregations:["linkHandler","additionalContent"]});};d.prototype.exit=function(){this._oObserver.disconnect();this._oObserver=undefined;};d.prototype.setLinkHandler=function(o){this.setAggregation("linkHandler",o);if(o&&o.isA("sap.ui.mdc.link.FlpLinkHandler")){this._oObserver.observe(o,{properties:["semanticObjects"],aggregations:["items"]});}else if(o&&o.isA("sap.ui.mdc.link.LinkHandler")){this._oObserver.observe(o,{aggregations:["items"]});}return this;};d.prototype.hasPotentialContent=function(){if(!!this.getModifyAdditionalContentCallback()||!!this.getAdditionalContent().length){return Promise.resolve(true);}if(this.getLinkHandler()){return this.getLinkHandler().hasPotentialLinks();}return Promise.resolve(false);};d.prototype.getDirectLink=function(){return this._determineAdditionalContent().then(function(A){return A.length?[]:this._determineLinkHandlerItems();}.bind(this)).then(function(e){var t=e.filter(function(i){return!!i.getHref();});if(t.length!==1){return null;}return t[0];});};d.prototype.getContentTitle=function(){return new I({text:this._getContentTitle()});};d.prototype.getContent=function(g){return sap.ui.getCore().loadLibrary('sap.ui.fl',{async:true}).then(function(){return new Promise(function(r){sap.ui.require(['sap/ui/fl/Utils','sap/ui/fl/apply/api/FlexRuntimeInfoAPI'],function(U,F){return this._determineLinkHandlerItems(true).then(function(e){this._setConvertedLinkHandlerItems(e,this._getView(U));e.some(function(o){if(o.getIsMain()===true){this._setContentTitle(o.getText());return true;}}.bind(this));return this._determineAdditionalContent();}.bind(this)).then(function(A){var m=this._getInternalModel().getProperty("/linkItems");var e=this._getInternalModel().getProperty("/baselineLinkItems");var p=new P(this._createPanelId(U,F),{enablePersonalization:this.getEnablePersonalization(),items:e.map(function(o){return new a(o.key,{text:o.text,description:o.description,href:o.href,target:o.target,icon:o.icon,isMain:o.isMain,visible:true});}),additionalContent:!A.length&&!m.length?d._getNoContent():A,beforeSelectionDialogOpen:function(){if(g&&g()){g().setModal(true);}},afterSelectionDialogClose:function(){if(g&&g()){g().setModal(false);}},metadataHelperPath:"sap/ui/mdc/link/ContentHandler"});p.setModel(new J({metadata:q.extend(true,[],this._getInternalModel().getProperty("/linkItems")),baseline:q.extend(true,[],this._getInternalModel().getProperty("/baselineLinkItems"))}),"$sapuimdcLink");return r(p);}.bind(this));}.bind(this));}.bind(this));}.bind(this));};d.retrieveAllMetadata=function(p){if(!p.getModel||!p.getModel("$sapuimdcLink")){return[];}var m=p.getModel("$sapuimdcLink");return m.getProperty("/metadata").map(function(o){return{id:o.key,text:o.text,description:o.description,href:o.href,target:o.target,icon:o.icon,isMain:o.isMain,visible:o.visible};});};d.retrieveBaseline=function(p){if(!p.getModel||!p.getModel("$sapuimdcLink")){return[];}var m=p.getModel("$sapuimdcLink");return m.getProperty("/baseline").map(function(o){return{id:o.key,visible:true};});};d._getLinkItemByKey=function(k,A){return A.filter(function(m){return m.key===k;})[0];};d.prototype._getView=function(U){var f;if(this.getParent()&&this.getParent().getParent()){f=this.getParent().getParent();}var o=sap.ui.getCore().byId(this.getSourceControl());if(!o){L.error("Invalid source control: "+this.getSourceControl()+". The mandatory 'sourceControl' association should be defined due to personalization reasons, parent: "+f+" used instead.");}return U.getViewForControl(o)||U.getViewForControl(f);};d.prototype._createPanelId=function(U,F){var f;if(this.getParent()&&this.getParent().getParent()){f=this.getParent().getParent();}var o=sap.ui.getCore().byId(this.getSourceControl());if(!o){L.error("Invalid source control: "+this.getSourceControl()+". The mandatory 'sourceControl' association should be defined due to personalization reasons, parent: "+f+" used instead.");}if(!F.isFlexSupported({element:this})){L.error("Invalid component. The mandatory 'sourceControl' association should be assigned to the app component due to personalization reasons.");return this.getId()+"-idInfoPanel";}var A=U.getAppComponentForControl(o)||U.getAppComponentForControl(f);return A.createId("idInfoPanel");};d.prototype._setConvertedLinkHandlerItems=function(e,v){var m=this._getInternalModel();var f=e.map(function(o){if(!o.getKey()){L.error("sap.ui.mdc.link.ContentHandler: undefined 'key' property of the LinkItem "+o.getId()+". The mandatory 'key' property should be defined due to personalization reasons.");}return{key:o.getKey(),text:o.getText(),description:o.getDescription(),href:o.getHref(),target:o.getTarget(),icon:o.getIcon(),isMain:o.getIsMain(),isSuperior:o.getInitiallyVisible(),visible:false};});m.setProperty("/linkItems/",f);var g=f.filter(function(o){return o.isMain===true||!o.key;});m.setProperty("/baselineLinkItems/",g);};d.prototype._determineLinkHandlerItems=function(o){if(!this._oLinkHandlerItemsPromise||o){var e=this.getLinkHandler();this._oLinkHandlerItemsPromise=e?e.determineItems():Promise.resolve([]);}return this._oLinkHandlerItemsPromise;};d._getNoContent=function(){var s=new S({layout:c.ResponsiveGridLayout,content:[new C({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc").getText("info.POPOVER_MSG_NO_CONTENT")})]});s.addStyleClass("mdcbaseinfoPanelDefaultAdditionalContent");return s;};d.prototype._determineAdditionalContent=function(){if(this.getModifyAdditionalContentCallback()){return this.getModifyAdditionalContentCallback()(this).then(function(){return this.getAdditionalContent()?this.getAdditionalContent().map(function(A){return A.clone();}):[];}.bind(this));}return Promise.resolve(this.getAdditionalContent()?this.getAdditionalContent().map(function(A){return A.clone();}):[]);};d.prototype._getContentTitle=function(){return this._getInternalModel().getProperty("/contentTitle");};d.prototype._setContentTitle=function(t){return this._getInternalModel().setProperty("/contentTitle",t);};d.prototype._getInternalModel=function(){return this.getModel("$sapuimdcLink");};d.prototype._observeChanges=function(o){if(o.object.isA("sap.ui.mdc.link.ILinkHandler")||o.object.isA("sap.ui.mdc.link.ContentHandler")){this._determineContent();}};d.prototype._determineContent=function(){this.hasPotentialContent().then(function(h){if(this._getInternalModel().getProperty('/bHasPotentialContent')!==h){this._getInternalModel().setProperty('/bHasPotentialContent',h);this.fireExistenceOfContentChanged();}}.bind(this));};return d;});

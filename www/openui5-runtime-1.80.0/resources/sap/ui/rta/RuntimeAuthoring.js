/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/ui/rta/toolbar/Fiori","sap/ui/rta/toolbar/Standalone","sap/ui/rta/toolbar/Personalization","sap/ui/dt/DesignTime","sap/ui/dt/Overlay","sap/ui/rta/command/Stack","sap/ui/rta/command/CommandFactory","sap/ui/rta/command/LREPSerializer","sap/ui/rta/plugin/Rename","sap/ui/rta/plugin/DragDrop","sap/ui/rta/plugin/RTAElementMover","sap/ui/rta/plugin/CutPaste","sap/ui/rta/plugin/Remove","sap/ui/rta/plugin/CreateContainer","sap/ui/rta/plugin/additionalElements/AdditionalElementsPlugin","sap/ui/rta/plugin/additionalElements/AddElementsDialog","sap/ui/rta/plugin/additionalElements/AdditionalElementsAnalyzer","sap/ui/rta/plugin/Combine","sap/ui/rta/plugin/Split","sap/ui/rta/plugin/Selection","sap/ui/rta/plugin/Settings","sap/ui/rta/plugin/Stretch","sap/ui/rta/plugin/ControlVariant","sap/ui/rta/plugin/iframe/AddIFrame","sap/ui/dt/plugin/ToolHooks","sap/ui/dt/plugin/ContextMenu","sap/ui/dt/plugin/TabHandling","sap/ui/rta/Utils","sap/ui/dt/Util","sap/ui/dt/ElementUtil","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/write/api/ReloadInfoAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/m/MessageBox","sap/m/MessageToast","sap/ui/rta/util/PopupManager","sap/ui/core/BusyIndicator","sap/ui/dt/DOMUtil","sap/ui/rta/util/StylesLoader","sap/ui/rta/appVariant/Feature","sap/ui/Device","sap/ui/rta/service/index","sap/ui/rta/util/ServiceEventBus","sap/ui/dt/OverlayRegistry","sap/base/strings/capitalize","sap/base/util/UriParameters","sap/ui/performance/Measurement","sap/base/Log","sap/ui/events/KeyCodes","sap/ui/rta/util/validateFlexEnabled"],function(q,M,F,S,P,D,O,C,a,L,R,b,c,d,e,f,A,g,h,i,j,k,l,m,n,o,T,p,r,U,s,E,t,u,v,w,x,V,y,z,B,G,H,I,J,K,N,Q,W,X,Y,Z,$,_,a1,b1){"use strict";var c1="STARTING";var d1="STARTED";var e1="STOPPED";var f1="FAILED";var g1="SERVICE_STARTING";var h1="SERVICE_STARTED";var i1="SERVICE_FAILED";var j1=M.extend("sap.ui.rta.RuntimeAuthoring",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.base.ManagedObject"}},properties:{customFieldUrl:"string",showCreateCustomField:"boolean",showToolbars:{type:"boolean",defaultValue:true},triggeredFromDialog:{type:"boolean",defaultValue:false},showWindowUnloadDialog:{type:"boolean",defaultValue:true},commandStack:{type:"any"},plugins:{type:"any",defaultValue:{}},flexSettings:{type:"object",defaultValue:{layer:v.CUSTOMER,developerMode:true}},mode:{type:"string",defaultValue:"adaptation"},metadataScope:{type:"string",defaultValue:"default"},validateAppVersion:{type:"boolean",defaultValue:false}},events:{start:{parameters:{editablePluginsCount:{type:"int"}}},stop:{},failed:{},selectionChange:{parameters:{selection:{type:"sap.ui.dt.Overlay[]"}}},modeChanged:{},undoRedoStackModified:{}}},_sAppTitle:null,_dependents:null,_sStatus:e1,constructor:function(){M.apply(this,arguments);this._dependents={};this._mServices={};this._mCustomServicesDictinary={};this.iEditableOverlaysCount=0;this.addDependent(new G(),'popupManager');if(this.getShowToolbars()){this.getPopupManager().attachOpen(this.onPopupOpen,this);this.getPopupManager().attachClose(this.onPopupClose,this);}if(window.parent!==window){this.startService('receiver');}if(this._shouldValidateFlexEnabled()){this.attachEvent("start",b1.bind(null,this));}},_RELOAD:{NOT_NEEDED:"NO_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION",RELOAD_PAGE:"HARD_RELOAD"}});j1.prototype._shouldValidateFlexEnabled=function(){var n1=document.location.hostname;return n1.endsWith(".sap"+".corp")||n1==="localhost";};j1.prototype.getDefaultPlugins=function(){if(!this._mDefaultPlugins){var n1=new a({flexSettings:this.getFlexSettings()});this._mDefaultPlugins={};this._mDefaultPlugins["selection"]=new k({commandFactory:n1,multiSelectionRequiredPlugins:[i.getMetadata().getName(),e.getMetadata().getName()],elementEditableChange:this._onElementEditableChange.bind(this)});var o1=new c({commandFactory:n1});this._mDefaultPlugins["dragDrop"]=new b({elementMover:o1,commandFactory:n1,dragStarted:this._handleStopCutPaste.bind(this)});this._mDefaultPlugins["rename"]=new R({commandFactory:n1,editable:this._handleStopCutPaste.bind(this)});this._mDefaultPlugins["additionalElements"]=new A({commandFactory:n1,analyzer:h,dialog:new g()});this._mDefaultPlugins["createContainer"]=new f({commandFactory:n1});this._mDefaultPlugins["remove"]=new e({commandFactory:n1});this._mDefaultPlugins["cutPaste"]=new d({elementMover:o1,commandFactory:n1});this._mDefaultPlugins["settings"]=new l({commandFactory:n1});this._mDefaultPlugins["combine"]=new i({commandFactory:n1});this._mDefaultPlugins["split"]=new j({commandFactory:n1});this._mDefaultPlugins["contextMenu"]=new p();this._mDefaultPlugins["tabHandling"]=new r();this._mDefaultPlugins["stretch"]=new m();this._mDefaultPlugins["controlVariant"]=new n({commandFactory:n1});this._mDefaultPlugins["addIFrame"]=new o({commandFactory:n1});this._mDefaultPlugins["toolHooks"]=new T();}return q.extend({},this._mDefaultPlugins);};j1.prototype.addDependent=function(n1,o1,p1){p1=typeof p1==='undefined'?true:!!p1;if(!(o1 in this._dependents)){if(o1&&p1){this['get'+Y(o1,0)]=this.getDependent.bind(this,o1);}this._dependents[o1||n1.getId()]=n1;}else{throw s.createError("RuntimeAuthoring#addDependent",s.printf("Can't add dependency with same key '{0}'",o1),"sap.ui.rta");}};j1.prototype.getDependent=function(n1){return this._dependents[n1];};j1.prototype.getDependents=function(){return this._dependents;};j1.prototype.removeDependent=function(n1){delete this._dependents[n1];};j1.prototype._destroyDefaultPlugins=function(n1){for(var o1 in this._mDefaultPlugins){var p1=this._mDefaultPlugins[o1];if(p1&&!p1.bIsDestroyed){if(!n1||n1[o1]!==p1){p1.destroy();}}}if(!n1){this._mDefaultPlugins=null;}};j1.prototype.onPopupOpen=function(n1){var o1=n1.getParameters().getSource();if(o1.isA("sap.m.Dialog")&&this.getToolbar().isA("sap.ui.rta.toolbar.Fiori")){this.getToolbar().setColor("contrast");}this.getToolbar().bringToFront();};j1.prototype.onPopupClose=function(n1){if(n1.getParameters()instanceof sap.m.Dialog){this.getToolbar().setColor();}};j1.prototype.setPlugins=function(n1){if(this._oDesignTime){throw new Error('Cannot replace plugins: runtime authoring already started');}this.setProperty("plugins",n1);};j1.prototype.setFlexSettings=function(n1){var o1=Z.fromQuery(window.location.search);var p1=o1.get("sap-ui-layer");n1=q.extend({},this.getFlexSettings(),n1);if(p1){n1.layer=p1.toUpperCase();}if(n1.scenario||n1.baseId){var q1=t.buildLrepRootNamespace(n1.baseId,n1.scenario,n1.projectId);n1.rootNamespace=q1;n1.namespace=q1+"changes/";}U.setRtaStyleClassName(n1.layer);this.setProperty("flexSettings",n1);};j1.prototype.getLayer=function(){return this.getFlexSettings().layer;};j1.prototype.getRootControlInstance=function(){if(!this._oRootControl){this._oRootControl=E.getElementInstance(this.getRootControl());}return this._oRootControl;};j1.prototype._getTextResources=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");};j1.prototype._initVersioning=function(){return x.isVersioningEnabled(this.getLayer()).then(function(n1){this._bVersioningEnabled=n1;if(n1){return V.initialize({selector:this.getRootControlInstance(),layer:this.getLayer()});}}.bind(this));};j1.prototype.start=function(){this._sStatus=c1;var n1;var o1;var p1=this.getRootControlInstance();if(!this._oDesignTime){if(!p1){o1=new Error("Root control not found");_.error(o1);return Promise.reject(o1);}if(this.getValidateAppVersion()&&!t.isCorrectAppVersionFormat(t.getAppVersionFromManifest(t.getAppComponentForControl(p1).getManifest()))){o1=this._getTextResources().getText("MSG_INCORRECT_APP_VERSION_ERROR");_.error(o1);return Promise.reject(o1);}return this._initVersioning().then(this._determineReload.bind(this)).then(function(q1){if(q1){return Promise.reject("Reload triggered");}if(!this.getPlugins()||!Object.keys(this.getPlugins()).length){this.setPlugins(this.getDefaultPlugins());}this._destroyDefaultPlugins(this.getPlugins());Object.keys(this.getPlugins()).forEach(function(t1){if(this.getPlugins()[t1].attachElementModified){this.getPlugins()[t1].attachElementModified(this._handleElementModified,this);}}.bind(this));if(this.getPlugins()["settings"]){this.getPlugins()["settings"].setCommandStack(this.getCommandStack());}this._oSerializer=new L({commandStack:this.getCommandStack(),rootControl:this.getRootControl()});var r1=Object.keys(this.getPlugins());var s1=r1.map(function(t1){return this.getPlugins()[t1];},this);n1=new Promise(function(t1,u1){$.start("rta.dt.startup","Measurement of RTA: DesignTime start up");this._oDesignTime=new D({scope:this.getMetadataScope(),plugins:s1});this._oDesignTime.addRootElement(this._oRootControl);q(O.getOverlayContainer()).addClass("sapUiRta");if(this.getLayer()===v.USER){q(O.getOverlayContainer()).addClass("sapUiRtaPersonalize");}else{q("body").addClass("sapUiRtaMode");}this._oDesignTime.getSelectionManager().attachChange(function(v1){this.fireSelectionChange({selection:v1.getParameter("selection")});},this);this._oDesignTime.attachEventOnce("synced",function(){t1();$.end("rta.dt.startup","Measurement of RTA: DesignTime start up");},this);this._oDesignTime.attachEventOnce("syncFailed",function(v1){u1(v1.getParameter("error"));});}.bind(this));this._oldUnloadHandler=window.onbeforeunload;window.onbeforeunload=this._onUnload.bind(this);}.bind(this)).then(function(){var q1={selector:this.getRootControlInstance(),layer:this.getLayer()};return y.getResetAndPublishInfo(q1).then(function(r1){this.bInitialResetEnabled=r1.isResetEnabled;this.bInitialPublishEnabled=r1.isPublishEnabled;}.bind(this));}.bind(this)).then(function(){if(this.getShowToolbars()){return this._getToolbarButtonsVisibility().then(this._createToolsMenu.bind(this));}}.bind(this)).then(this._onStackModified.bind(this)).then(function(){J.loadStyles('InPageStyles').then(function(q1){var r1=q1.replace(/%scrollWidth%/g,I.getScrollbarWidth()+'px');I.insertStyles(r1,O.getOverlayContainer().get(0));});}).then(function(){return n1;}).then(function(){this.getPopupManager().setRta(this);if(this.getShowToolbars()){return this.getToolbar().show();}}.bind(this)).then(function(){if(N.browser.name==="ff"){q(document).on('contextmenu',k1);}}).then(function(){this.fnKeyDown=this._onKeyDown.bind(this);q(document).on("keydown",this.fnKeyDown);var q1=X.getOverlay(this.getRootControl());this._$RootControl=q1.getAssociatedDomRef();if(this._$RootControl){this._$RootControl.addClass("sapUiRtaRoot");}}.bind(this)).then(function(){this._sStatus=d1;this.fireStart({editablePluginsCount:this.iEditableOverlaysCount});}.bind(this)).catch(function(o1){if(o1!=="Reload triggered"){this._sStatus=f1;this.fireFailed(o1);}if(o1){this.destroy();return Promise.reject(o1);}}.bind(this));}};function k1(){return false;}j1.prototype._getToolbarButtonsVisibility=function(){return x.isPublishAvailable().then(function(n1){var o1=K.isPlatFormEnabled(this.getRootControlInstance(),this.getLayer(),this._oSerializer);var p1=n1&&o1;return{publishAvailable:n1,publishAppVariantSupported:p1,draftAvailable:this._isDraftAvailable()};}.bind(this));};j1.prototype._handleVersionToolbar=function(n1){var o1=n1||this._isDraftAvailable();this.getToolbar().setDraftEnabled(o1);return this._setVersionLabel(o1);};j1.prototype._setVersionLabel=function(n1){var o1=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(n1){this.getToolbar().setVersionLabel(o1.getText("LBL_DRAFT"));return this.getToolbar().setVersionLabelAccentColor(true);}var p1=V.getVersions({selector:this.getRootControlInstance(),layer:this.getLayer()});var q1=o1.getText("LBL_VERSION_1");var r1=false;if(p1.length===0){q1=o1.getText("LBL_ORIGNINAL_APP");}else if(p1[0].title){q1=p1[0].title;}else if(p1[0].versionNumber===0){r1=true;q1=o1.getText("LBL_DRAFT");}this.getToolbar().setVersionLabelAccentColor(r1);return this.getToolbar().setVersionLabel(q1);};j1.prototype._isDraftAvailable=function(){if(this._bVersioningEnabled){return V.isDraftAvailable({selector:this.getRootControlInstance(),layer:this.getLayer()});}return false;};var l1=function(n1){H.hide();var o1=n1.userMessage||n1.stack||n1.message||n1.status||n1;var p1=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");_.error("Failed to transfer changes",o1);var q1=p1.getText("MSG_LREP_TRANSFER_ERROR")+"\n"+p1.getText("MSG_ERROR_REASON",o1);z.error(q1,{styleClass:U.getRtaStyleClassName()});};j1.prototype.setCommandStack=function(n1){var o1=this.getProperty("commandStack");if(o1){o1.detachModified(this._onStackModified,this);}if(this._oInternalCommandStack){this._oInternalCommandStack.destroy();delete this._oInternalCommandStack;}var p1=this.setProperty("commandStack",n1);if(n1){n1.attachModified(this._onStackModified,this);}if(this.getPlugins()&&this.getPlugins()["settings"]){this.getPlugins()["settings"].setCommandStack(n1);}return p1;};j1.prototype.getCommandStack=function(){var n1=this.getProperty("commandStack");if(!n1){n1=new C();this._oInternalCommandStack=n1;this.setCommandStack(n1);}return n1;};j1.prototype._onStackModified=function(){var n1=this.getCommandStack();var o1=n1.canUndo();var p1=n1.canRedo();if(this.getShowToolbars()){this.getToolbar().setUndoRedoEnabled(o1,p1);this.getToolbar().setPublishEnabled(this.bInitialPublishEnabled||o1);this.getToolbar().setRestoreEnabled(this.bInitialResetEnabled||o1);if(this._bVersioningEnabled){this._handleVersionToolbar(o1);}}this.fireUndoRedoStackModified();};j1.prototype._checkToolbarAndExecuteFunction=function(n1,o1){if(this.getShowToolbars()&&this.getToolbar&&this.getToolbar()){return this.getToolbar()[n1](o1);}};j1.prototype.getSelection=function(){if(this._oDesignTime){return this._oDesignTime.getSelectionManager().get();}return[];};j1.prototype.stop=function(n1,o1){this._checkToolbarAndExecuteFunction("setBusy",true);return this._handleReloadOnExit(o1).then(function(p1){return((n1)?Promise.resolve():this._serializeToLrep(this)).then(this._checkToolbarAndExecuteFunction.bind(this,"hide")).then(function(){this.fireStop();if(p1.reloadMethod&&(p1.reloadMethod!==this._RELOAD.NOT_NEEDED)){p1.deleteMaxLayer=true;p1.triggerHardReload=(p1.reloadMethod===this._RELOAD.RELOAD_PAGE);return this._handleUrlParameterOnExit(p1);}}.bind(this));}.bind(this)).catch(l1).then(function(){this._checkToolbarAndExecuteFunction("setBusy",false);this._sStatus=e1;q("body").removeClass("sapUiRtaMode");}.bind(this));};j1.prototype.restore=function(){return this._onRestore();};j1.prototype.transport=function(){return this._onTransport();};j1.prototype.undo=function(){return this._onUndo();};j1.prototype.redo=function(){return this._onRedo();};j1.prototype.canUndo=function(){return this.getCommandStack().canUndo();};j1.prototype.canRedo=function(){return this.getCommandStack().canRedo();};j1.prototype._onKeyDown=function(n1){var o1=N.os.macintosh;var p1=O.getOverlayContainer().get(0).contains(document.activeElement);var q1=this.getShowToolbars()&&this.getToolbar().getDomRef().contains(document.activeElement);var r1=false;q(".sapUiDtContextMenu").each(function(v1,w1){if(w1.contains(document.activeElement)){r1=true;}});var s1=document.body===document.activeElement;var t1=q(document.activeElement).parents('.sapUiRtaEditableField').length>0;if((p1||q1||r1||s1)&&!t1){var u1=o1?n1.metaKey:n1.ctrlKey;if(n1.keyCode===a1.Z&&n1.shiftKey===false&&n1.altKey===false&&u1===true){this._onUndo().then(n1.stopPropagation.bind(n1));}else if(((o1&&n1.keyCode===a1.Z&&n1.shiftKey===true)||(!o1&&n1.keyCode===a1.Y&&n1.shiftKey===false))&&n1.altKey===false&&u1===true){this._onRedo().then(n1.stopPropagation.bind(n1));}}};j1.prototype._onUnload=function(){var n1=this.getCommandStack();var o1=n1.canUndo()||n1.canRedo();if(o1&&this.getShowWindowUnloadDialog()){var p1=this._getTextResources().getText("MSG_UNSAVED_CHANGES");return p1;}window.onbeforeunload=this._oldUnloadHandler;};j1.prototype._serializeAndSave=function(){return this._oSerializer.saveCommands(this._bVersioningEnabled);};j1.prototype._serializeToLrep=function(){if(!this._bReloadNeeded){return this._oSerializer.needsReload().then(function(n1){this._bReloadNeeded=n1;return this._serializeAndSave();}.bind(this));}return this._serializeAndSave();};j1.prototype._onUndo=function(){this._handleStopCutPaste();return this.getCommandStack().undo();};j1.prototype._onRedo=function(){this._handleStopCutPaste();return this.getCommandStack().redo();};j1.prototype._onActivateDraft=function(n1){var o1=this.getLayer();var p1=this.getRootControlInstance();return V.activateDraft({layer:o1,selector:p1,title:n1.getParameter("versionTitle")}).then(function(){this._showMessageToast("MSG_DRAFT_ACTIVATION_SUCCESS");this.bInitialResetEnabled=true;this.getToolbar().setRestoreEnabled(true);this.getCommandStack().removeAllCommands();return this._handleVersionToolbar(false);}.bind(this)).catch(function(q1){U.showMessageBox("error","MSG_DRAFT_ACTIVATION_FAILED",{error:q1});});};j1.prototype._handleDiscard=function(){var n1=this.getLayer();j1.enableRestart(n1,this.getRootControlInstance());if(!t.getUshellContainer()){var o1={hasDraftChanges:w.hasVersionParameterWithValue({value:n1}),layer:n1};this.getCommandStack().removeAllCommands();return this._triggerHardReload(o1);}var p1=true;var q1=this._removeVersionParameterForFLP(t.getParsedURLHash(),p1);this.getCommandStack().removeAllCommands();this._triggerCrossAppNavigation(q1);return this.stop(true,true);};j1.prototype._onDiscardDraft=function(){return U.showMessageBox("warning","MSG_DRAFT_DISCARD_DIALOG",{actions:[z.Action.OK,z.Action.CANCEL],emphasizedAction:z.Action.OK}).then(function(n1){if(n1===z.Action.OK){return V.discardDraft({layer:this.getLayer(),selector:this.getRootControlInstance(),updateState:true}).then(this._handleDiscard.bind(this));}}.bind(this));};j1.prototype._createToolsMenu=function(n1){if(!this.getDependent('toolbar')){var o1;if(this.getLayer()===v.USER){o1=P;}else if(U.getFiori2Renderer()){o1=F;}else{o1=S;}if(this.getLayer()===v.USER){this.addDependent(new o1({textResources:this._getTextResources(),exit:this.stop.bind(this,false,true),restore:this._onRestore.bind(this)}),'toolbar');}else{this.addDependent(new o1({modeSwitcher:this.getMode(),publishVisible:n1.publishAvailable,textResources:this._getTextResources(),versioningVisible:this._bVersioningEnabled,draftEnabled:n1.draftAvailable,exit:this.stop.bind(this,false,false),transport:this._onTransport.bind(this),restore:this._onRestore.bind(this),undo:this._onUndo.bind(this),redo:this._onRedo.bind(this),modeChange:this._onModeChange.bind(this),manageApps:K.onGetOverview.bind(null,true,this.getLayer()),appVariantOverview:this._onGetAppVariantOverview.bind(this),saveAs:K.onSaveAs.bind(K,true,true,this.getLayer(),null),activateDraft:this._onActivateDraft.bind(this),discardDraft:this._onDiscardDraft.bind(this)}),'toolbar');}this.getToolbar().setPublishEnabled(this.bInitialPublishEnabled);this.getToolbar().setRestoreEnabled(this.bInitialResetEnabled);var p1=n1.publishAppVariantSupported;this.getToolbar().setAppVariantsVisible(p1);var q1=p1&&K.isOverviewExtended();this.getToolbar().setExtendedManageAppVariants(q1);if(p1){K.isManifestSupported().then(function(r1){this.getToolbar().setAppVariantsEnabled(r1);}.bind(this));}}};j1.prototype._onGetAppVariantOverview=function(n1){var o1=n1.getParameter("item");var p1=o1.getId()==='keyUser';return K.onGetOverview(p1,this.getLayer());};j1.prototype.destroy=function(){q.map(this._dependents,function(n1,o1){this.removeDependent(o1);n1.destroy(true);}.bind(this));Object.keys(this._mServices).forEach(function(n1){this.stopService(n1);},this);if(this._oDesignTime){this._oDesignTime.destroy();this._oDesignTime=null;q(document).off("keydown",this.fnKeyDown);this._destroyDefaultPlugins();this.setPlugins(null);}if(this._$RootControl){this._$RootControl.removeClass("sapUiRtaRoot");}this.setCommandStack(null);if(this._oServiceEventBus){this._oServiceEventBus.destroy();}if(N.browser.name==="ff"){q(document).off("contextmenu",k1);}window.onbeforeunload=this._oldUnloadHandler;M.prototype.destroy.apply(this,arguments);};j1.prototype._onTransport=function(){this._handleStopCutPaste();H.show(500);return this._serializeToLrep().then(function(){H.hide();var n1=t.isApplicationVariant(this._oRootControl)&&!t.isVariantByStartupParameter(this._oRootControl);return((n1)?K.getAppVariantDescriptor(this._oRootControl):Promise.resolve()).then(function(o1){var p1=[];if(o1){p1.push(o1);}return y.publish({selector:this.getRootControlInstance(),styleClass:U.getRtaStyleClassName(),layer:this.getLayer(),appVariantDescriptors:p1}).then(function(q1){if(q1!=="Error"&&q1!=="Cancel"){this._showMessageToast("MSG_TRANSPORT_SUCCESS");if(this.getShowToolbars()){var r1={selector:this.getRootControlInstance(),layer:this.getLayer()};y.getResetAndPublishInfo(r1).then(function(s1){this.getToolbar().setPublishEnabled(s1.isPublishEnabled);this.getToolbar().setRestoreEnabled(s1.isResetEnabled);}.bind(this));}}}.bind(this));}.bind(this));}.bind(this))['catch'](l1);};j1.prototype._deleteChanges=function(){var n1=this.getLayer();return y.reset({selector:t.getAppComponentForControl(this.getRootControlInstance()),layer:n1,generator:"Change.createInitialFileContent"}).then(function(){var o1={hasDraftChanges:w.hasVersionParameterWithValue({value:n1}),layer:n1,deleteMaxLayer:false,triggerHardReload:true};return this._handleUrlParameterOnExit(o1);}.bind(this)).catch(function(o1){if(o1!=="cancel"){U.showMessageBox("error","MSG_RESTORE_FAILED",{error:o1});}});};j1.prototype._reloadPage=function(){window.location.reload();};j1.prototype._showMessageToast=function(n1){var o1=this._getTextResources().getText(n1);B.show(o1);};j1.needsRestart=function(n1){var o1=!!window.sessionStorage.getItem("sap.ui.rta.restart."+n1);return o1;};j1.enableRestart=function(n1,o1){var p1=t.getComponentClassName(o1);var q1=p1||true;window.sessionStorage.setItem("sap.ui.rta.restart."+n1,q1);};j1.disableRestart=function(n1){window.sessionStorage.removeItem("sap.ui.rta.restart."+n1);};j1.prototype._onRestore=function(){var n1=this.getLayer();var o1=n1===v.USER?this._getTextResources().getText("FORM_PERS_RESET_MESSAGE_PERSONALIZATION"):this._getTextResources().getText("FORM_PERS_RESET_MESSAGE");var p1=n1===v.USER?this._getTextResources().getText("BTN_RESTORE"):this._getTextResources().getText("FORM_PERS_RESET_TITLE");this._handleStopCutPaste();return U.showMessageBox("warning",o1,{titleKey:p1,actions:[z.Action.OK,z.Action.CANCEL],emphasizedAction:z.Action.OK}).then(function(q1){if(q1===z.Action.OK){j1.enableRestart(n1,this.getRootControlInstance());this._deleteChanges();this.getCommandStack().removeAllCommands();}}.bind(this));};j1.prototype._scheduleOnCreated=function(n1,o1){function p1(q1){var r1=q1.getParameter("elementOverlay");if(r1.getElement().getId()===n1){this._oDesignTime.detachEvent("elementOverlayCreated",p1,this);o1(r1);}}this._oDesignTime.attachEvent("elementOverlayCreated",p1,this);};j1.prototype._scheduleOnCreatedAndVisible=function(n1,o1){function p1(r1){var s1=r1.getSource();if(s1.getGeometry()&&s1.getGeometry().visible){s1.detachEvent("geometryChanged",p1);o1(s1);}}function q1(r1){if(!r1.getGeometry()||!r1.getGeometry().visible){r1.attachEvent('geometryChanged',p1);}else{o1(r1);}}this._scheduleOnCreated(n1,function(r1){if(r1.isRendered()){q1(r1);}else{r1.attachEventOnce('afterRendering',function(s1){q1(s1.getSource());});}});};j1.prototype._scheduleRenameOnCreatedContainer=function(n1,o1){var p1=function(q1){q1.setSelected(true);this.getPlugins()["rename"].startEdit(q1);}.bind(this);this._scheduleOnCreatedAndVisible(o1,function(q1){var r1=this.getPlugins()["createContainer"].getCreatedContainerId(n1,q1.getElement().getId());var s1=X.getOverlay(r1);if(s1){p1(s1);}else{this._scheduleOnCreatedAndVisible(r1,p1);}}.bind(this));};j1.prototype._handleElementModified=function(n1){this._handleStopCutPaste();var o1=n1.getParameter("action");var p1=n1.getParameter("newControlId");var q1=n1.getParameter("command");if(q1 instanceof sap.ui.rta.command.BaseCommand){if(p1){this._scheduleOnCreated(p1,function(r1){var s1=r1.getDesignTimeMetadata();var t1=s1.getData().select;if(typeof t1==="function"){t1(r1.getElement());}});if(o1){this._scheduleRenameOnCreatedContainer(o1,p1);}}return this.getCommandStack().pushAndExecute(q1).catch(function(r1){if(r1&&r1.message&&r1.message.indexOf("The following Change cannot be applied because of a dependency")>-1){U.showMessageBox("error","MSG_DEPENDENCY_ERROR",{error:r1});}_.error("sap.ui.rta: "+r1.message);});}return Promise.resolve();};j1.prototype._onElementEditableChange=function(n1){var o1=n1.getParameter("editable");if(o1){this.iEditableOverlaysCount+=1;}else{this.iEditableOverlaysCount-=1;}};j1.prototype._handleStopCutPaste=function(){if(this.getPlugins()["cutPaste"]){this.getPlugins()["cutPaste"].stopCutAndPaste();}};j1.prototype._buildNavigationArguments=function(n1){return{target:{semanticObject:n1.semanticObject,action:n1.action,context:n1.contextRaw},params:n1.params,appSpecificRoute:n1.appSpecificRoute,writeHistory:false};};j1.prototype._triggerCrossAppNavigation=function(n1){if(this.getLayer()!==v.USER){return t.ifUShellContainerThen(function(o1){o1[0].toExternal(this._buildNavigationArguments(n1));return Promise.resolve(true);}.bind(this),["CrossApplicationNavigation"]);}};j1.prototype._removeVersionParameterForFLP=function(n1,o1){var p1=this.getLayer();if(p1===v.USER){return n1;}if(w.hasVersionParameterWithValue({value:p1})){delete n1.params[u.FL_VERSION_PARAM];}else if(w.hasVersionParameterWithValue({value:"false"})){delete n1.params[u.FL_VERSION_PARAM];}else if(this._isDraftAvailable()||o1){n1.params[u.FL_VERSION_PARAM]=["false"];}return n1;};j1.prototype._removeMaxLayerParameterForFLP=function(n1,o1){if(n1.deleteMaxLayer&&n1.hasHigherLayerChanges){delete o1.params[u.FL_MAX_LAYER_PARAM];}return o1;};j1.prototype._handleUrlParameterOnExit=function(n1){if(!t.getUshellContainer()){return this._triggerHardReload(n1);}var o1=t.getParsedURLHash();if(!o1){return;}o1=this._removeMaxLayerParameterForFLP(n1,o1);o1=this._removeVersionParameterForFLP(o1);this._triggerCrossAppNavigation(o1);if(n1.triggerHardReload){this._triggerHardReload(n1);}};j1.prototype._getReloadMessageOnStart=function(n1){var o1;var p1=n1.layer===v.CUSTOMER;if(n1.hasHigherLayerChanges&&n1.hasDraftChanges){o1=p1?"MSG_PERSONALIZATION_AND_DRAFT_EXISTS":"MSG_HIGHER_LAYER_CHANGES_AND_DRAFT_EXISTS";}else if(n1.hasHigherLayerChanges){o1=p1?"MSG_PERSONALIZATION_EXISTS":"MSG_HIGHER_LAYER_CHANGES_EXIST";}else if(n1.hasDraftChanges){o1="MSG_DRAFT_EXISTS";}return o1;};j1.prototype._getReloadMessageOnExit=function(n1){var o1;var p1=n1.layer===v.CUSTOMER;if(n1.hasHigherLayerChanges&&n1.hasDraftChanges){o1=p1?"PERSONALIZATION_AND_WITHOUT_DRAFT":"MSG_RELOAD_WITH_ALL_CHANGES";}else if(n1.hasHigherLayerChanges){o1=p1?"MSG_RELOAD_WITH_PERSONALIZATION":"MSG_RELOAD_WITH_ALL_CHANGES";}else if(n1.initialDraftGotActivated){o1="MSG_RELOAD_ACTIVATED_DRAFT";}else if(n1.hasDraftChanges){o1="MSG_RELOAD_WITHOUT_DRAFT";}else if(n1.changesNeedReload){o1="MSG_RELOAD_NEEDED";}return o1;};j1.prototype._handleReloadMessageBoxOnExit=function(n1){var o1=this._getReloadMessageOnExit(n1);if(o1){return U.showMessageBox("information",o1,{titleKey:"HEADER_RELOAD_NEEDED"});}return Promise.resolve();};j1.prototype._triggerReloadOnStart=function(n1){t.ifUShellContainerThen(function(){V.loadDraftForApplication({selector:n1.selector,layer:n1.layer});},["CrossApplicationNavigation"]);var o1=this._getReloadMessageOnStart(n1);if(!o1){return Promise.resolve();}return U.showMessageBox("information",o1).then(function(){j1.enableRestart(n1.layer);if(t.getUshellContainer()){var p1=w.handleParametersOnStart(n1);return this._triggerCrossAppNavigation(p1);}return this._triggerHardReload(n1);}.bind(this));};j1.prototype._determineReload=function(){var n1={hasHigherLayerChanges:false,hasDraftChanges:false,layer:this.getLayer(),selector:this.getRootControlInstance(),ignoreMaxLayerParameter:false};return w.getReloadReasonsForStart(n1).then(function(n1){if(n1.hasHigherLayerChanges||n1.hasDraftChanges){return this._triggerReloadOnStart(n1);}}.bind(this));};j1.prototype._triggerHardReload=function(n1){n1.parameters=document.location.search;var o1=w.handleUrlParametersForStandalone(n1);if(document.location.search!==o1){document.location.search=o1;return Promise.resolve();}return this._reloadPage();};j1.prototype._handleReloadOnExit=function(n1){if(n1){return Promise.resolve({reloadMethod:this._RELOAD.NOT_NEEDED});}return Promise.all([(!this._bReloadNeeded)?this._oSerializer.needsReload():Promise.resolve(this._bReloadNeeded)]).then(function(o1){var p1={layer:this.getLayer(),selector:this.getRootControlInstance(),changesNeedReload:o1[0],hasDirtyDraftChanges:this._bVersioningEnabled&&this.canUndo(),versioningEnabled:this._bVersioningEnabled};p1=w.getReloadMethod(p1);return this._handleReloadMessageBoxOnExit(p1).then(function(){return p1;});}.bind(this));};j1.prototype._onModeChange=function(n1){this.setMode(n1.getParameter("item").getKey());};j1.prototype.setMode=function(n1){if(this.getProperty('mode')!==n1){var o1=this.getShowToolbars()&&this.getToolbar().getControl('modeSwitcher');var p1=n1==='adaptation';if(o1){o1.setSelectedButton(o1.getItems().filter(function(q1){return q1.getKey()===n1;}).pop().getId());}this._oDesignTime.setEnabled(p1);this.getPlugins()['tabHandling'][p1?'removeTabIndex':'restoreTabIndex']();this.setProperty('mode',n1);this.fireModeChanged({mode:n1});}};j1.prototype.setMetadataScope=function(n1){if(this._oDesignTime){_.error("sap.ui.rta: Failed to set metadata scope on RTA instance after RTA is started");return;}this.setProperty('metadataScope',n1);};function m1(n1){if(Q.hasOwnProperty(n1)){return Q[n1].replace(/\./g,'/');}}j1.prototype.startService=function(n1){if(this._sStatus!==d1){return new Promise(function(q1,r1){this.attachEventOnce('start',q1);this.attachEventOnce('failed',r1);}.bind(this)).then(function(){return this.startService(n1);}.bind(this),function(){return Promise.reject(s.createError("RuntimeAuthoring#startService",s.printf("Can't start the service '{0}' while RTA has been failed during a startup",n1),"sap.ui.rta"));});}var o1=m1(n1);var p1;if(!o1){return Promise.reject(s.createError("RuntimeAuthoring#startService",s.printf("Unknown service. Can't find any registered service by name '{0}'",n1),"sap.ui.rta"));}p1=this._mServices[n1];if(p1){switch(p1.status){case h1:{return Promise.resolve(p1.exports);}case g1:{return p1.initPromise;}case i1:{return p1.initPromise;}default:{return Promise.reject(s.createError("RuntimeAuthoring#startService",s.printf("Unknown service status. Service name = '{0}'",n1),"sap.ui.rta"));}}}else{this._mServices[n1]=p1={status:g1,location:o1,initPromise:new Promise(function(q1,r1){sap.ui.require([o1],function(s1){p1.factory=s1;if(!this._oServiceEventBus){this._oServiceEventBus=new W();}s.wrapIntoPromise(s1)(this,this._oServiceEventBus.publish.bind(this._oServiceEventBus,n1)).then(function(t1){if(this.bIsDestroyed){throw s.createError("RuntimeAuthoring#startService",s.printf("RuntimeAuthoring instance is destroyed while initialising the service '{0}'",n1),"sap.ui.rta");}if(!q.isPlainObject(t1)){throw s.createError("RuntimeAuthoring#startService",s.printf("Invalid service format. Service should return simple javascript object after initialisation. Service name = '{0}'",n1),"sap.ui.rta");}p1.service=t1;p1.exports={};if(Array.isArray(t1.events)&&t1.events.length>0){q.extend(p1.exports,{attachEvent:this._oServiceEventBus.subscribe.bind(this._oServiceEventBus,n1),detachEvent:this._oServiceEventBus.unsubscribe.bind(this._oServiceEventBus,n1),attachEventOnce:this._oServiceEventBus.subscribeOnce.bind(this._oServiceEventBus,n1)});}var u1=t1.exports||{};q.extend(p1.exports,Object.keys(u1).reduce(function(v1,w1){var x1=u1[w1];v1[w1]=typeof x1==="function"?s.waitForSynced(this._oDesignTime,x1):x1;return v1;}.bind(this),{}));p1.status=h1;q1(Object.freeze(p1.exports));}.bind(this)).catch(r1);}.bind(this),function(s1){p1.status=i1;r1(s.propagateError(s1,"RuntimeAuthoring#startService",s.printf("Can't load service '{0}' by its name: {1}",n1,o1),"sap.ui.rta"));});}.bind(this)).catch(function(q1){p1.status=i1;return Promise.reject(s.propagateError(q1,"RuntimeAuthoring#startService",s.printf("Error during service '{0}' initialisation.",n1),"sap.ui.rta"));})};return p1.initPromise;}};j1.prototype.stopService=function(n1){var o1=this._mServices[n1];if(o1){if(o1.status===h1){if(typeof o1.service.destroy==="function"){o1.service.destroy();}}delete this._mServices[n1];}else{throw s.createError("RuntimeAuthoring#stopService",s.printf("Can't destroy service: unable to find service with name '{0}'",n1),"sap.ui.rta");}};j1.prototype.getService=function(n1){return this.startService(n1);};return j1;});

/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/dt/ElementUtil","sap/base/Log","sap/base/util/ObjectPath","sap/ui/rta/util/BindingsExtractor"],function(q,E,L,O,B){"use strict";function _(P,j,Q,R,S){var T={name:P.name,bindingPath:P.name,entityType:j.name};var U=P["com.sap.vocabularies.Common.v1.Label"];T.label=U&&U.String;var V=P["com.sap.vocabularies.Common.v1.QuickInfo"];T.tooltip=V&&V.String;var W=P["com.sap.vocabularies.UI.v1.Hidden"];T.unsupported=!!W&&W.Bool==="true";var X;if(!T.unsupported){X=P["com.sap.vocabularies.Common.v1.FieldControl"];if(X&&X.EnumMember){T.unsupported=X.EnumMember==="com.sap.vocabularies.Common.v1.FieldControlType/Hidden";}else{var Y=X&&X.Path;if(Y){var Z=Q.getBinding(R)instanceof sap.ui.model.ListBinding;if(!Z){var $=Q.getBindingContext(S).getProperty(Y);T.unsupported=$===0;}}}}return T;}function a(P){if(P&&P.type){if(P.type.toLowerCase().indexOf("edm")!==0){return true;}}return false;}function b(j,P,Q){if(!j){return false;}var R=j.getBindingInfo(P,Q);var S=R&&R.path;if(!S){return false;}if(S.indexOf(">")>-1){S=S.split(">").pop();}return S.indexOf("/")===0;}function c(j,P,Q,R){var S;if(P){S=j.getBindingInfo(Q,R);if(typeof S.model==="string"&&S.model!==R){S=undefined;}}else{S=j.getBindingContext(R);}return S;}function d(j,P,Q){var R=b(j,P,Q);var S=c(j,R,P,Q);if(S){return R?S.path:S.getPath();}}function e(j,P,Q,R,S){var T=j.property.map(function(V){var W=_(V,j,Q,R,S);if(a(V)){var X=P.getODataComplexType(V.type);if(X){W.properties=X.property.map(function(Y){var Z=_(Y,j,Q,R,S);Z.bindingPath=V.name+"/"+Y.name;return Z;});}}return W;});if(j.navigationProperty){var U=j.navigationProperty.map(function(V){var W=(P.getODataAssociationEnd(j,V.name)&&P.getODataAssociationEnd(j,V.name).type);return{name:V.name,entityType:W,bindingPath:V.name,unsupported:true};});T=T.concat(U);}return T;}function f(P){var j=P.reduce(function(Q,R){if(Array.isArray(R.properties)){Q=Q.concat(R.properties.map(function(S){S.parentPropertyName=R.label||R.name;return S;}));}else{Q.push(R);}return Q;},[]);return j;}function g(j){return Promise.resolve().then(function(){var P=j.getModel();if(P){var Q=P.getMetadata().getName();if(Q==="sap.ui.model.odata.ODataModel"||Q==="sap.ui.model.odata.v2.ODataModel"){var R=P.getMetaModel();return R.loaded().then(function(){return R;});}}});}function h(j,P){var Q=j.getMetaContext(P);return Q.getObject();}function i(j,P,Q){var R=j.getMetadata().getAggregation();if(R){var S=j.getBindingInfo(R.name);var T=S&&S.template;if(T){var U=j.getBindingPath(R.name);var V=P.getODataAssociationEnd(Q,U);var W=V&&V.type;if(W){var X=P.getODataEntityType(W);Q=X;}}}return Q;}function k(j,P){return g(j).then(function(Q){var R=[];if(Q){var S=d(j,P);if(S){var T=h(Q,S);T=i(j,Q,T);R=e(T,Q,j,P);}}return R;}).then(f);}function l(j,P,Q){var R={element:j,aggregationName:P,payload:Q.delegateInfo.payload||{}};return Q.delegateInfo.delegate.getPropertyInfo(R).then(f);}function m(j,P,Q){var R=Q.addODataProperty;var S=Q.addViaDelegate;var T;if(S){T=l.bind(null,j,P,S);}else if(R){T=k.bind(null,j,P);}else{T=Promise.resolve.bind(Promise,[]);}return T().then(function(U){return t(U);});}function n(P){return P.filter(function(j){return!j.unsupported;});}function o(P,j){j.type="custom";if(j.id){j.itemId=P+"-"+j.id;j.key=j.itemId;}return j;}function p(T,P){return{selected:false,label:P.label||P.name,parentPropertyName:P.parentPropertyName?P.parentPropertyName:"",duplicateName:P.duplicateName?P.duplicateName:false,tooltip:P.tooltip||P.label,originalLabel:"",type:T,entityType:P.entityType,name:P.name,bindingPath:P.bindingPath};}function r(j){var P=j.element;var Q=j.action;return{selected:false,label:P.__label||E.getLabelForElement(P,Q.getLabel),tooltip:P.__tooltip||E.getLabelForElement(P,Q.getLabel)||P.__bindingPath,parentPropertyName:P.__parentPropertyName?P.__parentPropertyName:"",duplicateName:P.__duplicateName?P.__duplicateName:false,originalLabel:P.__renamedLabel&&P.__label!==P.__originalLabel?P.__originalLabel:"",bindingPath:P.__bindingPath,type:"invisible",elementId:P.getId()};}function s(j,R,P,Q){if(R&&R!==j){var S=d(j,P,Q);return E.findAllSiblingsInContainer(j,R).filter(function(T){return S===d(T,P,Q);});}return[j];}function t(P){P.forEach(function(Q,R,P){if(Q["duplicateName"]!==true){for(var j=R+1;j<P.length-1;j++){if(Q.label===P[j].label){Q["duplicateName"]=true;P[j]["duplicateName"]=true;}}}});return P;}function u(j,P){return P.some(function(Q){return Q.label===j.__label;});}function v(j){return Array.isArray(j)&&j.length>0;}function w(j,P){return P.filter(function(Q){return j.some(function(R){return R.startsWith(Q.bindingPath);});}).pop();}function x(j){return(q.isPlainObject(j)?j.parts[0].path:!!j.getPath&&j.getPath());}function y(j,P,Q,R){var S=j.getModel(Q);var T=s(j,P.relevantContainer,R,Q);var U=[];T.forEach(function(j){U=U.concat(B.getBindings(j,S).map(x));});return U;}function z(j,P){var Q={element:j.relevantContainer,aggregationName:P,payload:j.delegateInfo.payload||{}};return j.delegateInfo.delegate.getRepresentedProperties(Q);}function A(j,P,Q,R){return z(P,R).then(function(S){if(S===undefined){return y(j,P,Q,R);}var T=[];S.forEach(function(U){T=T.concat(U.bindingPaths);});return T;});}function C(j,P,Q,R){return Promise.resolve().then(function(){var S=!!O.get("delegateInfo.delegate.getRepresentedProperties",P);if(S){return A(j,P,Q,R);}return y(j,P,Q,R);});}function D(j,P,Q,R,T){var S=j.getMetadata().getAggregation();var U=S?S.name:P.action.aggregation;return Promise.all([R(j,U,P),C(j,P,Q,U)]).then(function(V){var W=V[0];var X=V[1];var Y=P.action.filter?P.action.filter:function(){return true;};var Z=n(W);Z=Z.filter(function($){var a1=false;if(X){a1=X.some(function(b1){return b1===$.bindingPath;});}return!a1&&Y(P.relevantContainer,$);});Z=t(Z);return Z;}).then(function(V){return V.map(p.bind(null,T));});}function F(j,S){j.__originalLabel=S.label;j.__tooltip=S.tooltip;j.__bindingPath=S.name;if(j.__label!==j.__originalLabel){j.__renamedLabel=true;}if(S.parentPropertyName){j.__parentPropertyName=S.parentPropertyName;}}function G(j,P){var Q=!!O.get("delegateInfo.delegate.getRepresentedProperties",j);if(Q){return z(j,P);}}function H(j,R){var P;R.some(function(Q){if(Q.id===j.getId()){P=Q;return true;}});return P.bindingPaths||[];}function I(j,P,Q){if(!v(Q)){return true;}var R=w(Q,P);if(R){F(j,R);return true;}return false;}function J(j,P,Q,R,S,T){var U=R.addODataProperty;var V=R.addViaDelegate;var W=M(V);var X=j.getModel(W);var Y=true;var Z=[];if(U||V){if(V&&S){Z=H(Q,S);}else if(d(j,P,W)===d(Q,P,W)){Z=B.collectBindingPaths(Q,X).bindingPaths;}else if(B.getBindings(Q,X).length>0){Y=false;}if(Y){Q.__duplicateName=u(Q,T);Y=I(Q,T,Z);}}return Y;}function K(j,P,Q,R){var S=P.addViaCustom;if(S&&Q){S.items.forEach(function(T){o(R.getParent().getId(),T);if(T.itemId===j.getId()){F(j,T);}});}}function M(j){return O.get("delegateInfo.payload.modelName",j);}var N={enhanceInvisibleElements:function(j,P){var R=P.reveal;var Q=P.addViaDelegate;var S=j.getMetadata().getAggregation();var T=S?S.name:P.aggregation;return Promise.all([m(j,T,P),G(Q,T)]).then(function(U){var V=U[0];var W=U[1];var X=[];var Y=R.elements||[];Y.forEach(function(Z){var $=Z.element;var a1=Z.action;$.__label=E.getLabelForElement($,a1.getLabel);var b1=J(j,T,$,P,W,V);K($,P,b1,j);if(b1){X.push({element:$,action:a1});}});return X;}).then(function(U){return U.map(r);});},getUnboundODataProperties:function(j,P){return D(j,P,undefined,k,"odata");},getUnrepresentedDelegateProperties:function(j,P){var Q=M(P);return D(j,P,Q,l,"delegate");},getCustomAddItems:function(j,P){return new Promise(function(R){if(Array.isArray(P.items)){R(P.items.map(o.bind(null,j.getParent().getId())).filter(function(Q){if(!Q.id){L.error("CustomAdd item with label "+Q.label+" does not contain an 'id' property","sap.ui.rta.plugin.AdditionalElementsAnalyzer#showAvailableElements");return false;}return!E.getElementInstance(Q.itemId);}));}else{R();}});},getFilteredItemsList:function(j){var P=j[0];var Q=2;var R=j[Q];if(R){var S=P.map(function(T){return T.elementId;});j[Q]=R.filter(function(T){return!T.itemId||S.indexOf(T.itemId)===-1;});}return j.reduce(function(T,U){return T.concat(U);},[]);}};return N;});

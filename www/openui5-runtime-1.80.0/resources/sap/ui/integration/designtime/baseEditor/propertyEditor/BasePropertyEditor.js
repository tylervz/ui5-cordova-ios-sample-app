/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Control","./../util/isTemplate","sap/ui/model/json/JSONModel","sap/m/Label","sap/ui/core/Fragment","sap/base/util/restricted/_merge","sap/ui/base/ManagedObjectObserver","sap/ui/integration/designtime/baseEditor/util/createPromise","sap/base/util/deepClone","sap/base/util/deepEqual","sap/base/util/each"],function(C,i,J,L,F,_,M,c,d,a,e){"use strict";var B=C.extend("sap.ui.integration.designtime.baseEditor.propertyEditor.BasePropertyEditor",{metadata:{interfaces:["sap.ui.core.IFormContent"],properties:{"renderLabel":{type:"boolean",defaultValue:true},"value":{type:"any"},"config":{type:"object"}},aggregations:{"_label":{type:"sap.m.Label",visibility:"hidden",multiple:false},"content":{type:"sap.ui.core.Control",multiple:false}},events:{beforeValueChange:{parameters:{path:{type:"string"},value:{type:"any"},nextValue:{type:"any"}}},valueChange:{parameters:{path:{type:"string"},value:{type:"any"},previousValue:{type:"any"}}},configChange:{parameters:{previousConfig:{type:"object"},config:{type:"object"}}},fragmentChange:{parameters:{previousFragment:{type:"string"},fragment:{type:"string"}}},ready:{},init:{}}},xmlFragment:null,_currentXmlFragment:null,_bFragmentReady:false,constructor:function(){this._iExpectedWrapperCount=0;this._currentXmlFragment=this.xmlFragment;C.prototype.constructor.apply(this,arguments);this._oDefaultModel=new J({value:this.getValue(),config:this.getConfig(),displayValue:this._formatValue(this.getValue())});this._oDefaultModel.setDefaultBindingMode("OneWay");this.setBindingContext(this._oDefaultModel.getContext("/"));this.setModel(this._oDefaultModel);this.bindProperty("visible","config/visible");this._setReady(false);this._aEditorWrappers=[];this._bInitFinished=false;this.attachBeforeValueChange(function(E){this._iExpectedWrapperCount=this.getExpectedWrapperCount(E.getParameter("nextValue"));},this);this.attachValueChange(function(E){var v=E.getParameter("value");this._oDefaultModel.setData(Object.assign({},this._oDefaultModel.getData(),{value:v,displayValue:this._formatValue(v)}));this._checkReadyState();},this);this.attachConfigChange(function(E){this._oDefaultModel.setData(Object.assign({},this._oDefaultModel.getData(),{config:E.getParameter("config")}));},this);this.asyncInit().then(function(){this._bInitFinished=true;this.fireInit();this._checkReadyState();}.bind(this));if(this.getFragment()){this._initFragment(this.getFragment());}},renderer:function(r,p){r.openStart("div",p);r.addStyle("display","inline-block");r.addStyle("width","100%");r.openEnd();if(p.getRenderLabel()&&p.getLabel()){r.openStart("div");r.openEnd();r.renderControl(p.getLabel());r.close("div");}r.renderControl(p.getContent());r.close("div");}});B.prototype.init=function(){this.attachFragmentChange(function(E){if(this.getContent()){this.getContent().destroy();}var f=E.getParameter("fragment");this._initFragment(f);},this);};B.prototype.asyncInit=function(){return Promise.resolve();};B.prototype.onFragmentReady=function(){};B.prototype.setValue=function(v){var b=this.getValue();var o=this.getConfig()||{};var n=v;if(typeof n==="undefined"&&typeof o.defaultValue!=="undefined"){n=d(o.defaultValue);}if(!a(n,b)){this.fireBeforeValueChange({path:o.path,value:b,nextValue:n});this.setProperty("value",n);this.fireValueChange({path:o.path,previousValue:b,value:n});}};B.prototype._formatValue=function(v){return this.formatValue(d(v));};B.prototype.formatValue=function(v){return v;};B.prototype.getExpectedWrapperCount=function(){return 0;};B.prototype._checkReadyState=function(){if(this._mWrapperReadyCheck){this._mWrapperReadyCheck.cancel();}if(!this._bInitFinished){this._setReady(false);return;}if(!this._bFragmentReady){this._setReady(false);return;}if(this._iExpectedWrapperCount===0){this._setReady(true);return;}if(this._iExpectedWrapperCount===this._aEditorWrappers.length){if(this._aEditorWrappers.every(function(w){return w.isReady();})){this._setReady(true);}else{this._setReady(false);this._mWrapperReadyCheck=c(function(r){Promise.all(this._aEditorWrappers.map(function(w){return w.ready();})).then(r);}.bind(this));this._mWrapperReadyCheck.promise.then(function(){this._setReady(true);delete this._mWrapperReadyCheck;}.bind(this));}}else{this._setReady(false);}};B.prototype.wrapperInit=function(E){if(!this._oWrapperObserver){this._oWrapperObserver=new M(function(m){var o=m.object;switch(m.type){case'destroy':this._aEditorWrappers=this._aEditorWrappers.filter(function(b){return b!==o;});this._checkReadyState();break;case'parent':if(!i(o,this)){this._oWrapperObserver.unobserve(o);this._registerWrapper(o);}break;default:return;}}.bind(this));}var w=E.getSource();if(i(w,this)){this._oWrapperObserver.observe(w,{parent:true});return;}this._registerWrapper(w);};B.prototype._registerWrapper=function(w){this._aEditorWrappers.push(w);w.attachReady(function(){this._setReady(false);this._checkReadyState();}.bind(this));this._oWrapperObserver.observe(w,{destroy:true});this._checkReadyState();};B.prototype._setReady=function(r){var p=this._bIsReady;this._bIsReady=r;if(p!==true&&r===true){this.fireReady();}};B.prototype.isReady=function(){return!!this._bIsReady;};B.prototype.ready=function(){return new Promise(function(r){if(this.isReady()){r();}else{this.attachEventOnce("ready",r);}}.bind(this));};B.prototype.setFragment=function(f,g){if(this._currentXmlFragment!==f){var p=this._currentXmlFragment;this._currentXmlFragment=f;if(typeof g==='function'){this.getExpectedWrapperCount=g;}this.fireFragmentChange({previousFragment:p,fragment:f});}};B.prototype.getFragment=function(){return this._currentXmlFragment;};B.prototype._initFragment=function(f){this._setReady(false);this._bFragmentReady=false;if(this._fnCancelFragmentLoading){this._fnCancelFragmentLoading();}var o=c(function(r,R){this._loadFragment(f).then(r,R);}.bind(this));this._fnCancelFragmentLoading=o.cancel;return o.promise.then(function(b){delete this._fnCancelFragmentLoading;this._bFragmentReady=true;this.setContent(b);this.onFragmentReady();this._checkReadyState();}.bind(this));};B.prototype._loadFragment=function(f){return F.load({name:f,controller:this});};B.prototype.clone=function(){this.destroyContent();return C.prototype.clone.apply(this,arguments);};B.prototype.exit=function(){this._oDefaultModel.destroy();if(this._oConfigBinding){this._oConfigBinding.destroy();}if(this._oWrapperObserver){this._oWrapperObserver.destroy();}if(this._fnCancelFragmentLoading){this._fnCancelFragmentLoading();}};B.prototype.getConfigMetadata=function(){return{visible:{defaultValue:true}};};B.prototype.setConfig=function(o){var p=this.getConfig();var D={};e(this.getConfigMetadata(),function(s,m){D[s]=m.defaultValue;});var n=Object.assign({},D,o);n=this.onBeforeConfigChange(n);if(!a(p,n)){this.setProperty("config",n);this.fireConfigChange({previousConfig:p,config:n});}};B.prototype.onBeforeConfigChange=function(o){return o;};B.prototype.getI18nProperty=function(n){if(this.getModel("i18n")){return this.getModel("i18n").getProperty(n);}return n;};B.prototype.getLabel=function(){var l=this.getAggregation("_label");if(!l){l=new L({text:"{config/label}",design:"Bold"});this.setAggregation("_label",l);}return l;};B.prototype.enhanceAccessibilityState=function(E,A){var p=this.getParent();if(p&&p.enhanceAccessibilityState){p.enhanceAccessibilityState(this,A);}return A;};B.prototype.getFocusDomRef=function(){var o=this.getContent();if(o&&o.isA("sap.ui.core.IFormContent")){return o.getFocusDomRef();}};B.prototype.getIdForLabel=function(){var o=this.getContent();if(o&&o.isA("sap.ui.core.IFormContent")){return o.getIdForLabel();}};return B;});

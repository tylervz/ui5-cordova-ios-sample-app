/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/library","sap/ui/core/library","sap/ui/dom/includeScript","sap/ui/integration/cards/BaseContent","sap/ui/integration/thirdparty/adaptivecards","sap/ui/integration/thirdparty/adaptivecards-templating","sap/ui/integration/thirdparty/markdown-it","sap/ui/integration/cards/adaptivecards/elements/UI5InputText","sap/ui/integration/cards/adaptivecards/elements/UI5InputNumber","sap/ui/integration/cards/adaptivecards/elements/UI5InputChoiceSet","sap/ui/integration/cards/adaptivecards/elements/UI5InputTime","sap/ui/integration/cards/adaptivecards/elements/UI5InputDate","sap/ui/integration/cards/adaptivecards/elements/UI5InputToggle","sap/ui/integration/cards/adaptivecards/overwrites/ActionRender","sap/ui/integration/cards/adaptivecards/elements/hostConfig","sap/m/VBox","sap/m/MessageStrip","sap/ui/core/HTML","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/base/Log"],function(l,c,i,B,A,a,M,U,b,d,e,f,g,h,H,V,j,k,C,J,L){"use strict";var m=c.MessageType;var n=B.extend("sap.ui.integration.cards.AdaptiveContent",{renderer:{apiVersion:2,render:function(r,o){var p=B.getMetadata().getRenderer();return p.render.apply(this,arguments);}}});n.prototype.init=function(){this.setComponentsReady(false);this._bAdaptiveCardElementsReady=false;this._setupCardContent();this._setupAdaptiveCardDependency();this._loadDependencies();};n.prototype._setupCardContent=function(){var o=new j(this.getId()+"-message",{showCloseButton:true,visible:false}),p=new k(this.getId()+"content",{preferDOM:false,content:"<div>&nbsp;</div>"});o.addStyleClass("sapUiTinyMargin");this.setAggregation("_content",new V({items:[o,p]}));};n.prototype.setConfiguration=function(o){this._oCardConfig=o;if(o&&o.request&&o.request.url){this._loadManifestFromUrl(o.request.url);return;}this._handleMarkDown();this._setupMSCardContent();};n.prototype.getConfiguration=function(){return this._oCardConfig;};n.prototype._handleMarkDown=function(){var t=this;A.AdaptiveCard.onProcessMarkdown=function(T,r){var o=t.getParent(),E=o&&o.getManifestEntry("/sap.card/configuration/enableMarkdown");if(E){r.outputHtml=new M().render(T);r.didProcess=true;return r;}};};n.prototype._loadManifestFromUrl=function(u){var D=new J(),t=this;D.loadData(u).then(function(){t._oCardConfig=Object.assign(t._oCardConfig,D.getData());}).then(function(){t._handleMarkDown();t._setupMSCardContent();}).then(function(){D.destroy();D=null;}).catch(function(){L.error("No JSON file found on this URL. Please provide a correct path to the JSON-serialized card object model file.");});};n.prototype.onAfterRendering=function(){this._setupMSCardContent();};n.prototype._setupAdaptiveCardDependency=function(){this.adaptiveCardInstance=new A.AdaptiveCard();this._doMSCardsOverwrites();this._adjustHostConfig();this._handleActions();this._replaceElements();this._isRtl();};n.prototype._doMSCardsOverwrites=function(){A.Action.prototype.render=h;};n.prototype._adjustHostConfig=function(){this.adaptiveCardInstance.hostConfig=new A.HostConfig(H);};n.prototype._isRtl=function(){this.adaptiveCardInstance.isRtl=function(){return C.getConfiguration().getRTL();};};n.prototype._handleActions=function(){this.adaptiveCardInstance.onExecuteAction=function(o){var t,p,q;if(o instanceof A.OpenUrlAction){p={url:o.url};t=l.CardActionType.Navigation;}else if(o instanceof A.SubmitAction){p=o.data;t=l.CardActionType.Submit;}else{return;}q=this.getActions();if(q){q.fireAction(this,t,p);}}.bind(this);};n.prototype.onActionSubmitStart=function(F){this.getParent().setBusy(true);};n.prototype.onActionSubmitEnd=function(r,E){var R=C.getLibraryResourceBundle("sap.ui.integration"),s=E?R.getText("CARDS_ADAPTIVE_ACTION_SUBMIT_ERROR"):R.getText("CARDS_ADAPTIVE_ACTION_SUBMIT_SUCCESS"),o=E?m.Error:m.Success,p=this.getAggregation("_content").getItems()[0];p.setType(o).setText(s).setVisible(true);this.getParent().setBusy(false);};n.prototype._replaceElements=function(){A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Text");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Text",function(){return new U();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Number");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Number",function(){return new b();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.ChoiceSet");A.AdaptiveCard.elementTypeRegistry.registerType("Input.ChoiceSet",function(){return new d();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Time");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Time",function(){return new e();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Date");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Date",function(){return new f();});A.AdaptiveCard.elementTypeRegistry.unregisterType("Input.Toggle");A.AdaptiveCard.elementTypeRegistry.registerType("Input.Toggle",function(){return new g();});};n.prototype._setupMSCardContent=function(){var D=this.getAggregation("_content").getItems()[1].getDomRef(),o=this._oCardConfig,p,q;if(!this.adaptiveCardInstance||!o||!D){return;}if(this._oDataProviderFactory&&this._oDataProviderFactory._aDataProviders&&this._oDataProviderFactory._aDataProviders.length){q=this._oDataProviderFactory._aDataProviders[0];}p=o.$data||o.data;if(!p&&!q){this._renderMSCardContent(o);return;}if(!p&&q){this._setupDataProvider(q);return;}if(o.$data){p={"json":p};}this._setupDataProvider(this._createDataProvider(p));};n.prototype._createDataProvider=function(D){var o=null;if(this._oDataProviderFactory){o=this._oDataProviderFactory.create(D,this._oServiceManager);}return o;};n.prototype._setupDataProvider=function(D){var o,p,P=D&&D._oSettings.path||"";if(D){this.setBusy(true);var q=this.setModel(new J());D.attachDataChanged(function(E){o=E.getParameter('data');this._updateModel(o);if(P.length){o=q.getProperty(P);}p=this._setTemplating(this._oCardConfig,o);p&&this._renderMSCardContent(p);this.setBusy(false);}.bind(this));D.attachError(function(E){this._handleError(E.getParameter("message"));this.setBusy(false);}.bind(this));D.triggerDataUpdate().then(function(){this.fireEvent("_dataReady");}.bind(this));}else{this.fireEvent("_dataReady");}};n.prototype._renderMSCardContent=function(o){var D=this.getAggregation("_content").getItems()[1].$();if(this.adaptiveCardInstance&&o&&D.length){this.adaptiveCardInstance.parse(o);D.html(this.adaptiveCardInstance.render());this._bAdaptiveCardElementsReady=true;this._fireCardReadyEvent();if(this.adaptiveCardInstance.renderedElement){this.adaptiveCardInstance.renderedElement.tabIndex=-1;}}};n.prototype._fireCardReadyEvent=function(){if(this._bAdaptiveCardElementsReady&&this.getComponentsReady()){this._bReady=true;this.fireEvent("_ready");}};n.prototype._setTemplating=function(t,D){var o=new a.Template(t),p=new a.EvaluationContext();p.$root=D;return o.expand(p);};n.prototype._loadDependencies=function(){if(this.getComponentsReady()){L.debug("WebComponents were already loaded");this._fireCardReadyEvent();return;}window.customElements.whenDefined("ui5-button").then(function(){if(!this.getComponentsReady()){this.setComponentsReady(true);this._fireCardReadyEvent();}}.bind(this));setTimeout(function(){if(this.getComponentsReady()){L.debug("WebComponents were already loaded");return;}i({id:"webcomponents-loader",url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/webcomponentsjs/webcomponents-loader.js")});}.bind(this));document.addEventListener("WebComponentsReady",function(){if(this.getComponentsReady()){L.debug("WebComponents were already loaded");return;}i({id:"webcomponents-bundle",attributes:{type:"module"},url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/bundle.esm.js")});i({id:"webcomponents-bundle-es5",attributes:{nomodule:"nomodule"},url:sap.ui.require.toUrl("sap/ui/integration/thirdparty/webcomponents/bundle.es5.js")});this.setComponentsReady(true);this._fireCardReadyEvent();}.bind(this));};n.prototype.setComponentsReady=function(v){this._bComponentsReady=v;return this;};n.prototype.getComponentsReady=function(){return!!this._bComponentsReady;};return n;});

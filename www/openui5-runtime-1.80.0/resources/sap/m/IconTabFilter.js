/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","sap/ui/core/library","sap/ui/core/Core","sap/ui/core/Item","sap/ui/core/Renderer","sap/ui/core/IconPool","sap/ui/core/InvisibleText","sap/ui/core/Control",'sap/ui/Device',"./AccButton","sap/m/Button","sap/m/ResponsivePopover","sap/m/IconTabBarSelectList"],function(l,c,C,I,R,a,b,d,D,A,B,e,f){"use strict";var T=c.TextAlign;var g=c.TextDirection;var h=l.ButtonType;var P=l.PlacementType;var j=l.ImageHelper;var k=l.IconTabFilterDesign;var m=c.IconColor;var n=I.extend("sap.m.IconTabFilter",{metadata:{interfaces:["sap.m.IconTab","sap.ui.core.PopupInterface"],library:"sap.m",designtime:"sap/m/designtime/IconTabFilter.designtime",properties:{count:{type:"string",group:"Data",defaultValue:''},showAll:{type:"boolean",group:"Misc",defaultValue:false},icon:{type:"sap.ui.core.URI",group:"Misc",defaultValue:''},iconColor:{type:"sap.ui.core.IconColor",group:"Appearance",defaultValue:m.Default},iconDensityAware:{type:"boolean",group:"Appearance",defaultValue:true},visible:{type:"boolean",group:"Behavior",defaultValue:true},design:{type:"sap.m.IconTabFilterDesign",group:"Appearance",defaultValue:k.Vertical}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"},items:{type:"sap.m.IconTab",multiple:true,singularName:"item"},_expandButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"}}}});var r=C.getLibraryResourceBundle("sap.m");n._aAllIconColors=['sapMITBFilterCritical','sapMITBFilterPositive','sapMITBFilterNegative','sapMITBFilterDefault','sapMITBFilterNeutral'];n.prototype._getImageControl=function(i,p,o){var q={src:this.getIcon(),densityAware:this.getIconDensityAware(),useIconTooltip:false};if(q.src){this._oImageControl=j.getImageControl(this.getId()+"-icon",this._oImageControl,p,q,i,o);}else if(this._oImageControl){this._oImageControl.destroy();this._oImageControl=null;}return this._oImageControl;};n.prototype.init=function(){this._oDragEventDelegate={onlongdragover:this._handleOnLongDragOver,ondragover:this._handleOnDragOver,ondragleave:this._handleOnDragLeave,ondrop:this._handleOnDrop};};n.prototype.exit=function(E){if(this._oImageControl){this._oImageControl.destroy();}if(I.prototype.exit){I.prototype.exit.call(this,E);}if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null;}if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}if(this._oExpandButton){this._oExpandButton.removeEventDelegate(this._oDragEventDelegate);this._oExpandButton.destroy();this._oExpandButton=null;}this.removeEventDelegate(this._oDragEventDelegate);this._oDragEventDelegate=null;};n.prototype.invalidate=function(){var i=this.getParent(),o,O;if(!i){return;}o=i.getParent();if(!(o instanceof sap.m.IconTabBar)){i.invalidate();return;}O=o.getParent();if(O instanceof sap.m.ObjectHeader){O.invalidate();}else{o.invalidate();}};n.prototype.setProperty=function(p,v,s){switch(p){case'enabled':case'textDirection':case'text':case'count':case'showAll':case'icon':case'iconColor':case'iconDensityAware':case'design':if(this.getProperty(p)===v){return this;}d.prototype.setProperty.call(this,p,v,true);if(!s){var i=this.getParent();if(i instanceof sap.m.IconTabHeader){i.invalidate();}}break;default:d.prototype.setProperty.apply(this,arguments);break;}return this;};n.prototype._getNonEmptyKey=function(){var K=this.getKey();if(K){return K;}return this.getId();};n.prototype._getRealTab=function(){return this._oRealItem||this;};n.prototype._getRootTab=function(){var t=this._getRealTab(),p=t.getParent();while(p&&p.isA("sap.m.IconTabFilter")){t=p;p=p.getParent();}return t;};n.prototype._getNestedLevel=function(){var p=this._getRealTab().getParent(),L;for(L=1;p&&p.isA("sap.m.IconTabFilter");L++){p=p.getParent();}return L;};n.prototype.render=function(o,v,V){if(!this.getVisible()){return;}this._prepareDragEventDelegate();var i=this.getParent(),p=i.getParent(),H=i._isInsideIconTabBar(),q={role:"tab"},s=this.getId(),t=this.getCount(),u=this.getText(),w=this.getIcon(),x=this.getIconColor(),S=x==='Positive'||x==='Critical'||x==='Negative'||x==='Neutral',y=this.getDesign()===k.Horizontal,z=i._bTextOnly,E=i._bInLine||i.isInlineMode();if(H){q.controls=p.getId()+"-content";}if(this.getItems().length){q.roledescription=r.getText("ICONTABFILTER_SPLIT_TAB");}if(u.length||t!==""||w){var F=[];if(t!==""){F.push(s+"-count");}if(u.length){F.push(s+"-text");}if(w){F.push(s+"-icon");}if(S){F.push(s+"-iconColor");}q.labelledby=F.join(" ");}if(v!==undefined&&V!==undefined){Object.assign(q,{posinset:v+1,setsize:V});}o.openStart("div",this).accessibilityState(q).class("sapMITBItem");if(!t){o.class("sapMITBItemNoCount");}if(y){o.class("sapMITBHorizontal");}else{o.class("sapMITBVertical");}if(this.getShowAll()){o.class("sapMITBAll");}else{o.class("sapMITBFilter").class("sapMITBFilter"+x);}if(i._isUnselectable(this)){o.class("sapMITHUnselectable");}if(this.getItems().length>0){o.class("sapMITBFilterWithItems");}if(!this.getEnabled()){o.class("sapMITBDisabled").attr("aria-disabled",true);}o.attr("aria-selected",false);var G=this.getTooltip_AsString();if(G){o.attr("title",G);}if(this._bIsOverflow||this.getItems().length){o.attr("aria-haspopup","menu");}o.openEnd();o.openStart("div").class("sapMITBFilterWrapper").openEnd();if(!E){o.openStart("div",s+"-tab").class("sapMITBTab").openEnd();if(!this.getShowAll()||!w){if(S){o.openStart("div",s+"-iconColor").style("display","none").openEnd().text(r.getText('ICONTABBAR_ICONCOLOR_'+x.toUpperCase())).close("div");}o.renderControl(this._getImageControl(['sapMITBFilterIcon','sapMITBFilter'+x],i,n._aAllIconColors));}if(!this.getShowAll()&&!w&&!z){o.openStart("span").class("sapMITBFilterNoIcon").openEnd().close("span");}if(y&&!this.getShowAll()){o.close("div");o.openStart("div").class("sapMITBHorizontalWrapper").openEnd();}o.openStart("span",s+"-count").class("sapMITBCount").openEnd();if(t===""&&y){o.unsafeHtml("&nbsp;");}else{o.text(t);}o.close("span");if(!y){o.close("div");}}if(u.length){o.openStart("div",s+"-text").class("sapMITBText");if(H&&p.getUpperCase()){o.class("sapMITBTextUpperCase");}if(E){o.attr("dir","ltr");}o.openEnd();o.openStart("span").class("sapMITHTextContent").openEnd().text(i._getDisplayText(this));o.close("span");if(this._bIsOverflow||this.getItems().length&&i._isUnselectable(this)){o.openStart("span",this.getId()+"-expandButton").class("sapMITHShowSubItemsIcon").openEnd();o.icon(a.getIconURI("slim-arrow-down"),[],{title:r.getText("ICONTABHEADER_OVERFLOW_MORE")});o.close("span");}o.close("div");}if(!E&&y){o.close("div");}o.openStart("div").class("sapMITBContentArrow").openEnd().close("div");o.close("div");if(this.getItems().length&&!i._isUnselectable(this)){o.openStart("span").accessibilityState({role:"separator"}).openEnd().close("span");o.renderControl(this._getExpandButton());}o.close("div");};n.prototype.renderInSelectList=function(o,s,i,S,p){if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null;}if(!this.getVisible()){return;}var t=true,q=s._bIconOnly,u=s._oIconTabHeader;if(u){t=u._bTextOnly;}o.openStart("li",this).class("sapMITBSelectItem").attr("tabindex","-1").attr("role","menuitem");if(p){o.style("padding-left",p+"rem");}if(i!==undefined&&S!==undefined){o.attr("aria-posinset",i+1);o.attr("aria-setsize",S);o.attr("aria-level",this._getNestedLevel());}var v=this.getTooltip_AsString();if(v){o.attr("title",v);}if(u._isUnselectable(this)){o.class("sapMITHUnselectable");}if(!this.getEnabled()){o.class("sapMITBDisabled").attr("aria-disabled",true);}if(s.getSelectedItem()==this){o.class("sapMITBSelectItemSelected");o.attr("aria-selected",true);}var w=this.getIconColor();o.class("sapMITBFilter"+w);var x=this.getId(),y=w=='Positive'||w=='Critical'||w=='Negative'||w=='Neutral',L=[];if(!q){L.push(x+"-text");}if(!t&&this.getIcon()){L.push(x+"-icon");}if(y){this._invisibleText=new b({text:r.getText('ICONTABBAR_ICONCOLOR_'+w.toUpperCase())});L.push(this._invisibleText.getId());}o.accessibilityState({labelledby:L.join(" ")}).openEnd();if(this._invisibleText){o.renderControl(this._invisibleText);}if(!t){this._renderIcon(o);}if(!q){this._renderText(o);}o.close("li");};n.prototype._renderIcon=function(o){var i=this.getIcon();if(i){var p=a.getIconInfo(i),q=["sapMITBSelectItemIcon"];if(p&&!p.suppressMirroring){q.push("sapUiIconMirrorInRTL");}o.icon(i,q,{id:this.getId()+"-icon","aria-hidden":true});}else{o.openStart("span").class("sapUiIcon").openEnd().close("span");}};n.prototype._renderText=function(o){var t=this.getText(),s=this.getCount(),i=C.getConfiguration().getRTL(),p=this.getTextDirection();o.openStart("span",this.getId()+"-text").attr("dir","ltr").class("sapMText").class("sapMTextNoWrap").class("sapMITBText");if(p!==g.Inherit){o.attr('dir',p.toLowerCase());}var q=R.getTextAlign(T.Begin,p);if(q){o.style("text-align",q);}if(s){if(i){t='('+s+') '+t;}else{t+=' ('+s+')';}}o.openEnd().text(t).close("span");};n.prototype._getSelectList=function(){if(!this._oSelectList){this._oSelectList=new f({selectionChange:function(E){var t=E.getParameter("selectedItem");this._oIconTabHeader.setSelectedItem(t._getRealTab());this._oTabFilter._closePopover();}});this._oSelectList._oIconTabHeader=this.getParent();this._oSelectList._oTabFilter=this;}return this._oSelectList;};n.prototype._prepareDragEventDelegate=function(){if(this.getEnabled()){this.addEventDelegate(this._oDragEventDelegate,this);}else{this.removeEventDelegate(this._oDragEventDelegate);}};n.prototype._getExpandButton=function(){this._oExpandButton=this.getAggregation("_expandButton");if(!this._oExpandButton){this._oExpandButton=new A(this.getId()+"-expandButton",{type:h.Transparent,icon:a.getIconURI("slim-arrow-down"),tooltip:r.getText("ICONTABHEADER_OVERFLOW_MORE"),tabIndex:"-1",press:this._expandButtonPress.bind(this)}).addStyleClass("sapMITBFilterExpandBtn");this.setAggregation("_expandButton",this._oExpandButton);}return this._oExpandButton;};n.prototype._expandButtonPress=function(){if(!this.getEnabled()){return;}this.$().trigger("focus");if(!this._oPopover){this._oPopover=new e({showArrow:false,showHeader:false,offsetY:0,offsetX:0,placement:P.VerticalPreferredBottom}).addStyleClass("sapMITBFilterPopover");this._oPopover.attachBeforeClose(function(){this._getSelectList().destroyItems();},this);if(D.system.phone){this._oPopover._oControl.addButton(this._createPopoverCloseButton());}this.addDependent(this._oPopover);this._oPopover._oControl._adaptPositionParams=function(){var i=this.$().parents().hasClass("sapUiSizeCompact");this._arrowOffset=0;if(i){this._offsets=["0 0","0 0","0 4","0 0"];}else{this._offsets=["0 0","0 0","0 5","0 0"];}this._atPositions=["end top","end top","end bottom","begin top"];this._myPositions=["end bottom","begin top","end top","end top"];};}var H=this._setSelectListItems();var s=this._getSelectList();this._oPopover.removeAllContent();if(this.getItems().length||this._bIsOverflow){this._oPopover.addContent(s);this._oPopover.setInitialFocus(H?s.getSelectedItem():s.getVisibleTabFilters()[0]);this._oPopover.openBy(this);}};n.prototype._getAllSubItems=function(){var i=[];this._getRealTab().getItems().forEach(function(o){if(o.isA("sap.m.IconTabFilter")){i=i.concat(o,o._getAllSubItems());}else{i=i.concat(o);}});return i;};n.prototype._getAllSubFilters=function(){return this._getAllSubItems().filter(function(i){return i.isA("sap.m.IconTabFilter");});};n.prototype._getAllSubFiltersDomRefs=function(){return this._getAllSubFilters().filter(function(s){return Boolean(s._getRealTab().getDomRef());}).map(function(s){return s._getRealTab().getDomRef();});};n.prototype._getFirstAvailableSubFilter=function(){var o=this._getAllSubFilters();for(var i=0;i<o.length;i++){var p=o[i];if(p.getContent().length&&p.getVisible()){return p;}}return this;};n.prototype._isParentOf=function(o){var p=this._getAllSubFilters();for(var i=0;i<p.length;i++){if(p[i]._getRealTab()===o){return true;}}return false;};n.prototype._createPopoverCloseButton=function(){return new B({text:r.getText("SELECT_CANCEL_BUTTON"),press:this._closePopover.bind(this)});};n.prototype._closePopover=function(){if(this._oPopover){this._oPopover.close();this._oPopover.removeAllContent();}if(this._bIsOverflow&&this.getParent().oSelectedItem){(this.getParent()._oSelectedRootItem||this.getParent().oSelectedItem).$().focus();}};n.prototype._handleOnDragOver=function(E){if(!this._bIsOverflow&&!this._getIconTabHeader().getMaxNestingLevel()){return;}this.getDomRef().classList.add("sapMITHDragOver");E.preventDefault();};n.prototype._handleOnLongDragOver=function(){if(!this._bIsOverflow&&!this._getIconTabHeader().getMaxNestingLevel()){return;}if(this._oPopover&&this._oPopover.isOpen()){return;}this._expandButtonPress();};n.prototype._handleOnDrop=function(){this.getDomRef().classList.remove("sapMITHDragOver");};n.prototype._handleOnDragLeave=function(){this.getDomRef().classList.remove("sapMITHDragOver");};n.prototype._setSelectListItems=function(){var o=this.getParent(),s=this._getSelectList(),p=this._getAllSubItems(),q=o.oSelectedItem,H=false,t;if(this._bIsOverflow){var u=o.getItems();var v=o._getItemsInStrip();p=[];u.forEach(function(t){if(!D.system.phone&&v.indexOf(t)>-1){return;}p.push(t);if(t.isA("sap.m.IconTabFilter")){t._getAllSubItems().forEach(function(S){p.push(S);});}});}s.destroyItems();s.setSelectedItem(null);for(var i=0;i<p.length;i++){t=p[i];var L=t.clone(undefined,undefined,{cloneChildren:false,cloneBindings:true});L._oRealItem=t;s.addItem(L);if(t.isA("sap.m.IconTabSeparator")){continue;}if(L._getRealTab()===q){s.setSelectedItem(L);H=true;continue;}if(L._getRealTab()._isParentOf(q)){s.setSelectedItem(q._getRealTab());H=true;}}return H;};n.prototype._getIconTabHeader=function(){return this._getRootTab().getParent();};n.prototype.onsapdown=function(E){if(!this.getEnabled()){return;}if(this._bIsOverflow||((this._getNestedLevel()===1&&this._getRealTab()===this)&&this._getRealTab().getItems().length!==0)){E.stopImmediatePropagation();this._expandButtonPress();}};return n;});

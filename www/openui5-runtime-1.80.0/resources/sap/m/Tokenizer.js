/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['./library','sap/ui/core/Control','sap/ui/core/delegate/ScrollEnablement','sap/ui/Device','sap/ui/core/InvisibleText','sap/ui/core/ResizeHandler','./TokenizerRenderer',"sap/ui/dom/containsOrEquals","sap/ui/events/KeyCodes","sap/base/Log","sap/ui/core/EnabledPropagator","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/control"],function(l,C,S,D,I,R,T,c,K,L,E,q){"use strict";var a=l.TokenizerRenderMode;var b=C.extend("sap.m.Tokenizer",{metadata:{library:"sap.m",properties:{editable:{type:"boolean",group:"Misc",defaultValue:true},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},maxWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%"},renderMode:{type:"string",group:"Misc",defaultValue:a.Loose},hiddenTokensCount:{type:"int",group:"Misc",defaultValue:0,visibility:"hidden"}},defaultAggregation:"tokens",aggregations:{tokens:{type:"sap.m.Token",multiple:true,singularName:"token"},_tokensInfo:{type:"sap.ui.core.InvisibleText",multiple:false,visibility:"hidden"}},associations:{ariaDescribedBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaDescribedBy"},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{tokenChange:{parameters:{type:{type:"string"},token:{type:"sap.m.Token"},tokens:{type:"sap.m.Token[]"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}},tokenUpdate:{allowPreventDefault:true,parameters:{type:{type:"string"},addedTokens:{type:"sap.m.Token[]"},removedTokens:{type:"sap.m.Token[]"}}}}}});var r=sap.ui.getCore().getLibraryResourceBundle("sap.m");E.apply(b.prototype,[true]);b.prototype.init=function(){this.allowTextSelection(false);this._oTokensWidthMap={};this._oIndicator=null;this._aTokenValidators=[];this._oScroller=new S(this,this.getId()+"-scrollContainer",{horizontal:true,vertical:false,nonTouchScrolling:true});if(sap.ui.getCore().getConfiguration().getAccessibility()){var A=new I({text:r.getText("TOKENIZER_ARIA_CONTAIN_TOKEN")});this.setAggregation("_tokensInfo",A);}};b.prototype._handleNMoreIndicatorPress=function(f){this._fnOnNMorePress=f;};b.prototype._getPixelWidth=function(){var m=this.getMaxWidth(),t,d=this.getDomRef(),p;if(!d){return;}p=parseInt(this.$().css("padding-left"));if(m.indexOf("px")===-1){t=d.clientWidth;}else{t=parseInt(this.getMaxWidth());}return t-p;};b.prototype._adjustTokensVisibility=function(){if(!this.getDomRef()){return;}var t=this._getPixelWidth(),d=this._getVisibleTokens().reverse(),i=d.length,e,f,g,F=-1;d.some(function(o,h){t=t-this._oTokensWidthMap[o.getId()];if(t<0){F=h;return true;}else{f=t;}},this);if(i===1&&F!==-1){this.setFirstTokenTruncated(true);return;}else if(i===1&&d[0].getTruncated()){this.setFirstTokenTruncated(false);}if(F>-1){for(g=0;g<i;g++){if(g>=F){d[g].addStyleClass("sapMHiddenToken");}else{d[g].removeStyleClass("sapMHiddenToken");}}this._handleNMoreIndicator(i-F);e=this._oIndicator.width();if(e>=f){F=F-1;this._handleNMoreIndicator(i-F);d[F].addStyleClass("sapMHiddenToken");}this._setHiddenTokensCount(i-F);}else{this._setHiddenTokensCount(0);this._showAllTokens();}};b.prototype.setFirstTokenTruncated=function(v){var t=this.getTokens()[0];t&&t.setTruncated(v);if(v){this.addStyleClass("sapMTokenizerOneLongToken");}else{this.removeStyleClass("sapMTokenizerOneLongToken");this.scrollToEnd();}return this;};b.prototype.hasOneTruncatedToken=function(){return this.getTokens().length===1&&this.getTokens()[0].getTruncated();};b.prototype._handleNMoreIndicator=function(h){if(!this.getDomRef()){return this;}if(h){var s="MULTIINPUT_SHOW_MORE_TOKENS";if(h===this._getVisibleTokens().length){if(h===1){s="TOKENIZER_SHOW_ALL_ITEM";}else{s="TOKENIZER_SHOW_ALL_ITEMS";}}this._oIndicator.html(r.getText(s,h));}return this;};b.prototype._getVisibleTokens=function(){return this.getTokens().filter(function(t){return t.getVisible();});};b.prototype._showAllTokens=function(){this._getVisibleTokens().forEach(function(t){t.removeStyleClass("sapMHiddenToken");});};b.prototype.getScrollDelegate=function(){return this._oScroller;};b.prototype.scrollToEnd=function(){var d=this.getDomRef(),s;if(!this.getDomRef()){return;}s=this.$().find(".sapMTokenizerScrollContainer")[0];if(D.browser.msie){setTimeout(function(){d.scrollLeft=s.scrollWidth;});}else{d.scrollLeft=s.scrollWidth;}};b.prototype._registerResizeHandler=function(){if(!this._sResizeHandlerId){this._sResizeHandlerId=R.register(this.getDomRef(),this._handleResize.bind(this));}};b.prototype._handleResize=function(){this._useCollapsedMode(this.getRenderMode());};b.prototype.setPixelWidth=function(n){if(typeof n!=="number"){L.warning("Tokenizer.setPixelWidth called with invalid parameter. Expected parameter of type number.");return;}this.setWidth(n+"px");if(this._oScroller){this._oScroller.refresh();}};b.prototype.scrollToStart=function(){var d=this.getDomRef();if(!d){return;}d.scrollLeft=0;};b.prototype.getScrollWidth=function(){if(!this.getDomRef()){return 0;}return this.$().children(".sapMTokenizerScrollContainer")[0].scrollWidth;};b.prototype.onBeforeRendering=function(){this._setTokensAria();};b.prototype.onAfterRendering=function(){var s=this.getRenderMode();this._oIndicator=this.$().find(".sapMTokenizerIndicator");this._updateTokensAriaSetAttributes();this._useCollapsedMode(s);this._registerResizeHandler();if(s===a.Loose){this.scrollToEnd();}};b.prototype.onThemeChanged=function(){this.getTokens().forEach(function(t){if(t.getDomRef()&&!t.$().hasClass("sapMHiddenToken")&&!t.getTruncated()){this._oTokensWidthMap[t.getId()]=t.$().outerWidth(true);}}.bind(this));this._useCollapsedMode(this.getRenderMode());};b.prototype._useCollapsedMode=function(s){var t=this._getVisibleTokens();if(!t.length){return;}if(s===a.Narrow){this._adjustTokensVisibility();}else{this._setHiddenTokensCount(0);this._showAllTokens();}};b.prototype.onsapfocusleave=function(e){if(document.activeElement===this.getDomRef()||!this._checkFocus()){this._changeAllTokensSelection(false);this._oSelectionOrigin=null;}};b.prototype.onkeydown=function(e){var s;if(!this.getEnabled()){return;}if(e.which===K.TAB){this._changeAllTokensSelection(false);}if((e.ctrlKey||e.metaKey)&&e.which===K.A){s=this.getSelectedTokens().length<this._getVisibleTokens().length;if(this._getVisibleTokens().length>0){this.focus();this._changeAllTokensSelection(s);e.preventDefault();e.stopPropagation();}}if((e.ctrlKey||e.metaKey)&&(e.which===K.C||e.which===K.INSERT)){this._copy();}if(((e.ctrlKey||e.metaKey)&&e.which===K.X)||(e.shiftKey&&e.which===K.DELETE)){if(this.getEditable()){this._cut();}else{this._copy();}}};b.prototype.onsappreviousmodifiers=function(e){this.onsapprevious(e);};b.prototype.onsapnextmodifiers=function(e){this.onsapnext(e);};b.prototype.onsaphomemodifiers=function(e){this._selectRange(false);};b.prototype.onsapendmodifiers=function(e){this._selectRange(true);};b.prototype._selectRange=function(f){var o={},t=this._getVisibleTokens(),F=q(document.activeElement).control()[0],d=t.indexOf(F);if(!F||!F.isA("sap.m.Token")){return;}if(f){o.start=d;o.end=t.length-1;}else{o.start=0;o.end=d;}if(o.start<o.end){for(var i=o.start;i<=o.end;i++){t[i].setSelected(true);}}};b.prototype._copy=function(){var s=this.getSelectedTokens(),d="",t,e=function(o){if(o.clipboardData){o.clipboardData.setData('text/plain',d);}else{o.originalEvent.clipboardData.setData('text/plain',d);}o.preventDefault();};for(var i=0;i<s.length;i++){t=s[i];d+=(i>0?"\r\n":"")+t.getText();}if(!d){return;}if(D.browser.msie&&window.clipboardData){window.clipboardData.setData("text",d);}else{document.addEventListener('copy',e);document.execCommand('copy');document.removeEventListener('copy',e);}};b.prototype._cut=function(){var s=this,d=s.getSelectedTokens(),e="",f=[],g,t,h=function(o){if(o.clipboardData){o.clipboardData.setData('text/plain',e);}else{o.originalEvent.clipboardData.setData('text/plain',e);}o.preventDefault();};g=s.fireTokenUpdate({addedTokens:[],removedTokens:f,type:b.TokenUpdateType.Removed});for(var i=0;i<d.length;i++){t=d[i];e+=(i>0?"\r\n":"")+t.getText();if(g&&t.getEditable()){s.removeToken(t);f.push(t);t.destroy();}}if(!e){return;}if(D.browser.msie&&window.clipboardData){window.clipboardData.setData("text",e);}else{document.addEventListener('cut',h);document.execCommand('cut');document.removeEventListener('cut',h);}};b.prototype.onsapbackspace=function(e){var s=this.getSelectedTokens();if(!this.getEnabled()){return;}if(s.length<2){e.preventDefault();this.onsapprevious(e);}else{this._focusUnselectedToken(e);}this._handleKeyboardDelete(e);e.setMarked();};b.prototype._focusUnselectedToken=function(e){var s=this.getSelectedTokens(),t=this._getVisibleTokens(),i,o;if(e.keyCode===K.DELETE){i=t.indexOf(s[s.length-1]);o=t[i+1];}if(e.keyCode===K.BACKSPACE){i=t.indexOf(s[0]);o=t[i-1];}if(o){o.focus();}else{e.setMarked("forwardFocusToParent");this.focus();}};b.prototype.onsapdelete=function(e){var s;if(!this.getEnabled()){return;}s=this.getSelectedTokens();if(s.length<2){this.onsapnext(e);}else{this._focusUnselectedToken(e);}this._handleKeyboardDelete(e);e.setMarked();};b.prototype._handleKeyboardDelete=function(e){var t;if(this.getEditable()){t=q(e.target).control()[0];if(t&&t.isA("sap.m.Token")){this.handleTokenDeletion(t);}this._removeSelectedTokens();if(!this._getVisibleTokens().length){e.setMarked("forwardFocusToParent");}}};b.prototype._ensureTokenVisible=function(t){if(!t||!t.getDomRef()||!this.getDomRef()){return;}var i=this.$().offset().left,d=this.$().width(),e=t.$().offset().left,f=t.$().width();if(this._getVisibleTokens().indexOf(t)===0){this.$().scrollLeft(0);return;}if(e<i){this.$().scrollLeft(this.$().scrollLeft()-i+e);}if(e-i+f>d){this.$().scrollLeft(this.$().scrollLeft()+(e-i+f-d));}};b.prototype.ontap=function(e){var s=e.shiftKey,d=(e.ctrlKey||e.metaKey),t=e.getMark("tokenTap"),f=e.getMark("tokenDeletePress"),g=this._getVisibleTokens(),F,h,j,m,M;if(f||!t||(!s&&d)){this._oSelectionOrigin=null;return;}if(!s){this._oSelectionOrigin=t;this._changeAllTokensSelection(false,t,true);}F=t;if(this._oSelectionOrigin){F=this._oSelectionOrigin;}else{this._oSelectionOrigin=F;}h=this.indexOfToken(F);j=this.indexOfToken(t);m=Math.min(h,j);M=Math.max(h,j);g.forEach(function(o,i){if(i>=m&&i<=M){o.setSelected(true);}else if(!d){o.setSelected(false);}});};b.prototype.onsapprevious=function(e){var t=this._getVisibleTokens(),i=t.length;if(i===0){return;}var f=q(document.activeElement).control()[0];var d=f?t.indexOf(f):-1;if(d===0){e.setMarked("forwardFocusToParent");return;}var g,h;if(d>0){g=t[d-1];g.focus();}else{g=t[t.length-1];g.focus();}if(e.shiftKey){h=t[d];g.setSelected(true);h.setSelected(true);}e.setMarked();e.preventDefault();};b.prototype.onsapnext=function(e){var t=this._getVisibleTokens(),i=t.length;if(i===0){return;}var f=q(document.activeElement).control()[0];var d=f?t.indexOf(f):-1;if(d<i-1){var n=t[d+1],g=t[d];n.focus();if(e.shiftKey){n.setSelected(true);g.setSelected(true);}this._ensureTokenVisible(n);}else{e.setMarked("forwardFocusToParent");return;}e.setMarked();e.preventDefault();};b.prototype.addValidator=function(v){if(typeof(v)==="function"){this._aTokenValidators.push(v);}};b.prototype.removeValidator=function(v){var i=this._aTokenValidators.indexOf(v);if(i!==-1){this._aTokenValidators.splice(i,1);}};b.prototype.removeAllValidators=function(){this._aTokenValidators=[];};b.prototype._validateToken=function(p,v){var t=p.token;var s;if(t&&t.getText()){s=t.getText();}else{s=p.text;}var V=p.validationCallback;var o=p.suggestionObject;var i,d,e;if(!v){v=this._aTokenValidators;}e=v.length;if(e===0){if(!t&&V){V(false);}return t;}for(i=0;i<e;i++){d=v[i];t=d({text:s,suggestedToken:t,suggestionObject:o,asyncCallback:this._getAsyncValidationCallback(v,i,s,o,V)});if(!t){if(V){V(false);}return null;}if(t===b.WaitForAsyncValidation){return null;}}return t;};b.prototype._getAsyncValidationCallback=function(v,V,i,s,f){var t=this,A;return function(o){if(o){v=v.slice(V+1);o=t._validateToken({text:i,token:o,suggestionObject:s,validationCallback:f},v);A=t._addUniqueToken(o,f);if(A){t.fireTokenUpdate({addedTokens:[o],removedTokens:[],type:b.TokenUpdateType.Added});}}else{if(f){f(false);}}};};b.prototype.addValidateToken=function(p){var t=this._validateToken(p);this._addUniqueToken(t,p.validationCallback);};b.prototype._addValidateToken=function(p){var t=this._validateToken(p),A=this._addUniqueToken(t,p.validationCallback);if(A){this.fireTokenUpdate({addedTokens:[t],removedTokens:[],type:b.TokenUpdateType.Added});}};b.prototype._addUniqueToken=function(t,v){if(!t){return false;}var d=this._tokenExists(t);if(d){var p=this.getParent();if(p instanceof sap.m.MultiInput&&v){v(false);}return false;}this.addToken(t);if(v){v(true);}this.fireTokenChange({addedTokens:[t],removedTokens:[],type:b.TokenChangeType.TokensChanged});return true;};b.prototype._parseString=function(s){return s.split(/\r\n|\r|\n/g);};b.prototype._checkFocus=function(){return this.getDomRef()&&c(this.getDomRef(),document.activeElement);};b.prototype._tokenExists=function(t){var d=this.getTokens();if(!(d&&d.length)){return false;}var k=t.getKey();if(!k){return false;}var e=d.length;for(var i=0;i<e;i++){var f=d[i];var g=f.getKey();if(g===k){return true;}}return false;};b.prototype.addToken=function(t,s){var p=this.getParent();t.setProperty("editableParent",this.getEditable());if(p instanceof sap.m.MultiInput){if(p.getMaxTokens()!==undefined&&p.getTokens().length>=p.getMaxTokens()){return this;}}this.addAggregation("tokens",t,s);this.fireTokenChange({token:t,type:b.TokenChangeType.Added});t.addEventDelegate({onAfterRendering:function(){if(sap.ui.getCore().isThemeApplied()&&t.getDomRef()&&!t.getTruncated()&&!t.$().hasClass("sapMHiddenToken")){this._oTokensWidthMap[t.getId()]=t.$().outerWidth(true);}}.bind(this)});t.getAggregation("deleteIcon").attachPress(function(){if(this.getEnabled()){this.handleTokenDeletion(t);}}.bind(this));return this;};b.prototype.removeToken=function(t){t=this.removeAggregation("tokens",t);this._updateTokensAriaSetAttributes();!this.getTokens().length&&this.setFirstTokenTruncated(false);this.fireTokenChange({token:t,type:b.TokenChangeType.Removed});return t;};b.prototype.setTokens=function(t){var o=this.getTokens();this.removeAllTokens(false);var i;for(i=0;i<t.length;i++){this.addToken(t[i],true);}this.invalidate();this.fireTokenChange({addedTokens:t,removedTokens:o,type:b.TokenChangeType.TokensChanged});};b.prototype.removeAllTokens=function(f){var t=this.getTokens();var d=this.removeAllAggregation("tokens");this.setFirstTokenTruncated(false);if(typeof(f)==="boolean"&&!f){return d;}this.fireTokenChange({addedTokens:[],removedTokens:t,type:b.TokenChangeType.TokensChanged});this.fireTokenChange({tokens:t,type:b.TokenChangeType.RemovedAll});return d;};b.prototype.updateTokens=function(){this.destroyTokens();this.updateAggregation("tokens");this.setFirstTokenTruncated(false);};b.prototype._removeSelectedTokens=function(){var t=this.getSelectedTokens();if(t.length===0){return this;}this.handleTokenDeletion(t);this._doSelect();return this;};b.prototype.handleTokenDeletion=function(t){var e,i,o,d=[];d=d.concat(t);e=this.fireTokenUpdate({addedTokens:[],removedTokens:d,type:b.TokenUpdateType.Removed});if(!e){return;}for(i=0;i<d.length;i++){o=d[i];if(o.getEditable()){o.destroy();}}this.scrollToEnd();this.fireTokenChange({addedTokens:[],removedTokens:d,type:b.TokenChangeType.TokensChanged});};b.prototype.selectAllTokens=function(s){if(s===undefined){s=true;}this._changeAllTokensSelection(s);return this;};b.prototype._changeAllTokensSelection=function(s,t,d){var e=this._getVisibleTokens();e.filter(function(o){return o!==t;}).forEach(function(o){o.setSelected(s);});if(!d){this._doSelect();}return this;};b.prototype.getSelectedTokens=function(){return this._getVisibleTokens().filter(function(t){return t.getSelected();});};b.prototype.onsaphome=function(e){var A=this.getTokens().filter(function(t){return t.getDomRef()&&!t.getDomRef().classList.contains("sapMHiddenToken");});A.length&&A[0].focus();this.scrollToStart();e.preventDefault();};b.prototype.onsapend=function(e){var t=this._getVisibleTokens(),o=t[t.length-1];if(o.getDomRef()!==document.activeElement){o.focus();this.scrollToEnd();e.stopPropagation();}else{e.setMarked("forwardFocusToParent");}e.preventDefault();};b.prototype.onclick=function(e){var f;if(!this.getEnabled()){return;}f=e.target.classList.contains("sapMTokenizerIndicator")||e.target===this.getFocusDomRef()||this.hasOneTruncatedToken();if(f){this._fnOnNMorePress&&this._fnOnNMorePress(e);}};b.prototype.ontouchstart=function(e){e.setMarked();if(D.browser.chrome&&window.getSelection()){window.getSelection().removeAllRanges();}};b.prototype.exit=function(){this._deregisterResizeHandler();};b.prototype._deregisterResizeHandler=function(){if(this._sResizeHandlerId){R.deregister(this._sResizeHandlerId);delete this._sResizeHandlerId;}};b.prototype._setTokensAria=function(){var t=this._getVisibleTokens().length,i,s="";if(sap.ui.getCore().getConfiguration().getAccessibility()){i=this.getAggregation("_tokensInfo");switch(t){case 0:s=r.getText("TOKENIZER_ARIA_CONTAIN_TOKEN");break;case 1:s=r.getText("TOKENIZER_ARIA_CONTAIN_ONE_TOKEN");break;default:s=r.getText("TOKENIZER_ARIA_CONTAIN_SEVERAL_TOKENS",t);break;}i.setText(s);}};b.prototype._updateTokensAriaSetAttributes=function(){var t=this.getTokens(),d=t.length;for(var i=0;i<d;i++){var o=t[i].getDomRef();if(o){o.setAttribute("aria-posinset",i+1);o.setAttribute("aria-setsize",d);}}};b.prototype._doSelect=function(){if(this._checkFocus()&&this._bCopyToClipboardSupport){var f=document.activeElement;var s=window.getSelection();s.removeAllRanges();if(this.getSelectedTokens().length){var o=document.createRange();o.selectNodeContents(this.getDomRef("clip"));s.addRange(o);}if(window.clipboardData&&f.id===this.getId()+"-clip"&&this.getDomRef()){this.getDomRef().focus();}}};b.prototype.setEditable=function(e){var t=this.getTokens();t.forEach(function(o){o.setProperty("editableParent",e);});this.setProperty("editable",e);return this;};b.prototype._setHiddenTokensCount=function(i){i=this.validateProperty("hiddenTokensCount",i);return this.setProperty("hiddenTokensCount",i);};b.prototype.getHiddenTokensCount=function(){return this.getProperty("hiddenTokensCount");};b.prototype.getTokensInfoId=function(){return this.getAggregation("_tokensInfo").getId();};b.TokenChangeType={Added:"added",Removed:"removed",RemovedAll:"removedAll",TokensChanged:"tokensChanged"};b.TokenUpdateType={Added:"added",Removed:"removed"};b.WaitForAsyncValidation="sap.m.Tokenizer.WaitForAsyncValidation";return b;});
